---
date : 2025-08-04
tags: ['2025-08']
categories: ['SW']
bookHidden: true
title: "Docker #5 3ì¼ì°¨ ì‹¤ìŠµ: kubernetes í™˜ê²½ì— ë‚˜ì˜ ì•±ì„ ë°°í¬í•´ë³´ì"
---

# Docker #5 3ì¼ì°¨ ì‹¤ìŠµ: kubernetes í™˜ê²½ì— ë‚˜ì˜ ì•±ì„ ë°°í¬í•´ë³´ì

#2025-08-04

---

### 0. ì‘ì—… ì •ë³´

#1 ì‘ì—… ìœ„ì¹˜

```shell
$ pwd
/Users/yshmbid/rde/config/workspace/exec-template
```

#2 íŒŒì¼ êµ¬ì¡°

```plain text
/workspace
â””â”€â”€ exec-template
     â”œâ”€â”€ Dockerfile
     â”œâ”€â”€ default.conf
     â”œâ”€â”€ docker-build.sh
     â”œâ”€â”€ docker-push.sh
     â”œâ”€â”€ cicd.sh 
     â”œâ”€â”€ deploy/
     â”‚   â”œâ”€â”€ deploy.t   
     â”‚   â”œâ”€â”€ deploy.sh     
     â”‚   â”œâ”€â”€ service.t
     â”‚   â”œâ”€â”€ service.sh 
     â”‚   â””â”€â”€ env.properties
     â””â”€â”€ src/
         â”œâ”€â”€ index.html      
         â””â”€â”€ media/ 
```

#3 ì´ì „ ì‹¤ìŠµê³¼ì˜ ì°¨ì´ 

1. cicd.shë¥¼ ì“´ë‹¤.
2. deploy ë””ë ‰í† ë¦¬ë¥¼ ì“´ë‹¤. 
3. docker-build.shì™€ docker-push.shì—ì„œ amdì˜€ë˜ê±¸ armìœ¼ë¡œ ë°”ê¿”ì¤¬ëŠ”ë° ì´ê±¸ë‹¤ì‹œ amdë¡œ ë°”ê¿”ì¤€ë‹¤.

### 1. cicd.sh ì‘ì„±

```shell
#!/bin/bash

# ê¸°ë³¸ê°’ ì„¤ì •
ENV_FILE="env.properties"

# usage ì¶œë ¥ í•¨ìˆ˜
usage() {
  echo "Usage: $0 [-b|--build] [-p|--push] [-y|--yaml] [-d|--deploy] [-r|--remove] [-a|--all] [-f|--file <env file>]"
  exit 1
}

# env.properties ë¡œë“œ í•¨ìˆ˜
load_env() {
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
  else
    echo "í™˜ê²½ íŒŒì¼ '$ENV_FILE'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi
}

# Maven Build
build() {
  echo "ğŸ”¨ Maven ë¹Œë“œ ì‹œì‘..."
  mvn clean package
}

# Docker ì´ë¯¸ì§€ build & push
push_image() {
  echo "ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± ë° push ì‹œì‘..."
  docker build -t $DOCKER_IMAGE_NAME .
  docker push $DOCKER_IMAGE_NAME
}

# YAML ìƒì„±
generate_yaml() {
  echo "ğŸ“„ YAML íŒŒì¼ ìƒì„± ì¤‘..."
  for file in *.t; do
    [ -e "$file" ] || continue
    cp "$file" "${file%.t}.yaml"
  done
}

# K8sì— ë°°í¬
deploy_k8s() {
  echo "ğŸš€ Kubernetesì— ë°°í¬ ì‹œì‘..."
  kubectl apply -f ./*.yaml
}

# K8s ë¦¬ì†ŒìŠ¤ ì‚­ì œ
remove_k8s() {
  echo "ğŸ—‘ï¸ Kubernetes ë¦¬ì†ŒìŠ¤ ì œê±°..."
  kubectl delete -f ./*.yaml
}

# ì „ì²´ ì‹¤í–‰
run_all() {
  load_env
  build
  push_image
  generate_yaml
  deploy_k8s
}

# ì¸ì íŒŒì‹±
while [[ "$#" -gt 0 ]]; do
  case "$1" in
    -b|--build) ACTION_BUILD=1 ;;
    -p|--push) ACTION_PUSH=1 ;;
    -y|--yaml) ACTION_YAML=1 ;;
    -d|--deploy) ACTION_DEPLOY=1 ;;
    -r|--remove) ACTION_REMOVE=1 ;;
    -a|--all) ACTION_ALL=1 ;;
    -f|--file)
      shift
      ENV_FILE="$1"
      ;;
    -h|--help)
      usage
      ;;
    *)
      echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
      usage
      ;;
  esac
  shift
done

# ì‹¤í–‰ ì¡°ê±´
if [[ $ACTION_ALL ]]; then
  run_all
else
  load_env
  [[ $ACTION_BUILD ]] && build
  [[ $ACTION_PUSH ]] && push_image
  [[ $ACTION_YAML ]] && generate_yaml
  [[ $ACTION_DEPLOY ]] && deploy_k8s
  [[ $ACTION_REMOVE ]] && remove_k8s
fi
```

cicd.sh ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì´ ë‚˜ì˜¤ëŠ”ë° pptë‘ workspace ë””ë ‰í† ë¦¬ ì•ˆì— ì•„ë¬´ë¦¬ì°¾ì•„ë´ë„ ì—†ì–´ì„œ... ì¼ë‹¨ ì±—ì§€í”¼í‹°ì—ë„£ê³  ë§Œë“¤ì—ˆëŠ”ë°

ë§‰ìƒ ë’¤ì—ì„œëŠ” cicd.sh ì“°ëŠ”ëŒ€ì‹  ê·¸ìë¦¬ì— `kubectl apply -f deploy.yaml`
`kubectl apply -f service.yaml` ì„ í•´ì¤¬ë‹¤.

### 2. deploy ë””ë ‰í† ë¦¬

deploy ë””ë ‰í† ë¦¬ì˜ deploy.tì™€ service.tëŠ” ê°ê° .shë¡œ ë°”ê¿”ì¤€ë‹¤.

```shell
# deploy.sh

apiVersion: apps/v1
kind: Deployment
metadata:
  name: sk019-posts-get
  namespace: skala-practice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sk019-posts-get
  template:
    metadata:
      labels:
        app: sk019-posts-get
    spec:
      containers:
        - name: posts-get amdp-registry.skala-ai.com/skala25a/sk019-posts-get.amd64:1.0
          ports:
            - containerPort: 80
```
```shell
# service.sh

apiVersion: v1
kind: Service
metadata:
  name: ${USER_NAME}-${SERVICE_NAME}
  namespace: ${NAMESPACE}
spec:
  selector:
    app: ${USER_NAME}-${SERVICE_NAME}
  ports:
    - name: http
      protocol: TCP
      port: 8888 #8080
      targetPort: 80
  type: ClusterIP
```

- deploy.shì—ì„œ amdë¥¼ ìœ ì§€í•´ì£¼ê³ 
- service.shëŠ” ì›ë˜ 8080 ë¼ìˆì—ˆëŠ”ë° 8888 ê°™ì•„ì„œ ë°”ê¿”ì¤Œ.

```shell
#env.properties

SERVICE_NAME="posts-get"

#***** NEVER Rewrite ****************************************
DOCKER_REGISTRY="amdp-registry.skala-ai.com/skala25a"
DOCKER_REGISTRY_USER="robot\$skala25a"
DOCKER_REGISTRY_PASSWORD="1qB9cyusbNComZPHAdjNIFWinf52xaBJ"
DOCKER_CACHE="--no-cache"

DEPLOY_PATH="."
DEPLOY_FILE_NAME=deploy.yaml
DEPLOY_FILE_LIST="deploy.yaml service.yaml"
# amd64 | arm64
CPU_PLATFORM=amd64
#CPU_PLATFORM=arm64
#***** NEVER REWRITE ****************************************


#------ USER Customization area --------------------------
USER_NAME=sk019
NAMESPACE=skala-practice
VERSION="1.0"
#------ USER Customization area --------------------------
```

env.propertiesì˜ CPU_PLATFORM=amd64ìœ¼ë¡œ ì„¤ì •í•˜ê¸°.

```shell
# deploy.sh

export USER_NAME=sk019
export SERVICE_NAME=posts-get
export NAMESPACE=skala-practice

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${USER_NAME}-${SERVICE_NAME}
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${USER_NAME}-${SERVICE_NAME}
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8888' #'8080'
        prometheus.io/path: '/prometheus'
        update: e8c24298b888a2dc0795de1564bca2da12
      labels:
        app: ${USER_NAME}-${SERVICE_NAME}
    spec:
      containers:
      - name: ${USER_NAME}-${SERVICE_NAME}
        image: amdp-registry.skala-ai.com/skala25a/${USER_NAME}-posts-get.amd64:1.0
        #image: amdp-registry.skala-ai.com/skala25a/${USER_NAME}-posts-get.arm64:1.0
        #image: amdp-registry.skala-ai.com/skala25a/${USER_NAME}-posts-get:1.0

        imagePullPolicy: Always
```

```shell
# service.sh

apiVersion: v1
kind: Service
metadata:
  name: ${USER_NAME}-${SERVICE_NAME}
  namespace: ${NAMESPACE}
spec:
  selector:
    app: ${USER_NAME}-${SERVICE_NAME}
  ports:
    - name: http
      protocol: TCP
      port: 8888 #8080
      targetPort: 80
  type: ClusterIP
```
deploy.shì—ì„œ amd64ë¡œ í•´ì£¼ê³  service.shì—ì„œ port: 8888ë¡œ ë³€ê²½í•´ì¤Œ.

### 3. docker-build.shì™€ docker-push.sh ì¬ìˆ˜ì •

```shell
# docker-build.sh

#!/bin/bash
NAME=sk019
IMAGE_NAME="healthcheck-server" #IMAGE_NAME="webserver"

VERSION="1.0.0"
CPU_PLATFORM=amd64 #arm64 #amd64

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build \
  --tag ${NAME}-${IMAGE_NAME}:${VERSION} \
  --file Dockerfile \
  --platform linux/${CPU_PLATFORM} \
  ${IS_CACHE} .
```

armì„ amdë¡œ ë‹¤ì‹œë°”ê¿”ì¤«ë‹¤.

```shell
# docker-push.sh

#!/bin/bash
NAME=sk019
IMAGE_NAME="healthcheck-server" #IMAGE_NAME="webserver"

VERSION="1.0.0"

DOCKER_REGISTRY="amdp-registry.skala-ai.com/skala25a"
DOCKER_REGISTRY_USER="robot\$skala25a"
DOCKER_REGISTRY_PASSWORD="1qB9cyusbNComZPHAdjNIFWinf52xaBJ"
DOCKER_CACHE="--no-cache"

# 1. Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸ (ì˜µì…˜: ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ë¯¸ë¦¬ ë¡œê·¸ì¸í•´ë‘ì–´ë„ ë©ë‹ˆë‹¤)
echo ${DOCKER_REGISTRY_PASSWORD} | docker login ${DOCKER_REGISTRY} \
	-u ${DOCKER_REGISTRY_USER}  --password-stdin \
   	|| { echo "Docker ë¡œê·¸ì¸ ì‹¤íŒ¨"; exit 1; }

# 2. harbor ë¡œ push í•˜ê¸° ìœ„í•´ tag ì¶”ê°€
docker tag  ${NAME}-${IMAGE_NAME}.amd64:${VERSION} ${DOCKER_REGISTRY}/${NAME}-${IMAGE_NAME}.amd64:${VERSION}
$docker tag  ${NAME}-${IMAGE_NAME}.arm64:${VERSION} ${DOCKER_REGISTRY}/${NAME}-${IMAGE_NAME}.arm64:${VERSION}


# Docker ì´ë¯¸ì§€ í‘¸ì‹œ
docker push ${DOCKER_REGISTRY}/${NAME}-${IMAGE_NAME}.amd64:${VERSION}
#docker push ${DOCKER_REGISTRY}/${NAME}-${IMAGE_NAME}.arm64:${VERSION}
```

ë§ˆì°¬ê°€ì§€ armì„ amdë¡œ ë°”ê¿”ì¤Œ.

### 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ, í‘¸ì‹œ, kubernetes í™˜ê²½ì— ë°°í¬

```shell
# 1. ë¹Œë“œ
$ sudo docker build --platform=linux/amd64 -t amdp-registry.skala-ai.com/skala25a/sk019-posts-get:1.0 .

# 2. í‘¸ì‹œ
$ sudo docker push amdp-registry.skala-ai.com/skala25a/sk019-posts-get:1.0

# 3. kubernetes í™˜ê²½ì— ë°°í¬
$ cicd.sh â€“y
$ kubectl apply -f deploy.yaml
$ kubectl apply -f service.yaml


# ì¬ì‹œì‘
# $ kubectl rollout restart deployment sk019-posts-get -n skala-practice

# 4. pod í™•ì¸ ë° í¬íŠ¸ í¬ì›Œë”©
$ kubectl get pod -n skala-practice | grep sk019
$ kubectl port-forward pod/<pod_ì´ë¦„> 9999:80 -n skala-practice

# ì˜ˆì‹œ ì¶œë ¥
# $ kubectl get pod -n skala-practice | grep sk019 ì˜ ê²°ê³¼
# sk019-posts-get-7fd8d8bc6b-k7hsz   1/1     Running   0          10s ì¸ ê²½ìš° 
# kubectl port-forward pod/sk019-posts-get-7fd8d8bc6b-k7hsz 9999:80


# ì ‘ì†ë§í¬: http://localhost:9999/sk019
# browser ì ‘ì†ë§í¬: https://frontend.skala25a.project/skalaô°‚ai.com/sk000
```


ì´ë ‡ê²Œ í•˜ë©´ ë‚˜ì™€ì•¼ë˜ëŠ”ë° ê³„ì† 404 ì—ëŸ¬ê°€ ë‚¬ë‹¤.

#

### 5. ë¹„ê³ 

1. deploy.sh: ì±—ì§€í”¼í‹°ì—ì„œ amd64 ë–¼ë¼ê³ í•´ì„œ ë§ˆì§€ë§‰ì—” `image: amdp-registry.skala-ai.com/skala25a/${USER_NAME}-posts-get:1.0`ë„ ì¼ë‹¤ 

2. deploy.yaml: ë§ˆì°¬ê°€ì§€ë¡œ amd64 ë–¼ë¼ê³ í•´ì„œ `amdp-registry.skala-ai.com/skala25a/sk019-posts-get:1.0`ë„ ì¼ë‹¤.

3. defalut.confëŠ” ë‹¤ìŒ ë²„ì „ì„ ì¨ë´¤ë‹¤.

```shell
# default.conf ì›ë˜ ë²„ì „
server {
    listen 80;
    
    location /sk019 {
        alias /usr/share/nginx/html/;
        try_files $uri $uri/ /index.html;
        
    }
}

# ver1
server {
    listen 80;

    location /sk019 {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}

# ver2
server {
    listen 80;

    location /sk019/ {
        alias /usr/share/nginx/html/;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

4. cicd.sh -y ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì— `kubectl apply -f deploy.yaml`ì™€ `kubectl apply -f service.yaml`ë¡œ ëŒ€ì²´ ê°€ëŠ¥í•˜ëŒ€ì„œ ê·¸ëƒ¥ íŒ¨ìŠ¤í–ˆëŠ”ë° ê·¸ë˜ë„ ë˜ëŠ”ê²Œ ë§ëŠ”ì§€ ëª¨ë¥´ê²ŸìŒ

#

#8.8ì¶”ê°€

êµìˆ˜ë‹˜ê»˜ ì§ˆë¬¸ì‚¬í•­ ë””ì—  ë³´ëƒˆëŠ”ë° 

> ìš°ì„  deployë¥¼ í†µí•´ ìì‹ ì´ ë§Œë“¤ì–´ë†“ì€ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ í´ë¼ìš°ë“œ í™˜ê²½ìœ¼ë¡œ ì˜ ë°°í¬í–ˆìŠµë‹ˆë‹¤.
> 
> ê·¸ë¦¬ê³  serviceë¥¼ í†µí•´ ë‚˜ì˜ ì»¨í…Œì´ë„ˆ ë‚´ 80í¬íŠ¸ë¥¼ ë…¸ì¶œí•˜ê³  ìˆëŠ” nginxë¥¼ ì™¸ë¶€ì—ì„œ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ì˜ ì—°ê²°í–ˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ì–´ë””ì„œë“  ì ‘ì†ê°€ëŠ¥í•˜ê²Œ í•˜ê¸° ìœ„í•œ ingress ì„¤ì •ì´ ìˆëŠ”ë° ì´ê²ƒì€ ì œê°€ ë¯¸ë¦¬ ë§Œë“¤ì–´ë†“ì•„ì„œ ìœ„ì˜ URLë¡œ ì ‘ì†ë©ë‹ˆë‹¤.
> 
> ë‹¨ì§€ ë‚´ê°€ ì™¸ë¶€ ì ‘ì†ì„ ìœ„í•œ ingress ì„¤ì •ì— ë“±ë¡í–ˆë˜ service ì´ë¦„ì¸ sk019-posts-getì´ì˜€ëŠ”ë° sk019-posts-get-svcë¡œ ë§Œë“¤ì–´ ë†“ì•„ì„œ
ì´ë¦„ë§Œ ë³€ê²½í•´ë†“ì•˜ìŠµë‹ˆë‹¤.

ë¼ê³  ì˜¤ì…”ì„œ í™•ì¸í•´ë³´ë‹ˆê¹Œ ë§ë„ì•ˆë˜ê²Œ service.yamlì´ ë‹¤ìŒê³¼ê°™ì´ ì‘ì„±ë¼ìˆì—ˆë‹¤

```shell
apiVersion: v1
kind: Service
metadata:
  name: sk019-posts-get-svc
  namespace: skala-practice
spec:
  selector:
    app: sk019-posts-get
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
  ```

  ì•„ë‹ˆê·¼ë° ìœ„ ì‘ì—… í•˜ë©´ì„œ ì“´ ì±—ì§€í”¼í‹° ëŒ€í™”ì°½ì— 'sk019-posts-get' ì¹˜ë©´ ì–´ë””ì„œë„ 'sk019-posts-get-svc'ë¼ëŠ” ë‹¨ì–´ê°€ ì—†ëŠ”ë°....... ì–´ë””ì„œ ë‚˜ì˜¨ê±´ì§€ ëª¨ë¥´ê²Ÿë‹¤

 ![alt text](./image/sw18-1.png)

  ì•„ë¬´íŠ¼ ë§í¬ë¥¼ í™•ì¸í•´ë³´ë‹ˆê¹Œ ì˜ë“¤ì–´ê°€ìˆë‹¤ ã…ã…

#
