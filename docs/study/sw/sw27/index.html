<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동
  #

#2025-08-28


  1. 실습 시나리오
  #

-- 1. 확장 설치 및 테이블 생성
-- 2. 예시 데이터 삽입 (10건만 임시)
-- 3. 인덱스 생성 및 분석
-- 4. 성능 비교: LIMIT 5 vs LIMIT 50
-- 5. 인덱스 종류별 비교 (코사인 vs L2)
-- 6. 사용자 입력 벡터를 Python에서 API로 전달하여 동적 쿼리 구성 예시 (FastAPI 측에서 처리)

  
  #


  2. 코드
  #

#1 SQL 유사도 검색"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/sw/sw27/"><meta property="og:site_name" content=" "><meta property="og:title" content="DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동"><meta property="og:description" content="DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동 # #2025-08-28
1. 실습 시나리오 # -- 1. 확장 설치 및 테이블 생성 -- 2. 예시 데이터 삽입 (10건만 임시) -- 3. 인덱스 생성 및 분석 -- 4. 성능 비교: LIMIT 5 vs LIMIT 50 -- 5. 인덱스 종류별 비교 (코사인 vs L2) -- 6. 사용자 입력 벡터를 Python에서 API로 전달하여 동적 쿼리 구성 예시 (FastAPI 측에서 처리) # 2. 코드 # #1 SQL 유사도 검색"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-08-28T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-28T00:00:00+00:00"><meta property="article:tag" content="2025-08"><title>DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/sw/sw27/><link rel=stylesheet href=/book.min.30a7836b6a89342da3b88e7afd1036166aeced16c8de12df060ded2031837886.css integrity="sha256-MKeDa2qJNC2juI56/RA2Fmrs7RbI3hLfBg3tIDGDeIY=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.b9e2b33eb63c4c61aa9278cd5b1cba6d9af1e534ae3a416d71aa79a4760030a6.js integrity="sha256-ueKzPrY8TGGqknjNWxy6bZrx5TSuOkFtcap5pHYAMKY=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li><li><a href=/docs/hobby/book/>글</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/ai/>AI</a><ul></ul></li><li><a href=/docs/study/sw/>SW</a><ul></ul></li><li><a href=/docs/study/algorithm/>알고리즘</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-실습-시나리오>1. 실습 시나리오</a></li><li></li><li><a href=#2-코드>2. 코드</a></li><li></li><li></li><li></li><li></li><li><a href=#3-코드설명>3. 코드설명</a></li><li></li><li></li><li></li><li></li><li></li><li></li><li><a href=#4-실행-결과-및-해석>4. 실행 결과 및 해석</a></li><li></li><li></li><li><a href=#5-개념>5. 개념</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=dbms-및-sql-활용-4-pgvector-기반-유사도-검색--fastapi-연동>DBMS 및 SQL 활용 #4 pgvector 기반 유사도 검색 + FastAPI 연동
<a class=anchor href=#dbms-%eb%b0%8f-sql-%ed%99%9c%ec%9a%a9-4-pgvector-%ea%b8%b0%eb%b0%98-%ec%9c%a0%ec%82%ac%eb%8f%84-%ea%b2%80%ec%83%89--fastapi-%ec%97%b0%eb%8f%99>#</a></h1><p>#2025-08-28</p><hr><h3 id=1-실습-시나리오>1. 실습 시나리오
<a class=anchor href=#1-%ec%8b%a4%ec%8a%b5-%ec%8b%9c%eb%82%98%eb%a6%ac%ec%98%a4>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>-- 1. 확장 설치 및 테이블 생성
</span></span><span style=display:flex><span>-- 2. 예시 데이터 삽입 (10건만 임시)
</span></span><span style=display:flex><span>-- 3. 인덱스 생성 및 분석
</span></span><span style=display:flex><span>-- 4. 성능 비교: LIMIT 5 vs LIMIT 50
</span></span><span style=display:flex><span>-- 5. 인덱스 종류별 비교 (코사인 vs L2)
</span></span><span style=display:flex><span>-- 6. 사용자 입력 벡터를 Python에서 API로 전달하여 동적 쿼리 구성 예시 (FastAPI 측에서 처리)
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><h3 id=2-코드>2. 코드
<a class=anchor href=#2-%ec%bd%94%eb%93%9c>#</a></h3><p><mark>#1 SQL 유사도 검색</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 1. 확장 설치 및 테이블 생성
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> EXTENSION <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> vector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> design_doc;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> design_doc (
</span></span><span style=display:flex><span>    id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    title TEXT,
</span></span><span style=display:flex><span>    content TEXT,
</span></span><span style=display:flex><span>    embedding_vector VECTOR(<span style=color:#ae81ff>384</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 2. 데이터 삽입 
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- \i &#39;/Users/yshmbid/Documents/home/github/SQL/example_design_doc_inserts_120.sql&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 3. 인덱스 생성
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 코사인 거리 기준 인덱스
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> design_doc <span style=color:#66d9ef>USING</span> ivfflat (embedding_vector vector_cosine_ops) <span style=color:#66d9ef>WITH</span> (lists <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- L2 거리 기준 인덱스
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> design_doc <span style=color:#66d9ef>USING</span> ivfflat (embedding_vector vector_l2_ops) <span style=color:#66d9ef>WITH</span> (lists <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 4. 난수 벡터 생성 UDF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> random_vector()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> vector <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> array_agg(random())::vector(<span style=color:#ae81ff>384</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>384</span>);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>sql</span> <span style=color:#66d9ef>VOLATILE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 5. 성능 비교: (LIMIT 5 vs LIMIT 50) &amp; (코사인 vs L2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DO</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span>
</span></span><span style=display:flex><span>    t1 <span style=color:#66d9ef>TIMESTAMP</span>;
</span></span><span style=display:flex><span>    t2 <span style=color:#66d9ef>TIMESTAMP</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- LIMIT 5 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;LIMIT 5 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- LIMIT 50 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>50</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;LIMIT 50 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 코사인 거리 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;코사인 거리 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- L2 거리 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;-&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;L2 거리 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>;
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p><mark>#2 vector_search_api.py</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#34;/Users/yshmbid/Documents/home/github/SQL&#34;</span>)  <span style=color:#75715e># set path</span>
</span></span><span style=display:flex><span>load_dotenv()  <span style=color:#75715e># .env 파일 로드</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. FastAPI 앱 생성</span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 요청 데이터 모델 정의 (Pydantic BaseModel)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QueryVector</span>(BaseModel):
</span></span><span style=display:flex><span>    vector: list[float]
</span></span><span style=display:flex><span>    limit: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. DB 연결 함수 정의</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_conn</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>        dbname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>        user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>        password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>),
</span></span><span style=display:flex><span>        host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. search_vector()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/search&#34;</span>) <span style=color:#75715e># HTTP POST 요청이 /search 경로로 들어오면 search_vector 함수를 실행.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>search_vector</span>(data: QueryVector):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> get_db_conn()
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># content까지 포함</span>
</span></span><span style=display:flex><span>        query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT id, title, content
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM design_doc
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ORDER BY embedding_vector &lt;=&gt; </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>::vector
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LIMIT </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Python list → pgvector 문자열 변환</span>
</span></span><span style=display:flex><span>        vector_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(map(str, data<span style=color:#f92672>.</span>vector)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>execute(query, (vector_str, data<span style=color:#f92672>.</span>limit))
</span></span><span style=display:flex><span>        rows <span style=color:#f92672>=</span> cur<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;results&#34;</span>: [
</span></span><span style=display:flex><span>                {<span style=color:#e6db74>&#34;id&#34;</span>: r[<span style=color:#ae81ff>0</span>], <span style=color:#e6db74>&#34;title&#34;</span>: r[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;content&#34;</span>: r[<span style=color:#ae81ff>2</span>]} <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> rows
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;DB error: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p><mark>#3 client.py</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ast
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#34;/Users/yshmbid/Documents/home/github/SQL&#34;</span>)  <span style=color:#75715e># set path </span>
</span></span><span style=display:flex><span>load_dotenv()  <span style=color:#75715e># .env 파일 로드</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. DB 연결</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_conn</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>        dbname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>        user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>        password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>),
</span></span><span style=display:flex><span>        host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 기준 문서(id=1) 가져오기 및 출력</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> get_db_conn()
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT id, title, content, embedding_vector FROM design_doc WHERE id = 1;&#34;</span>)
</span></span><span style=display:flex><span>row <span style=color:#f92672>=</span> cur<span style=color:#f92672>.</span>fetchone()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>query_id, query_title, query_content, vec_raw <span style=color:#f92672>=</span> row
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> isinstance(vec_raw, str):
</span></span><span style=display:flex><span>    vec <span style=color:#f92672>=</span> ast<span style=color:#f92672>.</span>literal_eval(vec_raw)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    vec <span style=color:#f92672>=</span> list(vec_raw)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;=== 쿼리로 사용된 문서 ===&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;id: </span><span style=color:#e6db74>{</span>query_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;title: </span><span style=color:#e6db74>{</span>query_title<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;content: </span><span style=color:#e6db74>{</span>query_content<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. API 요청 및 출력 (가장 유사한 문서 1개)</span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://127.0.0.1:8000/search&#34;</span>,
</span></span><span style=display:flex><span>    json<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;vector&#34;</span>: vec, <span style=color:#e6db74>&#34;limit&#34;</span>: <span style=color:#ae81ff>1</span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;=== 원본 API 응답 ===&#34;</span>)
</span></span><span style=display:flex><span>print(response<span style=color:#f92672>.</span>json())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 결과가 있으면 하나만 출력</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;results&#34;</span> <span style=color:#f92672>in</span> response<span style=color:#f92672>.</span>json() <span style=color:#f92672>and</span> len(response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;results&#34;</span>]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;results&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>=== 가장 유사한 문서 ===&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;id: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;title: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;title&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;content: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;content&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p><mark>#4 터미널 실행</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># terminal 1</span>
</span></span><span style=display:flex><span>$ pwd
</span></span><span style=display:flex><span>/Users/yshmbid/Documents/home/github/SQL
</span></span><span style=display:flex><span>$ uvicorn vector_search_api:app --reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># terminal 2</span>
</span></span><span style=display:flex><span>$ pwd
</span></span><span style=display:flex><span>/Users/yshmbid/Documents/home/github/SQL
</span></span><span style=display:flex><span>$ python client.py
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><h3 id=3-코드설명>3. 코드설명
<a class=anchor href=#3-%ec%bd%94%eb%93%9c%ec%84%a4%eb%aa%85>#</a></h3><p><mark>#1 SQL 유사도 검색</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 3. 인덱스 생성
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 코사인 거리 기준 인덱스
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> design_doc <span style=color:#66d9ef>USING</span> ivfflat (embedding_vector vector_cosine_ops) <span style=color:#66d9ef>WITH</span> (lists <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- L2 거리 기준 인덱스
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> design_doc <span style=color:#66d9ef>USING</span> ivfflat (embedding_vector vector_l2_ops) <span style=color:#66d9ef>WITH</span> (lists <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>);
</span></span></code></pre></div><ul><li>embedding_vector vector_cosine_ops<ul><li>embedding_vector 컬럼을 대상으로 인덱스를 생성</li><li>코사인 거리(cosine distance)를 기준으로 유사도 검색을 최적화</li></ul></li><li>WITH (lists = 100)<ul><li>ivfflat는 전체 벡터 공간을 리스트로 나눠서 가장 가까울가능성이 높은 그룹에서 탐색하는 기법을 쓰는데 → 100개의 리스트로 나눠 탐색한다.</li></ul></li><li>embedding_vector vector_l2_ops<ul><li>embedding_vector 컬럼을 대상으로 인덱스를 생성</li><li>L2 거리(유클리드 거리)를 기준으로 유사도 검색을 최적화</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 4. 난수 벡터 생성 UDF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> random_vector()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> vector <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> array_agg(random())::vector(<span style=color:#ae81ff>384</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>384</span>);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>sql</span> <span style=color:#66d9ef>VOLATILE</span>;
</span></span></code></pre></div><ul><li>random_vector() 목적<ul><li>성능 실험용으로 길이 384짜리 난수 벡터 생성</li></ul></li><li>array_agg(random())::vector(384)<ul><li>array_agg(random()): 0 이상 1 미만 난수 384번 생성해서 384차원 배열 생성</li><li>::vector(384): 벡터로 변환</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 5. 성능 비교: (LIMIT 5 vs LIMIT 50) &amp; (코사인 vs L2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DO</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span>
</span></span><span style=display:flex><span>    t1 <span style=color:#66d9ef>TIMESTAMP</span>;
</span></span><span style=display:flex><span>    t2 <span style=color:#66d9ef>TIMESTAMP</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- LIMIT 5 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;LIMIT 5 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- LIMIT 50 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>50</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;LIMIT 50 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 코사인 거리 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;=&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;코사인 거리 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- L2 거리 성능 측정
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    t1 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    PERFORM id, title
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> design_doc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> embedding_vector <span style=color:#f92672>&lt;-&gt;</span> random_vector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>    t2 :<span style=color:#f92672>=</span> clock_timestamp();
</span></span><span style=display:flex><span>    RAISE NOTICE <span style=color:#e6db74>&#39;L2 거리 실행 시간: % ms&#39;</span>, <span style=color:#66d9ef>EXTRACT</span>(MILLISECOND <span style=color:#66d9ef>FROM</span> (t2 <span style=color:#f92672>-</span> t1));
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span>;
</span></span></code></pre></div><ul><li>블록 목적<ul><li>LIMIT 5 vs 50, 코사인 vs L2 케이스별 실행 속도 비교</li></ul></li><li>DO $$ &mldr; $$<ul><li>익명 PL/pgSQL 블록 (DB에 저장되지 않는 블록)</li><li>DECLARE<ul><li>블록 안에서 사용할 Timestamp 변수 t1, t2를 선언</li></ul></li><li>BEGIN … END;<ul><li>실제 실행할 로직을 작성</li></ul></li></ul></li><li>t1 := clock_timestamp(), t2 := clock_timestamp()<ul><li>t1에 시작 시간, t2에 끝 시간 저장</li></ul></li><li>PERFORM id, title<ul><li>PERFORM: 쿼리 실행</li></ul></li><li>LIMIT 5, LIMIT 50<ul><li>가장 유사한 문서 5개만 찾을 때와 50개 찾을 때.</li></ul></li><li>FROM design_doc ORDER BY embedding_vector &lt;=> random_vector()<ul><li>embedding_vector와 랜덤으로 만든 벡터(random_vector())의 코사인 거리를 계산해서 정렬</li></ul></li><li>FROM design_doc ORDER BY embedding_vector &lt;-> random_vector()<ul><li>embedding_vector와 랜덤으로 만든 벡터(random_vector())의 L2 거리를 계산해서 정렬</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><p><mark>#2 vector_search_api.py</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 4. search_vector()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/search&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>search_vector</span>(data: QueryVector):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> get_db_conn()
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># content까지 포함</span>
</span></span><span style=display:flex><span>        query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT id, title, content
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM design_doc
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ORDER BY embedding_vector &lt;=&gt; </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>::vector
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LIMIT </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Python list → pgvector 문자열 변환</span>
</span></span><span style=display:flex><span>        vector_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(map(str, data<span style=color:#f92672>.</span>vector)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>execute(query, (vector_str, data<span style=color:#f92672>.</span>limit))
</span></span><span style=display:flex><span>        rows <span style=color:#f92672>=</span> cur<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;results&#34;</span>: [
</span></span><span style=display:flex><span>                {<span style=color:#e6db74>&#34;id&#34;</span>: r[<span style=color:#ae81ff>0</span>], <span style=color:#e6db74>&#34;title&#34;</span>: r[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;content&#34;</span>: r[<span style=color:#ae81ff>2</span>]} <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> rows
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;DB error: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><ul><li>search_vector() 목적<ul><li>클라이언트가 벡터를 보내면 DB에서 가장 비슷한 문서들을 찾아서 반환</li></ul></li><li>@app.post("/search")<ul><li>HTTP POST 요청이 /search 경로로 들어오면 search_vector 함수를 실행.</li></ul></li><li>get_db_conn()<ul><li>PostgreSQL 연결 생성 (psycopg2)</li></ul></li><li>conn.cursor()<ul><li>SQL 실행을 위한 커서(cursor) 객체 생성</li></ul></li><li>query<ul><li>입력 벡터와 가장 코사인 거리가 가까운 문서 N개를 찾는 쿼리</li><li>embedding_vector &lt;=> %s::vector<ul><li>Python에서 넘긴 벡터 문자열을 vector 타입으로 가져오는데 정렬 기준은 코사인 거리</li></ul></li></ul></li><li>&ldquo;[&rdquo; + &ldquo;,".join(map(str, data.vector)) + &ldquo;]”<ul><li>클라이언트가 보낸 vector(리스트)를 문자열로 바꿔서 PostgreSQL의 vector 타입으로 해석되게.</li></ul></li><li>cur.execute(query, (vector_str, data.limit)) → rows = cur.fetchall()<ul><li>쿼리 실행 & 결과(rows) 가져옴</li></ul></li><li>return …<ul><li>DB에서 가져온 튜플들을 JSON 응답 형식으로 반환</li></ul></li><li>except Exception as e: raise HTTPException(status_code=500, detail=f"DB error: {str(e)}&rdquo;)<ul><li>DB 연결 실패, 쿼리 오류 등이 나면 500 Error 처리.</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><p><mark>#3 client.py</mark></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 2. 기준 문서(id=1) 가져오기 및 출력</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> get_db_conn()
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT id, title, content, embedding_vector FROM design_doc WHERE id = 1;&#34;</span>)
</span></span><span style=display:flex><span>row <span style=color:#f92672>=</span> cur<span style=color:#f92672>.</span>fetchone()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>query_id, query_title, query_content, vec_raw <span style=color:#f92672>=</span> row
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> isinstance(vec_raw, str):
</span></span><span style=display:flex><span>    vec <span style=color:#f92672>=</span> ast<span style=color:#f92672>.</span>literal_eval(vec_raw)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    vec <span style=color:#f92672>=</span> list(vec_raw)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;=== 쿼리로 사용된 문서 ===&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;id: </span><span style=color:#e6db74>{</span>query_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;title: </span><span style=color:#e6db74>{</span>query_title<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;content: </span><span style=color:#e6db74>{</span>query_content<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><ul><li>cur.execute(&ldquo;SELECT id, title, content, embedding_vector FROM design_doc WHERE id = 1;&rdquo;)<ul><li>첫 번째 문서를 기준 문서로 사용할예정이므로 design_doc 테이블에서 id=1인 문서 조회</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 3. API 요청 및 출력 (가장 유사한 문서 1개)</span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://127.0.0.1:8000/search&#34;</span>,
</span></span><span style=display:flex><span>    json<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;vector&#34;</span>: vec, <span style=color:#e6db74>&#34;limit&#34;</span>: <span style=color:#ae81ff>1</span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;=== 원본 API 응답 ===&#34;</span>)
</span></span><span style=display:flex><span>print(response<span style=color:#f92672>.</span>json())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 결과가 있으면 하나만 출력</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;results&#34;</span> <span style=color:#f92672>in</span> response<span style=color:#f92672>.</span>json() <span style=color:#f92672>and</span> len(response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;results&#34;</span>]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;results&#34;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>=== 가장 유사한 문서 ===&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;id: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;title: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;title&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;content: </span><span style=color:#e6db74>{</span>r[<span style=color:#e6db74>&#39;content&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><ul><li>requests.post(&ldquo;http://127.0.0.1:8000/search&rdquo;)<ul><li>HTTP POST 요청: 로컬에서 실행 중인 FastAPI 서버 주소 http://127.0.0.1:8000/search로</li></ul></li><li>json={&ldquo;vector&rdquo;: vec, &ldquo;limit&rdquo;: 1}<ul><li>기준 문서에서 뽑아온 벡터(vec)와 가장 가까운 문서 1개 요청</li></ul></li><li>response.json()[&ldquo;results&rdquo;][0]<ul><li>결과 리스트의 첫 번째 요소(가장 유사한 문서) 가져오기</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><h3 id=4-실행-결과-및-해석>4. 실행 결과 및 해석
<a class=anchor href=#4-%ec%8b%a4%ed%96%89-%ea%b2%b0%ea%b3%bc-%eb%b0%8f-%ed%95%b4%ec%84%9d>#</a></h3><p><mark>#1 성능 비교 (LIMIT 5 vs LIMIT 50) & (cosine vs L2)</mark></p><ul><li>LIMIT 5 vs LIMIT 50<ul><li>LIMIT 5: 9.582 ms</li><li>LIMIT 50: 4.426 ms</li><li>LIMIT 50이 LIMIT 5보다 약 5ms 더 빠르게 수행됨.</li></ul></li><li>cosine vs L2<ul><li>cosine: 6.079 ms</li><li>L2: 4.114 ms</li><li>L2 연산이 cosine 연산보다 약 2ms 더 빠르게 수행됨.</li></ul></li><li>결과 해석<ul><li>LIMIT 값이 크다고 무조건 느려지지 않았는데, 실행 시간은 LIMIT 값에 비례하지 않을 수 있고 이는 ivfflat 인덱스를 사용할 때는 “몇 개를 더 읽어오느냐”보다 “인덱스에서 후보군을 어떻게 선택하느냐”가 더 중요하기 때문일수 있다<ul><li>ivfflat은 “전체 데이터를 다 보지 않고, 후보군(클러스터)만 먼저 고른 뒤, 그 안에서 정렬해서 결과를 뽑는 방식”인데</li><li>LIMIT 값이 작든 크든 먼저 후보군을 고르고 정렬하는 과정은 거의 똑같은데 실제로 시간이 더 걸리는 건 “후보군 선택과 정렬”이지 LIMIT 5에서 5개를, LIMIT 50에서 50개를 뽑는 그 ‘추출 단계’ 자체는 별로 비중이 크지 않기 때문일 수 있다</li><li>그래서 LIMIT 값이 크다고 무조건 느려지지 않았던것일수있다.</li></ul></li><li>L2(&lt;->)가 코사인(&lt;=>)보다 빠르게 나왔는데 L2 거리는 그냥 좌표 차이 제곱해서 더하는 계산이고 코사인 거리 = 내적 계산 + 벡터 크기(norm) 계산이 필요하기 때문에 연산이 더 복잡하므로 시간이 더 소요되는 것이 정상적인 결과<ul><li>실제 서비스에서 속도만 중요하다면 L2를 쓰고 의미적 유사도(문장의 방향성)가 더 중요하다면 코사인을 쓰는 게 맞을수있다</li></ul></li><li>벡터 길이가 384차원이고 쿼리도 정렬 기반인데 모두 10ms 이내라면 인덱스가 잘 적용되고 있는 것으로 보이고<ul><li>인덱스가 없었다면 후보군 없이 전체 데이터를 일일이 다 비교해야 해서 시간이 훨씬 소요되는데 ivfflat이 후보군을 뽑아서 연산 범위를 줄여줬기 때문에 시간이 많이 감소하였다.</li></ul></li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><p><mark>#2 FastAPI 서버 실행 및 클라이언트 실행</mark></p><ul><li>실행 내용<ul><li>DB의 id=1번 문서를 쿼리로 사용해서 가장 유사한 문서 1개를 반환했고 id=1번 문서가 반환</li></ul></li><li>결과 해석<ul><li>쿼리로 준 문서 벡터 id=1와 가장 가까운 것은 id=1이므로 그대로 반환</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><h3 id=5-개념>5. 개념
<a class=anchor href=#5-%ea%b0%9c%eb%85%90>#</a></h3><ul><li>ivfflat?<ul><li>일반 텍스트 검색이나 숫자 검색은 B-Tree 인덱스를 많이 쓰지만</li><li>벡터 검색은 고차원 벡터 간 거리 계산이 필요하기 때문에 가장 가까울 가능성이 높은 그룹에서만 검색하는 근사 최근접 탐색(ANN, Approximate Nearest Neighbor) 기반으로 유사한 데이터를 찾아서 탐색속도가 빠른 ivfflat를 쓴다.</li></ul></li><li>인덱스 생성하는 이유?<ul><li>문서 의미가 얼마나 방향이 비슷한지를 빠르게 찾기위해서.</li></ul></li><li>인덱스가 문서 의미가 얼마나 방향이 비슷한지를 빠르게 찾는데 필요한 이유?<ul><li>인덱스 없는 경우<ul><li>design_doc 테이블의 모든 행에 대해 embedding_vector와 query_vector의 코사인 거리를 계산하므로 10만 건 데이터가 있으면 10만 번의 384차원 내적 연산을 수행.</li></ul></li><li>인덱스 있는 경우<ul><li>USING ivfflat (embedding_vector vector_cosine_ops) 하면 벡터 공간을 리스트 여러개로 미리나눠두고 가장 가까울 가능성이 높은 리스트 몇 개만 선택해서 선택된 리스트 안에서만 거리를 계산한다. 비슷한 후보군 안에서만 비교하기 때문에 속도가 훨씬 빨라진다.</li></ul></li></ul></li><li>익명 PL/pgSQL 블록 사용 장점? (함수나 프로시저로 저장하지 않고 일회성 코드 블록으로 실행하는 이유?)<ul><li>간단히 성능 테스트, 데이터 초기화, 실험을 할거라서 굳이 DB 객체(함수·프로시저)를 생성하고 저장할필요가 없어서 실행 후 흔적이 안남게함.</li><li>일반 SQL로는 안 되는 로직(변수 선언, IF 조건문, LOOP 반복문)을 실행할수있어서.</li></ul></li></ul><h1><a class=anchor href=#>#</a></h1></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-실습-시나리오>1. 실습 시나리오</a></li><li></li><li><a href=#2-코드>2. 코드</a></li><li></li><li></li><li></li><li></li><li><a href=#3-코드설명>3. 코드설명</a></li><li></li><li></li><li></li><li></li><li></li><li></li><li><a href=#4-실행-결과-및-해석>4. 실행 결과 및 해석</a></li><li></li><li></li><li><a href=#5-개념>5. 개념</a></li></ul></li></ul></nav></div></aside></main></body></html>