<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  MutClust 코드 리펙토링 #3 utils
  #

#2025-08-01

MutClust 알고리즘의 코드 구성은 아래와 같은데
MutClust
├── sc/
│    └── lib.py
│    └── arg_parser.py
│    └── utils.py // 전처리 및 분석
└── Test
utils.py는 데이터 전처리 및 분석 함수를 포함한다.
# === Fasta 전처리 ===
def fasta2csv(home_dir, nation_dir, filechunk, ref, outdir):
    for file in filechunk:
        path = os.path.join(home_dir, nation_dir, file)
        filename = os.path.splitext(os.path.basename(file))[0]
        outpath = os.path.join(outdir, f&#34;{filename}.csv&#34;)
        if not os.path.exists(outpath):
            df = DataFrame({'ref': ref.values, 'pos': ref.index})
            seq = ''.join(open(path).readlines()[1:]).strip()
            df['mut'] = [a if a != ref[i] else '' for i, a in enumerate(seq)]
            df.to_csv(outpath, index=False)

def gisaid_fasta2csv(homedir=f&#34;{GISAID_DIR}/Sequence/Preprocessed/&#34;):
    inputdir = os.path.join(homedir, 'MSA_fasta')
    outdir = os.path.join(homedir, 'MSA_mutationinfo')
    Path(outdir).mkdir(exist_ok=True, parents=True)
    core_n = 100
    args_list = []
    for nation_dir in get_dirnames_list(inputdir):
        filelist = get_filenames_list(os.path.join(inputdir, nation_dir))
        for chunk in array_split(filelist, core_n):
            args_list.append((inputdir, nation_dir, chunk, ref_seq, outdir))
    with Pool(core_n) as pool:
        pool.map(fasta2csv, args_list)

# === Nucleotide 전처리 ===
def get_nucleotide_sequence_dict(seq_dir):
    seq_dict = dict()
    seq_list = get_filenames_list(seq_dir)
    for file in seq_list:
        filepath = os.path.join(seq_dir, file)
        df = read_csv(filepath, index_col=0)
        df.name = file.split('.')[0]
        df = df.reset_index(drop=True)
        seq_dict[df.name] = df
    return seq_dict

def getNucleotideRefSeqbyGene():
    return read_csv('/data3/projects/2020_MUTCLUST/Data/Annotation/Nucleotide/covid_annotation.tsv', sep=' ')

def make_nucleotide_mutclust_input(outdir, name, seq_dict=None):
    if not os.path.exists(outdir):
        print(outdir + ' is not exist')
        return

    output_path = os.path.join(outdir, name + '_mutclust_input.tsv')
    freq_df_ATGC_path = os.path.join(outdir, name + '_freq_ATGC.csv') 

    pos_list, freq_list, per_list, entropy_list = [], [], [], []

    if not os.path.exists(freq_df_ATGC_path):
        if seq_dict is None:
            print('load seq_dict')
            return 
        freq_df = DataFrame.from_dict(seq_dict).transpose().fillna(0).astype(int)
        freq_df = freq_df.sort_index()
        freq_df = freq_df[list(IUPAC_CODES.keys())][['A','T','G','C']]
        freq_df.to_csv(freq_df_ATGC_path)
    else:
        freq_df = read_csv(freq_df_ATGC_path, index_col=0)

    for pos in freq_df.index:
        freq = freq_df.loc[pos]
        cnt_n = freq.sum()
        percentage = freq / cnt_n
        entrpy = entropy(percentage, base=2)

        percentage.drop(ref_seq[pos], inplace=True)
        freq.drop(ref_seq[pos], inplace=True)

        pos_list.append(int(pos))
        freq_list.append(freq.sum())
        per_list.append(percentage.sum())
        entropy_list.append(entrpy)

    mutclust_input_df = DataFrame({
        'Position': pos_list,
        'Frequency': freq_list,
        'Percentages': per_list,
        'Entropy': entropy_list
    })
    mutclust_input_df.to_csv(output_path, sep='\t', index=False)
    return mutclust_input_df

# === Mutation 데이터 병렬 처리 ===
def read_thead(filepathlist, return_list, i):
    ref_seq_sr = getNucleotideRefSeq()
    sub_dict = {pos: Counter({k: 0 for k in IUPAC_CODES.keys()}) for pos in ref_seq_sr.index}

    for filepath in filepathlist:
        df = read_csv(filepath, index_col=0).fillna('').reset_index(drop=True)
        for index, mut in enumerate(df['mut']):
            symbol = mut if mut else ref_seq_sr[index + 1]
            if symbol in sub_dict[index + 1]:
                sub_dict[index + 1][symbol] += 1
            else:
                sub_dict[index + 1][symbol] = 1

    return_list.append(sub_dict)
    print(f&#34;{i}th process complete!&#34;)

def merge_thread(poslist, sub_dict_list, return_dict):
    for pos in poslist:
        count_dict = sum([d[pos] for d in sub_dict_list], Counter())
        merged_dict = {k: count_dict.get(k, 0) for k in IUPAC_CODES.keys()}
        return_dict[pos] = merged_dict

def load_mutationinfo(input_dir=COVID19_MUTATIONINFO_DIR, sample_list=None):
    core_n, split_n = 100, 1000 
    sub_dict_list = Manager().list()
    filelist = get_file_paths_recursive(input_dir)
    
    if sample_list:
        filelist = [f for f in filelist if os.path.basename(f).split('.')[0] in sample_list]
    print(f'sample_n: {len(sample_list)}')

    splited_filepaths = array_split(filelist, split_n)
    parameter_list = [(chunk, sub_dict_list, i) for i, chunk in enumerate(splited_filepaths)]
    print('read thread start!')
    multi_processing(read_thead, parameter_list, core_n=core_n)
    print('read thread end!')

    merged_dict = Manager().dict()
    poslist = ref_seq.index
    splited_poslist = array_split(poslist, split_n)
    sub_dict_list = list(sub_dict_list)
    parameter_list = [(pos_chunk, sub_dict_list, merged_dict) for pos_chunk in splited_poslist]

    print('merge thread start!')
    multi_processing(merge_thread, parameter_list, core_n=core_n)
    print('merge thread end!')
    return dict(merged_dict)

# === Matrix 생성 병렬 처리 ===
def make_matrix_thread(file_list):
    clusters_df = pd.read_csv(os.path.join(GISAID_MUTCLUST_OUTPUT_DIR, 'clusters_hscore.txt'), sep='\t')
    column_list = [f&#34;c{i}({row['left_position']},{row['right_position']})&#34; for i, row in clusters_df.iterrows()]
    cluster_df = pd.DataFrame(columns=column_list)

    for path in file_list:
        df = pd.read_csv(path)
        patient_name = os.path.splitext(os.path.basename(path))[0]
        cluster_df.loc[patient_name] = 0
        for pos in df[df['mut'].notnull()]['pos']:
            cluster_idx = clusters_df[(clusters_df['left_position'] <= pos) & (pos <= clusters_df['right_position'])].index
            cluster_df.loc[patient_name][cluster_idx] += 1
    return cluster_df

def make_matrix(mutationinfo_dir, out_dir, tag, cpu_n=60):
    print('starting make matrix!')
    pool = Pool(processes=cpu_n)
    file_list = get_file_paths_recursive(mutationinfo_dir)
    results = pool.map(make_matrix_thread, array_split(file_list, cpu_n))
    pd.concat(results).to_csv(os.path.join(out_dir, f'cluster_matrix_{tag}.csv'))
    pool.close()
    pool.join()

# === H-score 계산 ===
def add_HSCORE():
    df = pd.read_csv(os.path.join(MUTCLUST_INPUT_DIR, 'gisaid_mutclust_input.tsv'), sep='\t')
    df[HSCORE] = df[PER] * df[ENT]
    df.to_csv(os.path.join(MUTCLUST_INPUT_DIR, 'gisaid_mutclust_input_with_score.tsv'), sep='\t', index=False)

# === 주석(Annotation) ===
def annotation():
    import ast
    mapping_df = pd.read_csv(os.path.join(GISAID_METADATA_DIR, 'merged_info.tsv'), sep='\t', index_col=0)
    for i, row in mapping_df.iterrows():
        mapping_df.loc[i] = [ast.literal_eval(val) for val in row]
    print(mapping_df)

def make_clade_divide_mutation():
    clade_dir = './clade_divide_mutation'
    start_dict = getStartDict()
    for file in get_filenames_list(clade_dir):
        df = read_csv(os.path.join(clade_dir, file), sep='\t')
        print(df)

# === 병렬 처리 유틸리티 ===
def multi_processing(func, parameter_list, core_n=100):
    proc, proc_excution, proc_end = [], [], []
    for param in parameter_list:
        proc.append(Process(target=func, args=param))

    while proc or proc_excution:
        for _ in range(len(proc)):
            if len(proc_excution) < core_n:
                p = proc.pop(0)
                p.start()
                proc_excution.append(p)
            else:
                break
        for p in proc_excution[:]:
            if not p.is_alive():
                proc_excution.remove(p)
                p.join()
                p.close()
                proc_end.append(p)

# === 메인 실행 ===
if __name__ == '__main__':
    annotation()
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/algorithm/algo9/"><meta property="og:site_name" content=" "><meta property="og:title" content="MutClust 코드 리펙토링 #3 utils"><meta property="og:description" content="MutClust 코드 리펙토링 #3 utils # #2025-08-01
MutClust 알고리즘의 코드 구성은 아래와 같은데
MutClust ├── sc/ │ └── lib.py │ └── arg_parser.py │ └── utils.py // 전처리 및 분석 └── Test utils.py는 데이터 전처리 및 분석 함수를 포함한다.
# === Fasta 전처리 === def fasta2csv(home_dir, nation_dir, filechunk, ref, outdir): for file in filechunk: path = os.path.join(home_dir, nation_dir, file) filename = os.path.splitext(os.path.basename(file))[0] outpath = os.path.join(outdir, f&#34;{filename}.csv&#34;) if not os.path.exists(outpath): df = DataFrame({'ref': ref.values, 'pos': ref.index}) seq = ''.join(open(path).readlines()[1:]).strip() df['mut'] = [a if a != ref[i] else '' for i, a in enumerate(seq)] df.to_csv(outpath, index=False) def gisaid_fasta2csv(homedir=f&#34;{GISAID_DIR}/Sequence/Preprocessed/&#34;): inputdir = os.path.join(homedir, 'MSA_fasta') outdir = os.path.join(homedir, 'MSA_mutationinfo') Path(outdir).mkdir(exist_ok=True, parents=True) core_n = 100 args_list = [] for nation_dir in get_dirnames_list(inputdir): filelist = get_filenames_list(os.path.join(inputdir, nation_dir)) for chunk in array_split(filelist, core_n): args_list.append((inputdir, nation_dir, chunk, ref_seq, outdir)) with Pool(core_n) as pool: pool.map(fasta2csv, args_list) # === Nucleotide 전처리 === def get_nucleotide_sequence_dict(seq_dir): seq_dict = dict() seq_list = get_filenames_list(seq_dir) for file in seq_list: filepath = os.path.join(seq_dir, file) df = read_csv(filepath, index_col=0) df.name = file.split('.')[0] df = df.reset_index(drop=True) seq_dict[df.name] = df return seq_dict def getNucleotideRefSeqbyGene(): return read_csv('/data3/projects/2020_MUTCLUST/Data/Annotation/Nucleotide/covid_annotation.tsv', sep=' ') def make_nucleotide_mutclust_input(outdir, name, seq_dict=None): if not os.path.exists(outdir): print(outdir + ' is not exist') return output_path = os.path.join(outdir, name + '_mutclust_input.tsv') freq_df_ATGC_path = os.path.join(outdir, name + '_freq_ATGC.csv') pos_list, freq_list, per_list, entropy_list = [], [], [], [] if not os.path.exists(freq_df_ATGC_path): if seq_dict is None: print('load seq_dict') return freq_df = DataFrame.from_dict(seq_dict).transpose().fillna(0).astype(int) freq_df = freq_df.sort_index() freq_df = freq_df[list(IUPAC_CODES.keys())][['A','T','G','C']] freq_df.to_csv(freq_df_ATGC_path) else: freq_df = read_csv(freq_df_ATGC_path, index_col=0) for pos in freq_df.index: freq = freq_df.loc[pos] cnt_n = freq.sum() percentage = freq / cnt_n entrpy = entropy(percentage, base=2) percentage.drop(ref_seq[pos], inplace=True) freq.drop(ref_seq[pos], inplace=True) pos_list.append(int(pos)) freq_list.append(freq.sum()) per_list.append(percentage.sum()) entropy_list.append(entrpy) mutclust_input_df = DataFrame({ 'Position': pos_list, 'Frequency': freq_list, 'Percentages': per_list, 'Entropy': entropy_list }) mutclust_input_df.to_csv(output_path, sep='\t', index=False) return mutclust_input_df # === Mutation 데이터 병렬 처리 === def read_thead(filepathlist, return_list, i): ref_seq_sr = getNucleotideRefSeq() sub_dict = {pos: Counter({k: 0 for k in IUPAC_CODES.keys()}) for pos in ref_seq_sr.index} for filepath in filepathlist: df = read_csv(filepath, index_col=0).fillna('').reset_index(drop=True) for index, mut in enumerate(df['mut']): symbol = mut if mut else ref_seq_sr[index + 1] if symbol in sub_dict[index + 1]: sub_dict[index + 1][symbol] += 1 else: sub_dict[index + 1][symbol] = 1 return_list.append(sub_dict) print(f&#34;{i}th process complete!&#34;) def merge_thread(poslist, sub_dict_list, return_dict): for pos in poslist: count_dict = sum([d[pos] for d in sub_dict_list], Counter()) merged_dict = {k: count_dict.get(k, 0) for k in IUPAC_CODES.keys()} return_dict[pos] = merged_dict def load_mutationinfo(input_dir=COVID19_MUTATIONINFO_DIR, sample_list=None): core_n, split_n = 100, 1000 sub_dict_list = Manager().list() filelist = get_file_paths_recursive(input_dir) if sample_list: filelist = [f for f in filelist if os.path.basename(f).split('.')[0] in sample_list] print(f'sample_n: {len(sample_list)}') splited_filepaths = array_split(filelist, split_n) parameter_list = [(chunk, sub_dict_list, i) for i, chunk in enumerate(splited_filepaths)] print('read thread start!') multi_processing(read_thead, parameter_list, core_n=core_n) print('read thread end!') merged_dict = Manager().dict() poslist = ref_seq.index splited_poslist = array_split(poslist, split_n) sub_dict_list = list(sub_dict_list) parameter_list = [(pos_chunk, sub_dict_list, merged_dict) for pos_chunk in splited_poslist] print('merge thread start!') multi_processing(merge_thread, parameter_list, core_n=core_n) print('merge thread end!') return dict(merged_dict) # === Matrix 생성 병렬 처리 === def make_matrix_thread(file_list): clusters_df = pd.read_csv(os.path.join(GISAID_MUTCLUST_OUTPUT_DIR, 'clusters_hscore.txt'), sep='\t') column_list = [f&#34;c{i}({row['left_position']},{row['right_position']})&#34; for i, row in clusters_df.iterrows()] cluster_df = pd.DataFrame(columns=column_list) for path in file_list: df = pd.read_csv(path) patient_name = os.path.splitext(os.path.basename(path))[0] cluster_df.loc[patient_name] = 0 for pos in df[df['mut'].notnull()]['pos']: cluster_idx = clusters_df[(clusters_df['left_position'] <= pos) & (pos <= clusters_df['right_position'])].index cluster_df.loc[patient_name][cluster_idx] += 1 return cluster_df def make_matrix(mutationinfo_dir, out_dir, tag, cpu_n=60): print('starting make matrix!') pool = Pool(processes=cpu_n) file_list = get_file_paths_recursive(mutationinfo_dir) results = pool.map(make_matrix_thread, array_split(file_list, cpu_n)) pd.concat(results).to_csv(os.path.join(out_dir, f'cluster_matrix_{tag}.csv')) pool.close() pool.join() # === H-score 계산 === def add_HSCORE(): df = pd.read_csv(os.path.join(MUTCLUST_INPUT_DIR, 'gisaid_mutclust_input.tsv'), sep='\t') df[HSCORE] = df[PER] * df[ENT] df.to_csv(os.path.join(MUTCLUST_INPUT_DIR, 'gisaid_mutclust_input_with_score.tsv'), sep='\t', index=False) # === 주석(Annotation) === def annotation(): import ast mapping_df = pd.read_csv(os.path.join(GISAID_METADATA_DIR, 'merged_info.tsv'), sep='\t', index_col=0) for i, row in mapping_df.iterrows(): mapping_df.loc[i] = [ast.literal_eval(val) for val in row] print(mapping_df) def make_clade_divide_mutation(): clade_dir = './clade_divide_mutation' start_dict = getStartDict() for file in get_filenames_list(clade_dir): df = read_csv(os.path.join(clade_dir, file), sep='\t') print(df) # === 병렬 처리 유틸리티 === def multi_processing(func, parameter_list, core_n=100): proc, proc_excution, proc_end = [], [], [] for param in parameter_list: proc.append(Process(target=func, args=param)) while proc or proc_excution: for _ in range(len(proc)): if len(proc_excution) < core_n: p = proc.pop(0) p.start() proc_excution.append(p) else: break for p in proc_excution[:]: if not p.is_alive(): proc_excution.remove(p) p.join() p.close() proc_end.append(p) # === 메인 실행 === if __name__ == '__main__': annotation()"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-01T00:00:00+00:00"><meta property="article:tag" content="2025-08"><title>MutClust 코드 리펙토링 #3 utils |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/algorithm/algo9/><link rel=stylesheet href=/book.min.6217d077edb4189fd0578345e84bca1a884dfdee121ff8dc9a0f55cfe0852bc9.css integrity="sha256-YhfQd+20GJ/QV4NF6EvKGohN/e4SH/jcmg9Vz+CFK8k=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.578a2d8e6e30e0a0ae3682797882d89ca0cbbf1734d206705396ea76cf57bbb6.js integrity="sha256-V4otjm4w4KCuNoJ5eILYnKDLvxc00gZwU5bqds9Xu7Y=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/ai/>AI</a><ul></ul></li><li><a href=/docs/study/sw/>SW</a><ul></ul></li><li><a href=/docs/study/algorithm/>알고리즘</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>MutClust 코드 리펙토링 #3 utils</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents></nav></aside></header><article class="markdown book-article"><h1 id=mutclust-코드-리펙토링-3-utils>MutClust 코드 리펙토링 #3 utils
<a class=anchor href=#mutclust-%ec%bd%94%eb%93%9c-%eb%a6%ac%ed%8e%99%ed%86%a0%eb%a7%81-3-utils>#</a></h1><p>#2025-08-01</p><hr><p>MutClust 알고리즘의 코드 구성은 아래와 같은데</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>MutClust
</span></span><span class=line><span class=cl>├── sc/
</span></span><span class=line><span class=cl>│    └── lib.py
</span></span><span class=line><span class=cl>│    └── arg_parser.py
</span></span><span class=line><span class=cl>│    └── utils.py // 전처리 및 분석
</span></span><span class=line><span class=cl>└── Test
</span></span></code></pre></div><p>utils.py는 데이터 전처리 및 분석 함수를 포함한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># === Fasta 전처리 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fasta2csv</span><span class=p>(</span><span class=n>home_dir</span><span class=p>,</span> <span class=n>nation_dir</span><span class=p>,</span> <span class=n>filechunk</span><span class=p>,</span> <span class=n>ref</span><span class=p>,</span> <span class=n>outdir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>filechunk</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>home_dir</span><span class=p>,</span> <span class=n>nation_dir</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>filename</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>file</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>outpath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>outdir</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>outpath</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span> <span class=o>=</span> <span class=n>DataFrame</span><span class=p>({</span><span class=s1>&#39;ref&#39;</span><span class=p>:</span> <span class=n>ref</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=s1>&#39;pos&#39;</span><span class=p>:</span> <span class=n>ref</span><span class=o>.</span><span class=n>index</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=n>seq</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>readlines</span><span class=p>()[</span><span class=mi>1</span><span class=p>:])</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span><span class=p>[</span><span class=s1>&#39;mut&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span> <span class=k>if</span> <span class=n>a</span> <span class=o>!=</span> <span class=n>ref</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>a</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>seq</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>outpath</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gisaid_fasta2csv</span><span class=p>(</span><span class=n>homedir</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>GISAID_DIR</span><span class=si>}</span><span class=s2>/Sequence/Preprocessed/&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>inputdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>homedir</span><span class=p>,</span> <span class=s1>&#39;MSA_fasta&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>outdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>homedir</span><span class=p>,</span> <span class=s1>&#39;MSA_mutationinfo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Path</span><span class=p>(</span><span class=n>outdir</span><span class=p>)</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>core_n</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>args_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>nation_dir</span> <span class=ow>in</span> <span class=n>get_dirnames_list</span><span class=p>(</span><span class=n>inputdir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>filelist</span> <span class=o>=</span> <span class=n>get_filenames_list</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>inputdir</span><span class=p>,</span> <span class=n>nation_dir</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>array_split</span><span class=p>(</span><span class=n>filelist</span><span class=p>,</span> <span class=n>core_n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>args_list</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>inputdir</span><span class=p>,</span> <span class=n>nation_dir</span><span class=p>,</span> <span class=n>chunk</span><span class=p>,</span> <span class=n>ref_seq</span><span class=p>,</span> <span class=n>outdir</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>Pool</span><span class=p>(</span><span class=n>core_n</span><span class=p>)</span> <span class=k>as</span> <span class=n>pool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pool</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>fasta2csv</span><span class=p>,</span> <span class=n>args_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === Nucleotide 전처리 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_nucleotide_sequence_dict</span><span class=p>(</span><span class=n>seq_dir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>seq_dict</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>seq_list</span> <span class=o>=</span> <span class=n>get_filenames_list</span><span class=p>(</span><span class=n>seq_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>seq_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>filepath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>seq_dir</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>read_csv</span><span class=p>(</span><span class=n>filepath</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>seq_dict</span><span class=p>[</span><span class=n>df</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>seq_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getNucleotideRefSeqbyGene</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>read_csv</span><span class=p>(</span><span class=s1>&#39;/data3/projects/2020_MUTCLUST/Data/Annotation/Nucleotide/covid_annotation.tsv&#39;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_nucleotide_mutclust_input</span><span class=p>(</span><span class=n>outdir</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>seq_dict</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>outdir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>outdir</span> <span class=o>+</span> <span class=s1>&#39; is not exist&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>outdir</span><span class=p>,</span> <span class=n>name</span> <span class=o>+</span> <span class=s1>&#39;_mutclust_input.tsv&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>freq_df_ATGC_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>outdir</span><span class=p>,</span> <span class=n>name</span> <span class=o>+</span> <span class=s1>&#39;_freq_ATGC.csv&#39;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pos_list</span><span class=p>,</span> <span class=n>freq_list</span><span class=p>,</span> <span class=n>per_list</span><span class=p>,</span> <span class=n>entropy_list</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>freq_df_ATGC_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>seq_dict</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;load seq_dict&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> 
</span></span><span class=line><span class=cl>        <span class=n>freq_df</span> <span class=o>=</span> <span class=n>DataFrame</span><span class=o>.</span><span class=n>from_dict</span><span class=p>(</span><span class=n>seq_dict</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>freq_df</span> <span class=o>=</span> <span class=n>freq_df</span><span class=o>.</span><span class=n>sort_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>freq_df</span> <span class=o>=</span> <span class=n>freq_df</span><span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>IUPAC_CODES</span><span class=o>.</span><span class=n>keys</span><span class=p>())][[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span><span class=s1>&#39;T&#39;</span><span class=p>,</span><span class=s1>&#39;G&#39;</span><span class=p>,</span><span class=s1>&#39;C&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=n>freq_df</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>freq_df_ATGC_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>freq_df</span> <span class=o>=</span> <span class=n>read_csv</span><span class=p>(</span><span class=n>freq_df_ATGC_path</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pos</span> <span class=ow>in</span> <span class=n>freq_df</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>freq</span> <span class=o>=</span> <span class=n>freq_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>pos</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cnt_n</span> <span class=o>=</span> <span class=n>freq</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>percentage</span> <span class=o>=</span> <span class=n>freq</span> <span class=o>/</span> <span class=n>cnt_n</span>
</span></span><span class=line><span class=cl>        <span class=n>entrpy</span> <span class=o>=</span> <span class=n>entropy</span><span class=p>(</span><span class=n>percentage</span><span class=p>,</span> <span class=n>base</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>percentage</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>ref_seq</span><span class=p>[</span><span class=n>pos</span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>freq</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>ref_seq</span><span class=p>[</span><span class=n>pos</span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pos_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>pos</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>freq_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>freq</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>per_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>percentage</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>entropy_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entrpy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mutclust_input_df</span> <span class=o>=</span> <span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Position&#39;</span><span class=p>:</span> <span class=n>pos_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Frequency&#39;</span><span class=p>:</span> <span class=n>freq_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Percentages&#39;</span><span class=p>:</span> <span class=n>per_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Entropy&#39;</span><span class=p>:</span> <span class=n>entropy_list</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=n>mutclust_input_df</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>output_path</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mutclust_input_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === Mutation 데이터 병렬 처리 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_thead</span><span class=p>(</span><span class=n>filepathlist</span><span class=p>,</span> <span class=n>return_list</span><span class=p>,</span> <span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ref_seq_sr</span> <span class=o>=</span> <span class=n>getNucleotideRefSeq</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>sub_dict</span> <span class=o>=</span> <span class=p>{</span><span class=n>pos</span><span class=p>:</span> <span class=n>Counter</span><span class=p>({</span><span class=n>k</span><span class=p>:</span> <span class=mi>0</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>IUPAC_CODES</span><span class=o>.</span><span class=n>keys</span><span class=p>()})</span> <span class=k>for</span> <span class=n>pos</span> <span class=ow>in</span> <span class=n>ref_seq_sr</span><span class=o>.</span><span class=n>index</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>filepath</span> <span class=ow>in</span> <span class=n>filepathlist</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>read_csv</span><span class=p>(</span><span class=n>filepath</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>mut</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;mut&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span> <span class=o>=</span> <span class=n>mut</span> <span class=k>if</span> <span class=n>mut</span> <span class=k>else</span> <span class=n>ref_seq_sr</span><span class=p>[</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>sub_dict</span><span class=p>[</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>sub_dict</span><span class=p>[</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sub_dict</span><span class=p>[</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>return_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sub_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>th process complete!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>merge_thread</span><span class=p>(</span><span class=n>poslist</span><span class=p>,</span> <span class=n>sub_dict_list</span><span class=p>,</span> <span class=n>return_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pos</span> <span class=ow>in</span> <span class=n>poslist</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>count_dict</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>([</span><span class=n>d</span><span class=p>[</span><span class=n>pos</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>sub_dict_list</span><span class=p>],</span> <span class=n>Counter</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>merged_dict</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>count_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>IUPAC_CODES</span><span class=o>.</span><span class=n>keys</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>        <span class=n>return_dict</span><span class=p>[</span><span class=n>pos</span><span class=p>]</span> <span class=o>=</span> <span class=n>merged_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_mutationinfo</span><span class=p>(</span><span class=n>input_dir</span><span class=o>=</span><span class=n>COVID19_MUTATIONINFO_DIR</span><span class=p>,</span> <span class=n>sample_list</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>core_n</span><span class=p>,</span> <span class=n>split_n</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>1000</span> 
</span></span><span class=line><span class=cl>    <span class=n>sub_dict_list</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span><span class=o>.</span><span class=n>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>filelist</span> <span class=o>=</span> <span class=n>get_file_paths_recursive</span><span class=p>(</span><span class=n>input_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sample_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>filelist</span> <span class=o>=</span> <span class=p>[</span><span class=n>f</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>filelist</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=n>sample_list</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;sample_n: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>sample_list</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>splited_filepaths</span> <span class=o>=</span> <span class=n>array_split</span><span class=p>(</span><span class=n>filelist</span><span class=p>,</span> <span class=n>split_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parameter_list</span> <span class=o>=</span> <span class=p>[(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>sub_dict_list</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>splited_filepaths</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;read thread start!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>multi_processing</span><span class=p>(</span><span class=n>read_thead</span><span class=p>,</span> <span class=n>parameter_list</span><span class=p>,</span> <span class=n>core_n</span><span class=o>=</span><span class=n>core_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;read thread end!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>merged_dict</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>poslist</span> <span class=o>=</span> <span class=n>ref_seq</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>splited_poslist</span> <span class=o>=</span> <span class=n>array_split</span><span class=p>(</span><span class=n>poslist</span><span class=p>,</span> <span class=n>split_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sub_dict_list</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>sub_dict_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parameter_list</span> <span class=o>=</span> <span class=p>[(</span><span class=n>pos_chunk</span><span class=p>,</span> <span class=n>sub_dict_list</span><span class=p>,</span> <span class=n>merged_dict</span><span class=p>)</span> <span class=k>for</span> <span class=n>pos_chunk</span> <span class=ow>in</span> <span class=n>splited_poslist</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;merge thread start!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>multi_processing</span><span class=p>(</span><span class=n>merge_thread</span><span class=p>,</span> <span class=n>parameter_list</span><span class=p>,</span> <span class=n>core_n</span><span class=o>=</span><span class=n>core_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;merge thread end!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>merged_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === Matrix 생성 병렬 처리 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_matrix_thread</span><span class=p>(</span><span class=n>file_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>clusters_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>GISAID_MUTCLUST_OUTPUT_DIR</span><span class=p>,</span> <span class=s1>&#39;clusters_hscore.txt&#39;</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>column_list</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;c</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>(</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;left_position&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>,</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;right_position&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>clusters_df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>    <span class=n>cluster_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=n>column_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>file_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>patient_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>path</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cluster_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>patient_name</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pos</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;mut&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>notnull</span><span class=p>()][</span><span class=s1>&#39;pos&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>cluster_idx</span> <span class=o>=</span> <span class=n>clusters_df</span><span class=p>[(</span><span class=n>clusters_df</span><span class=p>[</span><span class=s1>&#39;left_position&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>pos</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>clusters_df</span><span class=p>[</span><span class=s1>&#39;right_position&#39;</span><span class=p>])]</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>            <span class=n>cluster_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>patient_name</span><span class=p>][</span><span class=n>cluster_idx</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cluster_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_matrix</span><span class=p>(</span><span class=n>mutationinfo_dir</span><span class=p>,</span> <span class=n>out_dir</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>cpu_n</span><span class=o>=</span><span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;starting make matrix!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span> <span class=o>=</span> <span class=n>Pool</span><span class=p>(</span><span class=n>processes</span><span class=o>=</span><span class=n>cpu_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_list</span> <span class=o>=</span> <span class=n>get_file_paths_recursive</span><span class=p>(</span><span class=n>mutationinfo_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>make_matrix_thread</span><span class=p>,</span> <span class=n>array_split</span><span class=p>(</span><span class=n>file_list</span><span class=p>,</span> <span class=n>cpu_n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>out_dir</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;cluster_matrix_</span><span class=si>{</span><span class=n>tag</span><span class=si>}</span><span class=s1>.csv&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === H-score 계산 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_HSCORE</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>MUTCLUST_INPUT_DIR</span><span class=p>,</span> <span class=s1>&#39;gisaid_mutclust_input.tsv&#39;</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=n>HSCORE</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>PER</span><span class=p>]</span> <span class=o>*</span> <span class=n>df</span><span class=p>[</span><span class=n>ENT</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>MUTCLUST_INPUT_DIR</span><span class=p>,</span> <span class=s1>&#39;gisaid_mutclust_input_with_score.tsv&#39;</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 주석(Annotation) ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>annotation</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>ast</span>
</span></span><span class=line><span class=cl>    <span class=n>mapping_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>GISAID_METADATA_DIR</span><span class=p>,</span> <span class=s1>&#39;merged_info.tsv&#39;</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>mapping_df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>mapping_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>ast</span><span class=o>.</span><span class=n>literal_eval</span><span class=p>(</span><span class=n>val</span><span class=p>)</span> <span class=k>for</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>row</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mapping_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_clade_divide_mutation</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>clade_dir</span> <span class=o>=</span> <span class=s1>&#39;./clade_divide_mutation&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>start_dict</span> <span class=o>=</span> <span class=n>getStartDict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>get_filenames_list</span><span class=p>(</span><span class=n>clade_dir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>read_csv</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>clade_dir</span><span class=p>,</span> <span class=n>file</span><span class=p>),</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 병렬 처리 유틸리티 ===</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multi_processing</span><span class=p>(</span><span class=n>func</span><span class=p>,</span> <span class=n>parameter_list</span><span class=p>,</span> <span class=n>core_n</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=p>,</span> <span class=n>proc_excution</span><span class=p>,</span> <span class=n>proc_end</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>param</span> <span class=ow>in</span> <span class=n>parameter_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>proc</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>func</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=n>param</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>proc</span> <span class=ow>or</span> <span class=n>proc_excution</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>proc</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>proc_excution</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>core_n</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>=</span> <span class=n>proc</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>proc_excution</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>proc_excution</span><span class=p>[:]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>p</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>proc_excution</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>proc_end</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 메인 실행 ===</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>annotation</span><span class=p>()</span>
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents></nav></div></aside></main></body></html>