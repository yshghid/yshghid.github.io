<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  #3 모델 구축
  #

#2025-06-23


  1. Load package
  #

import warnings

warnings.filterwarnings("ignore")

import copy
from pathlib import Path
import warnings

import lightning.pytorch as pl
from lightning.pytorch.callbacks import EarlyStopping, LearningRateMonitor
from lightning.pytorch.loggers import TensorBoardLogger
import numpy as np
import pandas as pd
import torch

from pytorch_forecasting import Baseline, TemporalFusionTransformer, TimeSeriesDataSet
from pytorch_forecasting.data import GroupNormalizer
from pytorch_forecasting.metrics import MAE, SMAPE, PoissonLoss, QuantileLoss
from pytorch_forecasting.models.temporal_fusion_transformer.tuning import (
    optimize_hyperparameters,
)
import pytorch_forecasting
import torch
import pytorch_lightning as pl

print("PyTorch Forecasting:", pytorch_forecasting.__version__)
print("PyTorch:", torch.__version__)
print("PyTorch Lightning:", pl.__version__)
PyTorch Forecasting: 0.10.2
PyTorch: 1.13.1+cu117
PyTorch Lightning: 1.6.5
pytorch 및 관련 패키지 버전.

  2. Load data
  #

os.chdir(&#39;/data3/projects/2025_Antibiotics/YSH/&#39;)

meddir = &#39;res&#39;
seqdir = &#39;data/final_dict&#39;
with open(f"{meddir}/all_meds.txt", &#39;r&#39;) as f:
    all_meds = [line.strip().replace("/", "_") for line in f if line.strip()]

all_df = []

for med in tqdm(all_meds):
    try:
        with open(f"{seqdir}/{med}.pkl", &#39;rb&#39;) as f:
            sequences = pickle.load(f)
    except Exception as e:
        print(f"[ERROR] {med}: {e}")
        continue

    for pid, df in sequences.items():
        df = df.copy()
        df["pid"] = pid
        df["med"] = med
        df["time_idx"] = range(len(df))
        all_df.append(df)

total_sequences = pd.concat(all_df).reset_index(drop=True)
100%|██████████| 169/169 [00:14<00:00, 11.86it/s]
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/tech/tech33/"><meta property="og:site_name" content=" "><meta property="og:title" content="#3 모델 구축"><meta property="og:description" content='#3 모델 구축 # #2025-06-23
1. Load package # import warnings warnings.filterwarnings("ignore") import copy from pathlib import Path import warnings import lightning.pytorch as pl from lightning.pytorch.callbacks import EarlyStopping, LearningRateMonitor from lightning.pytorch.loggers import TensorBoardLogger import numpy as np import pandas as pd import torch from pytorch_forecasting import Baseline, TemporalFusionTransformer, TimeSeriesDataSet from pytorch_forecasting.data import GroupNormalizer from pytorch_forecasting.metrics import MAE, SMAPE, PoissonLoss, QuantileLoss from pytorch_forecasting.models.temporal_fusion_transformer.tuning import ( optimize_hyperparameters, ) import pytorch_forecasting import torch import pytorch_lightning as pl print("PyTorch Forecasting:", pytorch_forecasting.__version__) print("PyTorch:", torch.__version__) print("PyTorch Lightning:", pl.__version__) PyTorch Forecasting: 0.10.2 PyTorch: 1.13.1+cu117 PyTorch Lightning: 1.6.5 pytorch 및 관련 패키지 버전.
2. Load data # os.chdir(&#39;/data3/projects/2025_Antibiotics/YSH/&#39;) meddir = &#39;res&#39; seqdir = &#39;data/final_dict&#39; with open(f"{meddir}/all_meds.txt", &#39;r&#39;) as f: all_meds = [line.strip().replace("/", "_") for line in f if line.strip()] all_df = [] for med in tqdm(all_meds): try: with open(f"{seqdir}/{med}.pkl", &#39;rb&#39;) as f: sequences = pickle.load(f) except Exception as e: print(f"[ERROR] {med}: {e}") continue for pid, df in sequences.items(): df = df.copy() df["pid"] = pid df["med"] = med df["time_idx"] = range(len(df)) all_df.append(df) total_sequences = pd.concat(all_df).reset_index(drop=True) 100%|██████████| 169/169 [00:14<00:00, 11.86it/s]'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-06-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-23T00:00:00+00:00"><meta property="article:tag" content="2025-06"><title>#3 모델 구축 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/tech/tech33/><link rel=stylesheet href=/book.min.6217d077edb4189fd0578345e84bca1a884dfdee121ff8dc9a0f55cfe0852bc9.css integrity="sha256-YhfQd+20GJ/QV4NF6EvKGohN/e4SH/jcmg9Vz+CFK8k=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.578a2d8e6e30e0a0ae3682797882d89ca0cbbf1734d206705396ea76cf57bbb6.js integrity="sha256-V4otjm4w4KCuNoJ5eILYnKDLvxc00gZwU5bqds9Xu7Y=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/ai/>AI</a><ul></ul></li><li><a href=/docs/study/sw/>SW</a><ul></ul></li><li><a href=/docs/study/algorithm/>알고리즘</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>#3 모델 구축</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=3-모델-구축>#3 모델 구축
<a class=anchor href=#3-%eb%aa%a8%eb%8d%b8-%ea%b5%ac%ec%b6%95>#</a></h1><p>#2025-06-23</p><hr><h3 id=1-load-package>1. Load package
<a class=anchor href=#1-load-package>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>warnings</span><span class=o>.</span><span class=n>filterwarnings</span><span class=p>(</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>copy</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lightning.pytorch</span> <span class=k>as</span> <span class=nn>pl</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lightning.pytorch.callbacks</span> <span class=kn>import</span> <span class=n>EarlyStopping</span><span class=p>,</span> <span class=n>LearningRateMonitor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lightning.pytorch.loggers</span> <span class=kn>import</span> <span class=n>TensorBoardLogger</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting</span> <span class=kn>import</span> <span class=n>Baseline</span><span class=p>,</span> <span class=n>TemporalFusionTransformer</span><span class=p>,</span> <span class=n>TimeSeriesDataSet</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.data</span> <span class=kn>import</span> <span class=n>GroupNormalizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.metrics</span> <span class=kn>import</span> <span class=n>MAE</span><span class=p>,</span> <span class=n>SMAPE</span><span class=p>,</span> <span class=n>PoissonLoss</span><span class=p>,</span> <span class=n>QuantileLoss</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.models.temporal_fusion_transformer.tuning</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>optimize_hyperparameters</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytorch_forecasting</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytorch_lightning</span> <span class=k>as</span> <span class=nn>pl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PyTorch Forecasting:&#34;</span><span class=p>,</span> <span class=n>pytorch_forecasting</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PyTorch:&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PyTorch Lightning:&#34;</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>PyTorch Forecasting: 0.10.2
</span></span><span class=line><span class=cl>PyTorch: 1.13.1+cu117
</span></span><span class=line><span class=cl>PyTorch Lightning: 1.6.5
</span></span></code></pre></div><p>pytorch 및 관련 패키지 버전.</p><h3 id=2-load-data>2. Load data
<a class=anchor href=#2-load-data>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=s1>&#39;/data3/projects/2025_Antibiotics/YSH/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>meddir</span> <span class=o>=</span> <span class=s1>&#39;res&#39;</span>
</span></span><span class=line><span class=cl><span class=n>seqdir</span> <span class=o>=</span> <span class=s1>&#39;data/final_dict&#39;</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>meddir</span><span class=si>}</span><span class=s2>/all_meds.txt&#34;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>all_meds</span> <span class=o>=</span> <span class=p>[</span><span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span> <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>all_df</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>med</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>all_meds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>seqdir</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>med</span><span class=si>}</span><span class=s2>.pkl&#34;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sequences</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[ERROR] </span><span class=si>{</span><span class=n>med</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>df</span> <span class=ow>in</span> <span class=n>sequences</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=s2>&#34;pid&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pid</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=s2>&#34;med&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>med</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=s2>&#34;time_idx&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>all_df</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>total_sequences</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>all_df</span><span class=p>)</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>100%|██████████| 169/169 [00:14&lt;00:00, 11.86it/s]
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li></ul></li></ul></nav></div></aside></main></body></html>