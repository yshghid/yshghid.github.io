<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  #3 모델 구축
  #

#2025-06-23


  1. Load package
  #

import warnings

warnings.filterwarnings("ignore")

import copy
from pathlib import Path
import warnings

import lightning.pytorch as pl
from lightning.pytorch.callbacks import EarlyStopping, LearningRateMonitor
from lightning.pytorch.loggers import TensorBoardLogger
import numpy as np
import pandas as pd
import torch

from pytorch_forecasting import Baseline, TemporalFusionTransformer, TimeSeriesDataSet
from pytorch_forecasting.data import GroupNormalizer
from pytorch_forecasting.metrics import MAE, SMAPE, PoissonLoss, QuantileLoss
from pytorch_forecasting.models.temporal_fusion_transformer.tuning import (
    optimize_hyperparameters,
)
import pytorch_forecasting
import torch
import pytorch_lightning as pl

print("PyTorch Forecasting:", pytorch_forecasting.__version__)
print("PyTorch:", torch.__version__)
print("PyTorch Lightning:", pl.__version__)
PyTorch Forecasting: 0.10.2
PyTorch: 1.13.1+cu117
PyTorch Lightning: 1.6.5
pytorch 및 관련 패키지 버전.'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/tech/tech33/"><meta property="og:site_name" content="Lifelog 2025"><meta property="og:title" content="#3 모델 구축"><meta property="og:description" content='#3 모델 구축 # #2025-06-23
1. Load package # import warnings warnings.filterwarnings("ignore") import copy from pathlib import Path import warnings import lightning.pytorch as pl from lightning.pytorch.callbacks import EarlyStopping, LearningRateMonitor from lightning.pytorch.loggers import TensorBoardLogger import numpy as np import pandas as pd import torch from pytorch_forecasting import Baseline, TemporalFusionTransformer, TimeSeriesDataSet from pytorch_forecasting.data import GroupNormalizer from pytorch_forecasting.metrics import MAE, SMAPE, PoissonLoss, QuantileLoss from pytorch_forecasting.models.temporal_fusion_transformer.tuning import ( optimize_hyperparameters, ) import pytorch_forecasting import torch import pytorch_lightning as pl print("PyTorch Forecasting:", pytorch_forecasting.__version__) print("PyTorch:", torch.__version__) print("PyTorch Lightning:", pl.__version__) PyTorch Forecasting: 0.10.2 PyTorch: 1.13.1+cu117 PyTorch Lightning: 1.6.5 pytorch 및 관련 패키지 버전.'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-06-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-23T00:00:00+00:00"><meta property="article:tag" content="2025-06"><title>#3 모델 구축 | Lifelog 2025</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/tech/tech33/><link rel=stylesheet href=/book.min.6217d077edb4189fd0578345e84bca1a884dfdee121ff8dc9a0f55cfe0852bc9.css integrity="sha256-YhfQd+20GJ/QV4NF6EvKGohN/e4SH/jcmg9Vz+CFK8k=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a826c901fa20ad388b3b9e9b35c4ccaaead2cfe39d721bef93147be2b5898de8.js integrity="sha256-qCbJAfogrTiLO56bNcTMqurSz+OdchvvkxR74rWJjeg=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span>Lifelog 2025</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li><li><a href=/docs/hobby/favorite/>취향모음</a><ul></ul></li><li><a href=/docs/hobby/etc/>기타</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/tech/>생물정보학</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li><li><a href=/docs/study/etc/>기타</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>#3 모델 구축</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=3-모델-구축>#3 모델 구축
<a class=anchor href=#3-%eb%aa%a8%eb%8d%b8-%ea%b5%ac%ec%b6%95>#</a></h1><p>#2025-06-23</p><hr><h3 id=1-load-package>1. Load package
<a class=anchor href=#1-load-package>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> warnings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>warnings<span style=color:#f92672>.</span>filterwarnings(<span style=color:#e6db74>&#34;ignore&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> copy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> warnings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lightning.pytorch <span style=color:#66d9ef>as</span> pl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lightning.pytorch.callbacks <span style=color:#f92672>import</span> EarlyStopping, LearningRateMonitor
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lightning.pytorch.loggers <span style=color:#f92672>import</span> TensorBoardLogger
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> torch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting <span style=color:#f92672>import</span> Baseline, TemporalFusionTransformer, TimeSeriesDataSet
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.data <span style=color:#f92672>import</span> GroupNormalizer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.metrics <span style=color:#f92672>import</span> MAE, SMAPE, PoissonLoss, QuantileLoss
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.models.temporal_fusion_transformer.tuning <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    optimize_hyperparameters,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pytorch_forecasting
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> torch
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pytorch_lightning <span style=color:#66d9ef>as</span> pl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;PyTorch Forecasting:&#34;</span>, pytorch_forecasting<span style=color:#f92672>.</span>__version__)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;PyTorch:&#34;</span>, torch<span style=color:#f92672>.</span>__version__)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;PyTorch Lightning:&#34;</span>, pl<span style=color:#f92672>.</span>__version__)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>PyTorch Forecasting: 0.10.2
</span></span><span style=display:flex><span>PyTorch: 1.13.1+cu117
</span></span><span style=display:flex><span>PyTorch Lightning: 1.6.5
</span></span></code></pre></div><p>pytorch 및 관련 패키지 버전.</p><h3 id=2-load-data>2. Load data
<a class=anchor href=#2-load-data>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#39;/data3/projects/2025_Antibiotics/YSH/&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meddir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;res&#39;</span>
</span></span><span style=display:flex><span>seqdir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;data/final_dict&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>meddir<span style=color:#e6db74>}</span><span style=color:#e6db74>/all_meds.txt&#34;</span>, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    all_meds <span style=color:#f92672>=</span> [line<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>) <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> f <span style=color:#66d9ef>if</span> line<span style=color:#f92672>.</span>strip()]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>all_df <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> med <span style=color:#f92672>in</span> tqdm(all_meds):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>seqdir<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>med<span style=color:#e6db74>}</span><span style=color:#e6db74>.pkl&#34;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            sequences <span style=color:#f92672>=</span> pickle<span style=color:#f92672>.</span>load(f)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[ERROR] </span><span style=color:#e6db74>{</span>med<span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> pid, df <span style=color:#f92672>in</span> sequences<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>        df[<span style=color:#e6db74>&#34;pid&#34;</span>] <span style=color:#f92672>=</span> pid
</span></span><span style=display:flex><span>        df[<span style=color:#e6db74>&#34;med&#34;</span>] <span style=color:#f92672>=</span> med
</span></span><span style=display:flex><span>        df[<span style=color:#e6db74>&#34;time_idx&#34;</span>] <span style=color:#f92672>=</span> range(len(df))
</span></span><span style=display:flex><span>        all_df<span style=color:#f92672>.</span>append(df)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>total_sequences <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat(all_df)<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>100%|██████████| 169/169 [00:14&lt;00:00, 11.86it/s]
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li></ul></li></ul></nav></div></aside></main></body></html>