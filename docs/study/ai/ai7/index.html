<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  TFT #3 모델 학습
  #

#2025-07-23


  1. Load package
  #

import pytorch_lightning as pl
from pytorch_lightning.callbacks import EarlyStopping, LearningRateMonitor
from pytorch_lightning.loggers import TensorBoardLogger

from pytorch_forecasting import TimeSeriesDataSet
from pytorch_forecasting.models import TemporalFusionTransformer
from pytorch_forecasting.models.baseline import Baseline

from pytorch_forecasting.metrics import QuantileLoss
from pytorch_forecasting.metrics import MAE
from pytorch_forecasting.data import GroupNormalizer, NaNLabelEncoder

import numpy as np
import pandas as pd
import torch
import pickle
import matplotlib.pyplot as plt
#data
/data
└── Sequence.pkl

  2. Load data
  #

sequence = pd.read_pickle("/data/Sequence.pkl")
sequence
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/ai/ai7/"><meta property="og:site_name" content=" "><meta property="og:title" content="TFT #3 모델 학습"><meta property="og:description" content='TFT #3 모델 학습 # #2025-07-23
1. Load package # import pytorch_lightning as pl from pytorch_lightning.callbacks import EarlyStopping, LearningRateMonitor from pytorch_lightning.loggers import TensorBoardLogger from pytorch_forecasting import TimeSeriesDataSet from pytorch_forecasting.models import TemporalFusionTransformer from pytorch_forecasting.models.baseline import Baseline from pytorch_forecasting.metrics import QuantileLoss from pytorch_forecasting.metrics import MAE from pytorch_forecasting.data import GroupNormalizer, NaNLabelEncoder import numpy as np import pandas as pd import torch import pickle import matplotlib.pyplot as plt #data
/data └── Sequence.pkl 2. Load data # sequence = pd.read_pickle("/data/Sequence.pkl") sequence'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-23T00:00:00+00:00"><meta property="article:tag" content="2025-07"><title>TFT #3 모델 학습 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/ai/ai7/><link rel=stylesheet href=/book.min.6217d077edb4189fd0578345e84bca1a884dfdee121ff8dc9a0f55cfe0852bc9.css integrity="sha256-YhfQd+20GJ/QV4NF6EvKGohN/e4SH/jcmg9Vz+CFK8k=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.774e22f211267fdfce847ab8f94d017ef569bed2228dd582c41e8fe9c834acbd.js integrity="sha256-d04i8hEmf9/OhHq4+U0BfvVpvtIijdWCxB6P6cg0rL0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li><li><a href=/docs/hobby/shopping/>쇼핑</a><ul></ul></li><li><a href=/docs/hobby/youtube/>유튜브</a><ul></ul></li><li><a href=/docs/hobby/music/>음악</a><ul></ul></li><li><a href=/docs/hobby/baking/>베이킹</a><ul></ul></li><li><a href=/docs/hobby/movie/>영화</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/ai/>AI</a><ul></ul></li><li><a href=/docs/study/sw/>SW</a><ul></ul></li><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/devops/>DevOps</a><ul></ul></li><li><a href=/docs/study/algorithm/>코테</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>TFT #3 모델 학습</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li><li><a href=#3>3.</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=tft-3-모델-학습>TFT #3 모델 학습
<a class=anchor href=#tft-3-%eb%aa%a8%eb%8d%b8-%ed%95%99%ec%8a%b5>#</a></h1><p>#2025-07-23</p><hr><h3 id=1-load-package>1. Load package
<a class=anchor href=#1-load-package>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pytorch_lightning <span style=color:#66d9ef>as</span> pl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_lightning.callbacks <span style=color:#f92672>import</span> EarlyStopping, LearningRateMonitor
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_lightning.loggers <span style=color:#f92672>import</span> TensorBoardLogger
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting <span style=color:#f92672>import</span> TimeSeriesDataSet
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.models <span style=color:#f92672>import</span> TemporalFusionTransformer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.models.baseline <span style=color:#f92672>import</span> Baseline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.metrics <span style=color:#f92672>import</span> QuantileLoss
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.metrics <span style=color:#f92672>import</span> MAE
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pytorch_forecasting.data <span style=color:#f92672>import</span> GroupNormalizer, NaNLabelEncoder
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> torch
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pickle
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span></code></pre></div><p>#data</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>/data
</span></span><span style=display:flex><span>└── Sequence.pkl
</span></span></code></pre></div><h3 id=2-load-data>2. Load data
<a class=anchor href=#2-load-data>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sequence <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_pickle(<span style=color:#e6db74>&#34;/data/Sequence.pkl&#34;</span>)
</span></span><span style=display:flex><span>sequence
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/2dc80ef0-4da5-4d72-bf2d-4d7087b38b64 alt=image></p><h3 id=3>3.
<a class=anchor href=#3>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 예측 대상</span>
</span></span><span style=display:flex><span>target_variable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NEWS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 시계열 길이</span>
</span></span><span style=display:flex><span>max_encoder_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>max_prediction_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>context_length <span style=color:#f92672>=</span> max_encoder_length <span style=color:#f92672>+</span> max_prediction_length
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 수치형 변수 목록 (merged_df 기준, 특수문자 제거된 이름 사용)</span>
</span></span><span style=display:flex><span>numeric_features <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;WHO&#39;</span>, <span style=color:#e6db74>&#39;SOFA&#39;</span>, <span style=color:#e6db74>&#39;PBS&#39;</span>, <span style=color:#e6db74>&#39;qPitt&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;ALT_U_L&#39;</span>, <span style=color:#e6db74>&#39;AST_U_L&#39;</span>, <span style=color:#e6db74>&#39;BUN_mg_dL&#39;</span>, <span style=color:#e6db74>&#39;Creatinine_mg_dL&#39;</span>, <span style=color:#e6db74>&#39;d_Dimer_ug_ml_FEU&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Ferritin_ng_mL&#39;</span>, <span style=color:#e6db74>&#39;HCO3_mmol_L&#39;</span>, <span style=color:#e6db74>&#39;Hemoglobin_g_dL&#39;</span>, <span style=color:#e6db74>&#39;LDH_U_L&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Lymphocytes_pct&#39;</span>, <span style=color:#e6db74>&#39;MDRD_eGFR_mL_min_BSA&#39;</span>, <span style=color:#e6db74>&#39;Seg_neutrophils_pct&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;O2_Saturation_pct&#39;</span>, <span style=color:#e6db74>&#39;PCO2_mmHg&#39;</span>, <span style=color:#e6db74>&#39;PO2_mmHg&#39;</span>, <span style=color:#e6db74>&#39;Platelet_count_10^3_uL&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Potassium_mmol_L&#39;</span>, <span style=color:#e6db74>&#39;Sodium_mmol_L&#39;</span>, <span style=color:#e6db74>&#39;WBC_Count_10＾3_uL&#39;</span>, <span style=color:#e6db74>&#39;CRP_mg_dL&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;pH_&#39;</span>, <span style=color:#e6db74>&#39;total_CO2_mmol_L&#39;</span>, <span style=color:#e6db74>&#39;med_cnt&#39;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 범주형 변수</span>
</span></span><span style=display:flex><span>categorical_features <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;pid&#34;</span>, <span style=color:#e6db74>&#34;med&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 타입 정리</span>
</span></span><span style=display:flex><span>sequence[<span style=color:#e6db74>&#34;time_idx&#34;</span>] <span style=color:#f92672>=</span> sequence[<span style=color:#e6db74>&#34;time_idx&#34;</span>]<span style=color:#f92672>.</span>astype(int)
</span></span><span style=display:flex><span>sequence[<span style=color:#e6db74>&#34;pid&#34;</span>] <span style=color:#f92672>=</span> sequence[<span style=color:#e6db74>&#34;pid&#34;</span>]<span style=color:#f92672>.</span>astype(str)
</span></span><span style=display:flex><span>sequence[<span style=color:#e6db74>&#34;med&#34;</span>] <span style=color:#f92672>=</span> sequence[<span style=color:#e6db74>&#34;med&#34;</span>]<span style=color:#f92672>.</span>astype(str)
</span></span><span style=display:flex><span>sequence[<span style=color:#e6db74>&#34;group_id&#34;</span>] <span style=color:#f92672>=</span> sequence[<span style=color:#e6db74>&#34;group_id&#34;</span>]<span style=color:#f92672>.</span>astype(str)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 결측치 제거</span>
</span></span><span style=display:flex><span>sequence <span style=color:#f92672>=</span> sequence<span style=color:#f92672>.</span>dropna(subset<span style=color:#f92672>=</span>[target_variable, <span style=color:#e6db74>&#34;time_idx&#34;</span>, <span style=color:#e6db74>&#34;pid&#34;</span>])<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 유효한 group_id만 필터링 (10개 이상만 통과)</span>
</span></span><span style=display:flex><span>valid_groups <span style=color:#f92672>=</span> sequence<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#34;group_id&#34;</span>)[<span style=color:#e6db74>&#34;time_idx&#34;</span>]<span style=color:#f92672>.</span>count()
</span></span><span style=display:flex><span>valid_groups <span style=color:#f92672>=</span> valid_groups[valid_groups <span style=color:#f92672>&gt;=</span> context_length]<span style=color:#f92672>.</span>index
</span></span><span style=display:flex><span>filtered_df <span style=color:#f92672>=</span> sequence[sequence[<span style=color:#e6db74>&#34;group_id&#34;</span>]<span style=color:#f92672>.</span>isin(valid_groups)]<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># TimeSeriesDataSet 정의</span>
</span></span><span style=display:flex><span>ts_dataset <span style=color:#f92672>=</span> TimeSeriesDataSet(
</span></span><span style=display:flex><span>    data<span style=color:#f92672>=</span>filtered_df,
</span></span><span style=display:flex><span>    time_idx<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;time_idx&#34;</span>,
</span></span><span style=display:flex><span>    target<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;NEWS&#34;</span>,
</span></span><span style=display:flex><span>    group_ids<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;group_id&#34;</span>],
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    max_encoder_length<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>    max_prediction_length<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    static_categoricals<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;pid&#34;</span>],
</span></span><span style=display:flex><span>    time_varying_known_categoricals<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;med&#34;</span>],
</span></span><span style=display:flex><span>    time_varying_known_reals<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;time_idx&#34;</span>, <span style=color:#e6db74>&#34;effective_med&#34;</span>],
</span></span><span style=display:flex><span>    time_varying_unknown_reals<span style=color:#f92672>=</span>numeric_features,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    target_normalizer<span style=color:#f92672>=</span>GroupNormalizer(groups<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;group_id&#34;</span>]),
</span></span><span style=display:flex><span>    categorical_encoders<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;med&#34;</span>: NaNLabelEncoder(add_nan<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)},
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    add_relative_time_idx<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    add_target_scales<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    add_encoder_length<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    allow_missing_timesteps<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 검증용 데이터셋 (predict=True)</span>
</span></span><span style=display:flex><span>validation <span style=color:#f92672>=</span> TimeSeriesDataSet<span style=color:#f92672>.</span>from_dataset(
</span></span><span style=display:flex><span>    ts_dataset, merged_df, predict<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, stop_randomization<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># DataLoader 생성</span>
</span></span><span style=display:flex><span>batch_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>train_dataloader <span style=color:#f92672>=</span> ts_dataset<span style=color:#f92672>.</span>to_dataloader(train<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, batch_size<span style=color:#f92672>=</span>batch_size, num_workers<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>val_dataloader <span style=color:#f92672>=</span> validation<span style=color:#f92672>.</span>to_dataloader(train<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, batch_size<span style=color:#f92672>=</span>batch_size <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>, num_workers<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Baseline 예측</span>
</span></span><span style=display:flex><span>baseline_model <span style=color:#f92672>=</span> Baseline()
</span></span><span style=display:flex><span>y_pred <span style=color:#f92672>=</span> baseline_model<span style=color:#f92672>.</span>predict(val_dataloader)  <span style=color:#75715e># y는 별도로 저장되지 않음</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 실제 정답 y 추출 (val_dataloader에서 수동으로 추출해야 함)</span>
</span></span><span style=display:flex><span>actuals <span style=color:#f92672>=</span> torch<span style=color:#f92672>.</span>cat([y[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> iter(val_dataloader)])  <span style=color:#75715e># y[0] = target 값</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MAE 계산</span>
</span></span><span style=display:flex><span>mae_score <span style=color:#f92672>=</span> MAE()(y_pred, actuals)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Baseline MAE: </span><span style=color:#e6db74>{</span>mae_score<span style=color:#e6db74>:</span><span style=color:#e6db74>.4f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Baseline MAE: 1.2169
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># configure network and trainer</span>
</span></span><span style=display:flex><span>pl<span style=color:#f92672>.</span>seed_everything(<span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span>trainer <span style=color:#f92672>=</span> pl<span style=color:#f92672>.</span>Trainer(
</span></span><span style=display:flex><span>    accelerator<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cpu&#34;</span>,
</span></span><span style=display:flex><span>    gradient_clip_val<span style=color:#f92672>=</span><span style=color:#ae81ff>0.1</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tft <span style=color:#f92672>=</span> TemporalFusionTransformer<span style=color:#f92672>.</span>from_dataset(
</span></span><span style=display:flex><span>    ts_dataset,
</span></span><span style=display:flex><span>    <span style=color:#75715e># not meaningful for finding the learning rate but otherwise very important</span>
</span></span><span style=display:flex><span>    learning_rate<span style=color:#f92672>=</span><span style=color:#ae81ff>0.03</span>,
</span></span><span style=display:flex><span>    hidden_size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,  <span style=color:#75715e># most important hyperparameter apart from learning rate</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># number of attention heads. Set to up to 4 for large datasets</span>
</span></span><span style=display:flex><span>    attention_head_size<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    dropout<span style=color:#f92672>=</span><span style=color:#ae81ff>0.1</span>,  <span style=color:#75715e># between 0.1 and 0.3 are good values</span>
</span></span><span style=display:flex><span>    hidden_continuous_size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,  <span style=color:#75715e># set to &lt;= hidden_size</span>
</span></span><span style=display:flex><span>    loss<span style=color:#f92672>=</span>QuantileLoss(),
</span></span><span style=display:flex><span>    optimizer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;adam&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e># reduce learning rate if no improvement in validation loss after x epochs</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># reduce_on_plateau_patience=1000,</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Number of parameters in network: </span><span style=color:#e6db74>{</span>tft<span style=color:#f92672>.</span>size() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1e3</span><span style=color:#e6db74>:</span><span style=color:#e6db74>.1f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>k&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Number of parameters in network: 65.3k
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#학습률 계산</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lr_finder <span style=color:#f92672>=</span> trainer<span style=color:#f92672>.</span>tuner<span style=color:#f92672>.</span>lr_find(
</span></span><span style=display:flex><span>    model<span style=color:#f92672>=</span>tft,
</span></span><span style=display:flex><span>    train_dataloaders<span style=color:#f92672>=</span>train_dataloader,
</span></span><span style=display:flex><span>    val_dataloaders<span style=color:#f92672>=</span>val_dataloader,
</span></span><span style=display:flex><span>    min_lr<span style=color:#f92672>=</span><span style=color:#ae81ff>1e-6</span>,
</span></span><span style=display:flex><span>    max_lr<span style=color:#f92672>=</span><span style=color:#ae81ff>10.0</span>,
</span></span><span style=display:flex><span>    num_training<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;suggested learning rate: </span><span style=color:#e6db74>{</span>lr_finder<span style=color:#f92672>.</span>suggestion()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>fig <span style=color:#f92672>=</span> lr_finder<span style=color:#f92672>.</span>plot(show<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, suggest<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Finding best initial lr: 100%|██████████| 100/100 [00:46&lt;00:00,  2.17it/s]
</span></span><span style=display:flex><span>`Trainer.fit` stopped: `max_steps=100` reached.
</span></span><span style=display:flex><span>suggested learning rate: 0.007079457843841384
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/747b5393-4da9-4acc-b3c3-f55133ca8191 alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>early_stop_callback <span style=color:#f92672>=</span> EarlyStopping(
</span></span><span style=display:flex><span>    monitor<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;val_loss&#34;</span>, min_delta<span style=color:#f92672>=</span><span style=color:#ae81ff>1e-4</span>, patience<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;min&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>lr_logger <span style=color:#f92672>=</span> LearningRateMonitor()  <span style=color:#75715e># log the learning rate</span>
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> TensorBoardLogger(<span style=color:#e6db74>&#34;lightning_logs&#34;</span>)  <span style=color:#75715e># logging results to a tensorboard</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trainer <span style=color:#f92672>=</span> pl<span style=color:#f92672>.</span>Trainer(
</span></span><span style=display:flex><span>    max_epochs<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>,
</span></span><span style=display:flex><span>    accelerator<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cpu&#34;</span>,
</span></span><span style=display:flex><span>    enable_model_summary<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    gradient_clip_val<span style=color:#f92672>=</span><span style=color:#ae81ff>0.1</span>,
</span></span><span style=display:flex><span>    limit_train_batches<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>,  <span style=color:#75715e># coment in for training, running valiation every 30 batches</span>
</span></span><span style=display:flex><span>    callbacks<span style=color:#f92672>=</span>[lr_logger, early_stop_callback],
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>=</span>logger,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tft <span style=color:#f92672>=</span> TemporalFusionTransformer<span style=color:#f92672>.</span>from_dataset(
</span></span><span style=display:flex><span>    ts_dataset,
</span></span><span style=display:flex><span>    embedding_sizes<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;med&#39;</span>: (<span style=color:#ae81ff>140</span>, <span style=color:#ae81ff>25</span>), <span style=color:#e6db74>&#39;pid&#39;</span>: (<span style=color:#ae81ff>5688</span>, <span style=color:#ae81ff>100</span>)},  <span style=color:#75715e># ✅ 이렇게 넘겨줘야 함!</span>
</span></span><span style=display:flex><span>    learning_rate<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00708</span>,
</span></span><span style=display:flex><span>    hidden_size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>    attention_head_size<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    dropout<span style=color:#f92672>=</span><span style=color:#ae81ff>0.1</span>,
</span></span><span style=display:flex><span>    hidden_continuous_size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>    loss<span style=color:#f92672>=</span>QuantileLoss(),
</span></span><span style=display:flex><span>    log_interval<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    optimizer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;adam&#34;</span>,
</span></span><span style=display:flex><span>    reduce_on_plateau_patience<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Number of parameters in network: </span><span style=color:#e6db74>{</span>tft<span style=color:#f92672>.</span>size() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1e3</span><span style=color:#e6db74>:</span><span style=color:#e6db74>.1f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>k&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Number of parameters in network: 65.3k
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>trainer<span style=color:#f92672>.</span>fit(
</span></span><span style=display:flex><span>    tft,
</span></span><span style=display:flex><span>    train_dataloaders<span style=color:#f92672>=</span>train_dataloader,
</span></span><span style=display:flex><span>    val_dataloaders<span style=color:#f92672>=</span>val_dataloader,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>   | Name                               | Type                            | Params
</span></span><span style=display:flex><span>----------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>0  | loss                               | QuantileLoss                    | 0     
</span></span><span style=display:flex><span>1  | logging_metrics                    | ModuleList                      | 0     
</span></span><span style=display:flex><span>2  | input_embeddings                   | MultiEmbedding                  | 46.6 K
</span></span><span style=display:flex><span>3  | prescalers                         | ModuleDict                      | 528   
</span></span><span style=display:flex><span>4  | static_variable_selection          | VariableSelectionNetwork        | 1.2 K 
</span></span><span style=display:flex><span>5  | encoder_variable_selection         | VariableSelectionNetwork        | 12.5 K
</span></span><span style=display:flex><span>6  | decoder_variable_selection         | VariableSelectionNetwork        | 1.2 K 
</span></span><span style=display:flex><span>7  | static_context_variable_selection  | GatedResidualNetwork            | 304   
</span></span><span style=display:flex><span>8  | static_context_initial_hidden_lstm | GatedResidualNetwork            | 304   
</span></span><span style=display:flex><span>9  | static_context_initial_cell_lstm   | GatedResidualNetwork            | 304   
</span></span><span style=display:flex><span>10 | static_context_enrichment          | GatedResidualNetwork            | 304   
</span></span><span style=display:flex><span>11 | lstm_encoder                       | LSTM                            | 576   
</span></span><span style=display:flex><span>12 | lstm_decoder                       | LSTM                            | 576   
</span></span><span style=display:flex><span>13 | post_lstm_gate_encoder             | GatedLinearUnit                 | 144   
</span></span><span style=display:flex><span>14 | post_lstm_add_norm_encoder         | AddNorm                         | 16    
</span></span><span style=display:flex><span>15 | static_enrichment                  | GatedResidualNetwork            | 368   
</span></span><span style=display:flex><span>16 | multihead_attn                     | InterpretableMultiHeadAttention | 280   
</span></span><span style=display:flex><span>17 | post_attn_gate_norm                | GateAddNorm                     | 160   
</span></span><span style=display:flex><span>18 | pos_wise_ff                        | GatedResidualNetwork            | 304   
</span></span><span style=display:flex><span>19 | pre_output_gate_norm               | GateAddNorm                     | 160   
</span></span><span style=display:flex><span>20 | output_layer                       | Linear                          | 63    
</span></span><span style=display:flex><span>----------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>65.3 K    Trainable params
</span></span><span style=display:flex><span>0         Non-trainable params
</span></span><span style=display:flex><span>65.3 K    Total params
</span></span><span style=display:flex><span>0.261     Total estimated model params size (MB)
</span></span><span style=display:flex><span>Sanity Checking: 0it [00:00, ?it/s]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Epoch 0:  74%|███████▎  | 50/68 [00:22&lt;00:08,  2.21it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Validation: 0it [00:00, ?it/s]
</span></span><span style=display:flex><span>Validation:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span style=display:flex><span>Validation DataLoader 0:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span style=display:flex><span>Epoch 0:  75%|███████▌  | 51/68 [00:23&lt;00:07,  2.15it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  76%|███████▋  | 52/68 [00:24&lt;00:07,  2.09it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  78%|███████▊  | 53/68 [00:26&lt;00:07,  2.02it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  79%|███████▉  | 54/68 [00:27&lt;00:07,  1.96it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  81%|████████  | 55/68 [00:29&lt;00:06,  1.89it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  82%|████████▏ | 56/68 [00:32&lt;00:06,  1.74it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  84%|████████▍ | 57/68 [00:33&lt;00:06,  1.71it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  85%|████████▌ | 58/68 [00:34&lt;00:05,  1.68it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  87%|████████▋ | 59/68 [00:36&lt;00:05,  1.63it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  88%|████████▊ | 60/68 [00:37&lt;00:04,  1.60it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  90%|████████▉ | 61/68 [00:38&lt;00:04,  1.57it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  91%|█████████ | 62/68 [00:40&lt;00:03,  1.54it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  93%|█████████▎| 63/68 [00:41&lt;00:03,  1.53it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  94%|█████████▍| 64/68 [00:42&lt;00:02,  1.51it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  96%|█████████▌| 65/68 [00:43&lt;00:02,  1.50it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  97%|█████████▋| 66/68 [00:44&lt;00:01,  1.48it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0:  99%|█████████▊| 67/68 [00:45&lt;00:00,  1.46it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span style=display:flex><span>Epoch 0: 100%|██████████| 68/68 [00:47&lt;00:00,  1.44it/s, loss=0.543, v_num=8, train_loss_step=0.582, val_loss=0.524]
</span></span><span style=display:flex><span>Epoch 1:  74%|███████▎  | 50/68 [00:22&lt;00:08,  2.22it/s, loss=0.531, v_num=8, train_loss_step=0.493, val_loss=0.524, train_loss_epoch=0.581]
</span></span><span style=display:flex><span>Validation: 0it [00:00, ?it/s]
</span></span><span style=display:flex><span>Validation:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Epoch 49:  96%|█████████▌| 65/68 [00:46&lt;00:02,  1.41it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span style=display:flex><span>Epoch 49:  97%|█████████▋| 66/68 [00:47&lt;00:01,  1.39it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span style=display:flex><span>Epoch 49:  99%|█████████▊| 67/68 [00:48&lt;00:00,  1.37it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span style=display:flex><span>Epoch 49: 100%|██████████| 68/68 [00:49&lt;00:00,  1.36it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.453]
</span></span><span style=display:flex><span>Epoch 49: 100%|██████████| 68/68 [00:49&lt;00:00,  1.36it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.444]
</span></span><span style=display:flex><span>Output is truncated. View as a scrollable element or open in a text editor. Adjust cell output settings...
</span></span><span style=display:flex><span>`Trainer.fit` stopped: `max_epochs=50` reached.
</span></span><span style=display:flex><span>Epoch 49: 100%|██████████| 68/68 [00:50&lt;00:00,  1.35it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.444]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>n_rows, n_cols <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>fig, axs <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>subplots(n_rows, n_cols, figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>20</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>plotted <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>idx <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>max_plots <span style=color:#f92672>=</span> n_rows <span style=color:#f92672>*</span> n_cols
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> plotted <span style=color:#f92672>&lt;</span> max_plots <span style=color:#f92672>and</span> idx <span style=color:#f92672>&lt;</span> len(x[<span style=color:#e6db74>&#34;decoder_target&#34;</span>]):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        target <span style=color:#f92672>=</span> x[<span style=color:#e6db74>&#34;decoder_target&#34;</span>][idx]<span style=color:#f92672>.</span>detach()<span style=color:#f92672>.</span>cpu()<span style=color:#f92672>.</span>numpy()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> np<span style=color:#f92672>.</span>isnan(target)<span style=color:#f92672>.</span>all() <span style=color:#f92672>or</span> np<span style=color:#f92672>.</span>all(target <span style=color:#f92672>==</span> target[<span style=color:#ae81ff>0</span>]):
</span></span><span style=display:flex><span>            idx <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ax <span style=color:#f92672>=</span> axs<span style=color:#f92672>.</span>flat[plotted]
</span></span><span style=display:flex><span>        tft<span style=color:#f92672>.</span>plot_prediction(
</span></span><span style=display:flex><span>    x,
</span></span><span style=display:flex><span>    raw_predictions,
</span></span><span style=display:flex><span>    idx<span style=color:#f92672>=</span>idx,
</span></span><span style=display:flex><span>    add_loss_to_title<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>=</span>ax)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ax<span style=color:#f92672>.</span>set_ylim(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        plotted <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        idx <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{</span>idx<span style=color:#e6db74>}</span><span style=color:#e6db74>] 예측 시각화 중 오류 발생: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        idx <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>tight_layout()
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/a853fe73-f5dc-49a6-91d9-0a0273c4d238 alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 예측 결과 시각화: y축을 고정하여 개별 출력</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> idx <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>21</span>):
</span></span><span style=display:flex><span>    fig, ax <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>subplots(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>4</span>))  <span style=color:#75715e># 각 그래프는 개별로</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        tft<span style=color:#f92672>.</span>plot_prediction(
</span></span><span style=display:flex><span>            x,
</span></span><span style=display:flex><span>            raw_predictions,
</span></span><span style=display:flex><span>            idx<span style=color:#f92672>=</span>idx,
</span></span><span style=display:flex><span>            add_loss_to_title<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            ax<span style=color:#f92672>=</span>ax
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        ax<span style=color:#f92672>.</span>set_ylim(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>20</span>)  <span style=color:#75715e># y축 범위 고정 (원하는 범위로 수정 가능)</span>
</span></span><span style=display:flex><span>        plt<span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{</span>idx<span style=color:#e6db74>}</span><span style=color:#e6db74>] 예측 시각화 중 오류 발생: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/408b7342-1e80-4b8a-83f5-ec86e55ff3b0 alt=image>
<img src=https://github.com/user-attachments/assets/0b205eaa-9cad-4a36-b876-1420c7b819a1 alt=image>
<img src=https://github.com/user-attachments/assets/ab685d82-a121-41ca-a623-e4214c2938d7 alt=image>
<img src=https://github.com/user-attachments/assets/509c4721-fa37-4c17-b079-eba584602f7e alt=image>
<img src=https://github.com/user-attachments/assets/39d98517-482e-4d3e-ad28-1058b855329c alt=image>
<img src=https://github.com/user-attachments/assets/3c3f27d7-2569-4b73-873c-10dc7e7e2b97 alt=image>
<img src=https://github.com/user-attachments/assets/4dd58b53-12f9-4e0c-a2e0-3c3e631ec824 alt=image>
<img src=https://github.com/user-attachments/assets/9a89cacd-66b1-4f1d-9c83-5534d275cb56 alt=image>
<img src=https://github.com/user-attachments/assets/041525c9-1e8f-4637-a406-ee2bce5af35a alt=image>
<img src=https://github.com/user-attachments/assets/e0e967eb-31a4-457e-b104-b54491c1facd alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(type(raw_predictions))
</span></span><span style=display:flex><span>print(len(raw_predictions))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i, item <span style=color:#f92672>in</span> enumerate(raw_predictions):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>] type: </span><span style=color:#e6db74>{</span>type(item)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;예측 길이:&#34;</span>, ts_dataset<span style=color:#f92672>.</span>max_prediction_length)  <span style=color:#75715e># 3이어야 함</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 예측 결과에서 예측값만 추출</span>
</span></span><span style=display:flex><span>y_hat <span style=color:#f92672>=</span> raw_predictions[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 예측값 shape 확인</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;y_hat shape:&#34;</span>, y_hat<span style=color:#f92672>.</span>shape)  <span style=color:#75715e># 예상: (batch_size, target_dim=1, prediction_length=3)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;class &#39;pytorch_forecasting.utils.TupleOutputMixIn.to_network_output.&lt;locals&gt;.Output&#39;&gt;
</span></span><span style=display:flex><span>8
</span></span><span style=display:flex><span>[0] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[1] type: &lt;class &#39;list&#39;&gt;
</span></span><span style=display:flex><span>[2] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[3] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[4] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[5] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[6] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>[7] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span style=display:flex><span>예측 길이: 3
</span></span><span style=display:flex><span>y_hat shape: torch.Size([23001, 3, 7])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 인코딩된 항생제 정보 확인</span>
</span></span><span style=display:flex><span>ts_dataset<span style=color:#f92672>.</span>get_parameters()[<span style=color:#e6db74>&#34;categorical_encoders&#34;</span>][<span style=color:#e6db74>&#34;med&#34;</span>]<span style=color:#f92672>.</span>classes_
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># dict 방향 뒤집기</span>
</span></span><span style=display:flex><span>med_index_to_str <span style=color:#f92672>=</span> {v: k <span style=color:#66d9ef>for</span> k, v <span style=color:#f92672>in</span> med_index_to_str<span style=color:#f92672>.</span>items()}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 인코더 정보 가져오기</span>
</span></span><span style=display:flex><span>cat_encoders <span style=color:#f92672>=</span> ts_dataset<span style=color:#f92672>.</span>get_parameters()[<span style=color:#e6db74>&#34;categorical_encoders&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># med 클래스: str → int 형태라면 → dict 뒤집기</span>
</span></span><span style=display:flex><span>med_index_to_str <span style=color:#f92672>=</span> cat_encoders[<span style=color:#e6db74>&#34;med&#34;</span>]<span style=color:#f92672>.</span>classes_
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> isinstance(med_index_to_str, dict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> list(med_index_to_str<span style=color:#f92672>.</span>values())[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1000</span>:  <span style=color:#75715e># int 값이면 → 뒤집기</span>
</span></span><span style=display:flex><span>        med_index_to_str <span style=color:#f92672>=</span> {v: k <span style=color:#66d9ef>for</span> k, v <span style=color:#f92672>in</span> med_index_to_str<span style=color:#f92672>.</span>items()}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># med가 categorical feature 몇 번째인지 확인</span>
</span></span><span style=display:flex><span>cat_features <span style=color:#f92672>=</span> ts_dataset<span style=color:#f92672>.</span>categoricals
</span></span><span style=display:flex><span>med_index <span style=color:#f92672>=</span> cat_features<span style=color:#f92672>.</span>index(<span style=color:#e6db74>&#34;med&#34;</span>)  <span style=color:#75715e># 예: 1번</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 예측 구간에서 med 인덱스 가져오기</span>
</span></span><span style=display:flex><span>future_med_indices <span style=color:#f92672>=</span> x[<span style=color:#e6db74>&#39;decoder_cat&#39;</span>][<span style=color:#ae81ff>0</span>, :, med_index]<span style=color:#f92672>.</span>tolist()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 인덱스 → 약물이름</span>
</span></span><span style=display:flex><span>future_med_names <span style=color:#f92672>=</span> [med_index_to_str<span style=color:#f92672>.</span>get(int(idx), <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>) <span style=color:#66d9ef>for</span> idx <span style=color:#f92672>in</span> future_med_indices]
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;예측 구간의 항생제:&#34;</span>, future_med_names)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>예측 구간의 항생제: [&#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>5</span>):  <span style=color:#75715e># 첫 5개 시퀀스</span>
</span></span><span style=display:flex><span>    meds <span style=color:#f92672>=</span> [med_index_to_str<span style=color:#f92672>.</span>get(int(idx), <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>) <span style=color:#66d9ef>for</span> idx <span style=color:#f92672>in</span> x[<span style=color:#e6db74>&#39;decoder_cat&#39;</span>][i, :, med_index]]
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;#</span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> 예측 구간 항생제:&#34;</span>, meds)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>#0 예측 구간 항생제: [&#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;]
</span></span><span style=display:flex><span>#1 예측 구간 항생제: [&#39;Remdesivir&#39;, &#39;Remdesivir&#39;, &#39;Remdesivir&#39;]
</span></span><span style=display:flex><span>#2 예측 구간 항생제: [&#39;Tazocin&#39;, &#39;Tazocin&#39;, &#39;Tazocin&#39;]
</span></span><span style=display:flex><span>#3 예측 구간 항생제: [&#39;Hanomycin&#39;, &#39;Hanomycin&#39;, &#39;Hanomycin&#39;]
</span></span><span style=display:flex><span>#4 예측 구간 항생제: [&#39;Meropen&#39;, &#39;Meropen&#39;, &#39;Meropen&#39;]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 예측 수행 (validation 데이터셋 대상)</span>
</span></span><span style=display:flex><span>raw_predictions, x <span style=color:#f92672>=</span> tft<span style=color:#f92672>.</span>predict(
</span></span><span style=display:flex><span>    val_dataloader,
</span></span><span style=display:flex><span>    mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;raw&#34;</span>,       <span style=color:#75715e># 예측값 전체를 출력 (raw tensor)</span>
</span></span><span style=display:flex><span>    return_x<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>     <span style=color:#75715e># 입력 데이터도 함께 반환</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 디코딩용 인덱스</span>
</span></span><span style=display:flex><span>med_index_to_str <span style=color:#f92672>=</span> list(ts_dataset<span style=color:#f92672>.</span>get_parameters()[<span style=color:#e6db74>&#34;categorical_encoders&#34;</span>][<span style=color:#e6db74>&#34;med&#34;</span>]<span style=color:#f92672>.</span>classes_)
</span></span><span style=display:flex><span>pid_index_to_str <span style=color:#f92672>=</span> list(ts_dataset<span style=color:#f92672>.</span>get_parameters()[<span style=color:#e6db74>&#34;categorical_encoders&#34;</span>][<span style=color:#e6db74>&#34;pid&#34;</span>]<span style=color:#f92672>.</span>classes_)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 예측 및 실제값</span>
</span></span><span style=display:flex><span>preds <span style=color:#f92672>=</span> raw_predictions[<span style=color:#e6db74>&#34;prediction&#34;</span>]<span style=color:#f92672>.</span>detach()<span style=color:#f92672>.</span>cpu()<span style=color:#f92672>.</span>numpy()[:, :, <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>targets <span style=color:#f92672>=</span> x[<span style=color:#e6db74>&#34;decoder_target&#34;</span>]<span style=color:#f92672>.</span>detach()<span style=color:#f92672>.</span>cpu()<span style=color:#f92672>.</span>numpy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 인덱스 추출</span>
</span></span><span style=display:flex><span>med_indices <span style=color:#f92672>=</span> x[<span style=color:#e6db74>&#34;decoder_cat&#34;</span>][:, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>int()<span style=color:#f92672>.</span>cpu()<span style=color:#f92672>.</span>numpy()
</span></span><span style=display:flex><span>pid_indices <span style=color:#f92672>=</span> x[<span style=color:#e6db74>&#34;groups&#34;</span>][:, <span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>int()<span style=color:#f92672>.</span>cpu()<span style=color:#f92672>.</span>numpy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>maes <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>mean(np<span style=color:#f92672>.</span>abs(preds <span style=color:#f92672>-</span> targets), axis<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 시각화</span>
</span></span><span style=display:flex><span>n <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>ncols <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>nrows <span style=color:#f92672>=</span> (n <span style=color:#f92672>+</span> ncols <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>//</span> ncols
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(ncols <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>, nrows <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(n):
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>subplot(nrows, ncols, i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    true <span style=color:#f92672>=</span> targets[i]
</span></span><span style=display:flex><span>    pred <span style=color:#f92672>=</span> preds[i]
</span></span><span style=display:flex><span>    mae <span style=color:#f92672>=</span> maes[i]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># med 및 pid 인덱스를 문자열로 변환</span>
</span></span><span style=display:flex><span>    med_idx <span style=color:#f92672>=</span> med_indices[i]
</span></span><span style=display:flex><span>    med <span style=color:#f92672>=</span> med_index_to_str[med_idx] <span style=color:#66d9ef>if</span> med_idx <span style=color:#f92672>&lt;</span> len(med_index_to_str) <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    pid_idx <span style=color:#f92672>=</span> pid_indices[i]
</span></span><span style=display:flex><span>    pid <span style=color:#f92672>=</span> pid_index_to_str[pid_idx] <span style=color:#66d9ef>if</span> pid_idx <span style=color:#f92672>&lt;</span> len(pid_index_to_str) <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 플롯</span>
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>plot(true, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;True&#34;</span>, marker<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;o&#34;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>plot(pred, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Pred&#34;</span>, marker<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;x&#34;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>ylim(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>title(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;PID: </span><span style=color:#e6db74>{</span>pid<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>MED: </span><span style=color:#e6db74>{</span>med<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>MAE: </span><span style=color:#e6db74>{</span>mae<span style=color:#e6db74>:</span><span style=color:#e6db74>.2f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>tight_layout()
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>legend(loc<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;upper right&#34;</span>, bbox_to_anchor<span style=color:#f92672>=</span>(<span style=color:#ae81ff>1.2</span>, <span style=color:#ae81ff>1.05</span>))
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/1c11b019-9ec4-450d-85c5-c668c235c6d1 alt=image></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li><li><a href=#3>3.</a></li></ul></li></ul></nav></div></aside></main></body></html>