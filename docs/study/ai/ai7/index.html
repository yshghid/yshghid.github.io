<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  TFT #3 모델 학습
  #

#2025-07-23


  1. Load package
  #

import pytorch_lightning as pl
from pytorch_lightning.callbacks import EarlyStopping, LearningRateMonitor
from pytorch_lightning.loggers import TensorBoardLogger

from pytorch_forecasting import TimeSeriesDataSet
from pytorch_forecasting.models import TemporalFusionTransformer
from pytorch_forecasting.models.baseline import Baseline

from pytorch_forecasting.metrics import QuantileLoss
from pytorch_forecasting.metrics import MAE
from pytorch_forecasting.data import GroupNormalizer, NaNLabelEncoder

import numpy as np
import pandas as pd
import torch
import pickle
import matplotlib.pyplot as plt
#data
/data
└── Sequence.pkl

  2. Load data
  #

sequence = pd.read_pickle("/data/Sequence.pkl")
sequence


  3.
  #

# 예측 대상
target_variable = "NEWS"

# 시계열 길이
max_encoder_length = 7
max_prediction_length = 3
context_length = max_encoder_length + max_prediction_length

# 수치형 변수 목록 (merged_df 기준, 특수문자 제거된 이름 사용)
numeric_features = [
    &#39;WHO&#39;, &#39;SOFA&#39;, &#39;PBS&#39;, &#39;qPitt&#39;,
    &#39;ALT_U_L&#39;, &#39;AST_U_L&#39;, &#39;BUN_mg_dL&#39;, &#39;Creatinine_mg_dL&#39;, &#39;d_Dimer_ug_ml_FEU&#39;,
    &#39;Ferritin_ng_mL&#39;, &#39;HCO3_mmol_L&#39;, &#39;Hemoglobin_g_dL&#39;, &#39;LDH_U_L&#39;,
    &#39;Lymphocytes_pct&#39;, &#39;MDRD_eGFR_mL_min_BSA&#39;, &#39;Seg_neutrophils_pct&#39;,
    &#39;O2_Saturation_pct&#39;, &#39;PCO2_mmHg&#39;, &#39;PO2_mmHg&#39;, &#39;Platelet_count_10^3_uL&#39;,
    &#39;Potassium_mmol_L&#39;, &#39;Sodium_mmol_L&#39;, &#39;WBC_Count_10＾3_uL&#39;, &#39;CRP_mg_dL&#39;,
    &#39;pH_&#39;, &#39;total_CO2_mmol_L&#39;, &#39;med_cnt&#39;
]

# 범주형 변수
categorical_features = ["pid", "med"]

# 타입 정리
sequence["time_idx"] = sequence["time_idx"].astype(int)
sequence["pid"] = sequence["pid"].astype(str)
sequence["med"] = sequence["med"].astype(str)
sequence["group_id"] = sequence["group_id"].astype(str)

# 결측치 제거
sequence = sequence.dropna(subset=[target_variable, "time_idx", "pid"]).reset_index(drop=True)

# 유효한 group_id만 필터링 (10개 이상만 통과)
valid_groups = sequence.groupby("group_id")["time_idx"].count()
valid_groups = valid_groups[valid_groups >= context_length].index
filtered_df = sequence[sequence["group_id"].isin(valid_groups)].copy()

# TimeSeriesDataSet 정의
ts_dataset = TimeSeriesDataSet(
    data=filtered_df,
    time_idx="time_idx",
    target="NEWS",
    group_ids=["group_id"],

    max_encoder_length=7,
    max_prediction_length=3,

    static_categoricals=["pid"],
    time_varying_known_categoricals=["med"],
    time_varying_known_reals=["time_idx", "effective_med"],
    time_varying_unknown_reals=numeric_features,

    target_normalizer=GroupNormalizer(groups=["group_id"]),
    categorical_encoders={"med": NaNLabelEncoder(add_nan=True)},

    add_relative_time_idx=True,
    add_target_scales=True,
    add_encoder_length=True,

    allow_missing_timesteps=True,
)

# 검증용 데이터셋 (predict=True)
validation = TimeSeriesDataSet.from_dataset(
    ts_dataset, merged_df, predict=True, stop_randomization=True
)

# DataLoader 생성
batch_size = 128
train_dataloader = ts_dataset.to_dataloader(train=True, batch_size=batch_size, num_workers=0)
val_dataloader = validation.to_dataloader(train=False, batch_size=batch_size * 10, num_workers=0)

# Baseline 예측
baseline_model = Baseline()
y_pred = baseline_model.predict(val_dataloader)  # y는 별도로 저장되지 않음

# 실제 정답 y 추출 (val_dataloader에서 수동으로 추출해야 함)
actuals = torch.cat([y[0] for x, y in iter(val_dataloader)])  # y[0] = target 값

# MAE 계산
mae_score = MAE()(y_pred, actuals)
print(f"Baseline MAE: {mae_score:.4f}")
Baseline MAE: 1.2169
# configure network and trainer
pl.seed_everything(42)
trainer = pl.Trainer(
    accelerator="cpu",
    gradient_clip_val=0.1,
)


tft = TemporalFusionTransformer.from_dataset(
    ts_dataset,
    # not meaningful for finding the learning rate but otherwise very important
    learning_rate=0.03,
    hidden_size=8,  # most important hyperparameter apart from learning rate
    # number of attention heads. Set to up to 4 for large datasets
    attention_head_size=1,
    dropout=0.1,  # between 0.1 and 0.3 are good values
    hidden_continuous_size=8,  # set to <= hidden_size
    loss=QuantileLoss(),
    optimizer="adam",
    # reduce learning rate if no improvement in validation loss after x epochs
    # reduce_on_plateau_patience=1000,
)
print(f"Number of parameters in network: {tft.size() / 1e3:.1f}k")
Number of parameters in network: 65.3k
#학습률 계산

lr_finder = trainer.tuner.lr_find(
    model=tft,
    train_dataloaders=train_dataloader,
    val_dataloaders=val_dataloader,
    min_lr=1e-6,
    max_lr=10.0,
    num_training=100,
)


print(f"suggested learning rate: {lr_finder.suggestion()}")
fig = lr_finder.plot(show=True, suggest=True)
fig.show()
Finding best initial lr: 100%|██████████| 100/100 [00:46<00:00,  2.17it/s]
`Trainer.fit` stopped: `max_steps=100` reached.
suggested learning rate: 0.007079457843841384
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/ai/ai7/"><meta property="og:site_name" content=" "><meta property="og:title" content="TFT #3 모델 학습"><meta property="og:description" content='TFT #3 모델 학습 # #2025-07-23
1. Load package # import pytorch_lightning as pl from pytorch_lightning.callbacks import EarlyStopping, LearningRateMonitor from pytorch_lightning.loggers import TensorBoardLogger from pytorch_forecasting import TimeSeriesDataSet from pytorch_forecasting.models import TemporalFusionTransformer from pytorch_forecasting.models.baseline import Baseline from pytorch_forecasting.metrics import QuantileLoss from pytorch_forecasting.metrics import MAE from pytorch_forecasting.data import GroupNormalizer, NaNLabelEncoder import numpy as np import pandas as pd import torch import pickle import matplotlib.pyplot as plt #data
/data └── Sequence.pkl 2. Load data # sequence = pd.read_pickle("/data/Sequence.pkl") sequence 3. # # 예측 대상 target_variable = "NEWS" # 시계열 길이 max_encoder_length = 7 max_prediction_length = 3 context_length = max_encoder_length + max_prediction_length # 수치형 변수 목록 (merged_df 기준, 특수문자 제거된 이름 사용) numeric_features = [ &#39;WHO&#39;, &#39;SOFA&#39;, &#39;PBS&#39;, &#39;qPitt&#39;, &#39;ALT_U_L&#39;, &#39;AST_U_L&#39;, &#39;BUN_mg_dL&#39;, &#39;Creatinine_mg_dL&#39;, &#39;d_Dimer_ug_ml_FEU&#39;, &#39;Ferritin_ng_mL&#39;, &#39;HCO3_mmol_L&#39;, &#39;Hemoglobin_g_dL&#39;, &#39;LDH_U_L&#39;, &#39;Lymphocytes_pct&#39;, &#39;MDRD_eGFR_mL_min_BSA&#39;, &#39;Seg_neutrophils_pct&#39;, &#39;O2_Saturation_pct&#39;, &#39;PCO2_mmHg&#39;, &#39;PO2_mmHg&#39;, &#39;Platelet_count_10^3_uL&#39;, &#39;Potassium_mmol_L&#39;, &#39;Sodium_mmol_L&#39;, &#39;WBC_Count_10＾3_uL&#39;, &#39;CRP_mg_dL&#39;, &#39;pH_&#39;, &#39;total_CO2_mmol_L&#39;, &#39;med_cnt&#39; ] # 범주형 변수 categorical_features = ["pid", "med"] # 타입 정리 sequence["time_idx"] = sequence["time_idx"].astype(int) sequence["pid"] = sequence["pid"].astype(str) sequence["med"] = sequence["med"].astype(str) sequence["group_id"] = sequence["group_id"].astype(str) # 결측치 제거 sequence = sequence.dropna(subset=[target_variable, "time_idx", "pid"]).reset_index(drop=True) # 유효한 group_id만 필터링 (10개 이상만 통과) valid_groups = sequence.groupby("group_id")["time_idx"].count() valid_groups = valid_groups[valid_groups >= context_length].index filtered_df = sequence[sequence["group_id"].isin(valid_groups)].copy() # TimeSeriesDataSet 정의 ts_dataset = TimeSeriesDataSet( data=filtered_df, time_idx="time_idx", target="NEWS", group_ids=["group_id"], max_encoder_length=7, max_prediction_length=3, static_categoricals=["pid"], time_varying_known_categoricals=["med"], time_varying_known_reals=["time_idx", "effective_med"], time_varying_unknown_reals=numeric_features, target_normalizer=GroupNormalizer(groups=["group_id"]), categorical_encoders={"med": NaNLabelEncoder(add_nan=True)}, add_relative_time_idx=True, add_target_scales=True, add_encoder_length=True, allow_missing_timesteps=True, ) # 검증용 데이터셋 (predict=True) validation = TimeSeriesDataSet.from_dataset( ts_dataset, merged_df, predict=True, stop_randomization=True ) # DataLoader 생성 batch_size = 128 train_dataloader = ts_dataset.to_dataloader(train=True, batch_size=batch_size, num_workers=0) val_dataloader = validation.to_dataloader(train=False, batch_size=batch_size * 10, num_workers=0) # Baseline 예측 baseline_model = Baseline() y_pred = baseline_model.predict(val_dataloader) # y는 별도로 저장되지 않음 # 실제 정답 y 추출 (val_dataloader에서 수동으로 추출해야 함) actuals = torch.cat([y[0] for x, y in iter(val_dataloader)]) # y[0] = target 값 # MAE 계산 mae_score = MAE()(y_pred, actuals) print(f"Baseline MAE: {mae_score:.4f}") Baseline MAE: 1.2169 # configure network and trainer pl.seed_everything(42) trainer = pl.Trainer( accelerator="cpu", gradient_clip_val=0.1, ) tft = TemporalFusionTransformer.from_dataset( ts_dataset, # not meaningful for finding the learning rate but otherwise very important learning_rate=0.03, hidden_size=8, # most important hyperparameter apart from learning rate # number of attention heads. Set to up to 4 for large datasets attention_head_size=1, dropout=0.1, # between 0.1 and 0.3 are good values hidden_continuous_size=8, # set to <= hidden_size loss=QuantileLoss(), optimizer="adam", # reduce learning rate if no improvement in validation loss after x epochs # reduce_on_plateau_patience=1000, ) print(f"Number of parameters in network: {tft.size() / 1e3:.1f}k") Number of parameters in network: 65.3k #학습률 계산 lr_finder = trainer.tuner.lr_find( model=tft, train_dataloaders=train_dataloader, val_dataloaders=val_dataloader, min_lr=1e-6, max_lr=10.0, num_training=100, ) print(f"suggested learning rate: {lr_finder.suggestion()}") fig = lr_finder.plot(show=True, suggest=True) fig.show() Finding best initial lr: 100%|██████████| 100/100 [00:46<00:00, 2.17it/s] `Trainer.fit` stopped: `max_steps=100` reached. suggested learning rate: 0.007079457843841384'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-23T00:00:00+00:00"><meta property="article:tag" content="2025-07"><title>TFT #3 모델 학습 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/ai/ai7/><link rel=stylesheet href=/book.min.6217d077edb4189fd0578345e84bca1a884dfdee121ff8dc9a0f55cfe0852bc9.css integrity="sha256-YhfQd+20GJ/QV4NF6EvKGohN/e4SH/jcmg9Vz+CFK8k=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.578a2d8e6e30e0a0ae3682797882d89ca0cbbf1734d206705396ea76cf57bbb6.js integrity="sha256-V4otjm4w4KCuNoJ5eILYnKDLvxc00gZwU5bqds9Xu7Y=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/ai/>AI</a><ul></ul></li><li><a href=/docs/study/sw/>SW</a><ul></ul></li><li><a href=/docs/study/algorithm/>알고리즘</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>TFT #3 모델 학습</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li><li><a href=#3>3.</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=tft-3-모델-학습>TFT #3 모델 학습
<a class=anchor href=#tft-3-%eb%aa%a8%eb%8d%b8-%ed%95%99%ec%8a%b5>#</a></h1><p>#2025-07-23</p><hr><h3 id=1-load-package>1. Load package
<a class=anchor href=#1-load-package>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytorch_lightning</span> <span class=k>as</span> <span class=nn>pl</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_lightning.callbacks</span> <span class=kn>import</span> <span class=n>EarlyStopping</span><span class=p>,</span> <span class=n>LearningRateMonitor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_lightning.loggers</span> <span class=kn>import</span> <span class=n>TensorBoardLogger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting</span> <span class=kn>import</span> <span class=n>TimeSeriesDataSet</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.models</span> <span class=kn>import</span> <span class=n>TemporalFusionTransformer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.models.baseline</span> <span class=kn>import</span> <span class=n>Baseline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.metrics</span> <span class=kn>import</span> <span class=n>QuantileLoss</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.metrics</span> <span class=kn>import</span> <span class=n>MAE</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pytorch_forecasting.data</span> <span class=kn>import</span> <span class=n>GroupNormalizer</span><span class=p>,</span> <span class=n>NaNLabelEncoder</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span></code></pre></div><p>#data</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/data
</span></span><span class=line><span class=cl>└── Sequence.pkl
</span></span></code></pre></div><h3 id=2-load-data>2. Load data
<a class=anchor href=#2-load-data>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sequence</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_pickle</span><span class=p>(</span><span class=s2>&#34;/data/Sequence.pkl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span>
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/2dc80ef0-4da5-4d72-bf2d-4d7087b38b64 alt=image></p><h3 id=3>3.
<a class=anchor href=#3>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 예측 대상</span>
</span></span><span class=line><span class=cl><span class=n>target_variable</span> <span class=o>=</span> <span class=s2>&#34;NEWS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 시계열 길이</span>
</span></span><span class=line><span class=cl><span class=n>max_encoder_length</span> <span class=o>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>max_prediction_length</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>context_length</span> <span class=o>=</span> <span class=n>max_encoder_length</span> <span class=o>+</span> <span class=n>max_prediction_length</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 수치형 변수 목록 (merged_df 기준, 특수문자 제거된 이름 사용)</span>
</span></span><span class=line><span class=cl><span class=n>numeric_features</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;WHO&#39;</span><span class=p>,</span> <span class=s1>&#39;SOFA&#39;</span><span class=p>,</span> <span class=s1>&#39;PBS&#39;</span><span class=p>,</span> <span class=s1>&#39;qPitt&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;ALT_U_L&#39;</span><span class=p>,</span> <span class=s1>&#39;AST_U_L&#39;</span><span class=p>,</span> <span class=s1>&#39;BUN_mg_dL&#39;</span><span class=p>,</span> <span class=s1>&#39;Creatinine_mg_dL&#39;</span><span class=p>,</span> <span class=s1>&#39;d_Dimer_ug_ml_FEU&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Ferritin_ng_mL&#39;</span><span class=p>,</span> <span class=s1>&#39;HCO3_mmol_L&#39;</span><span class=p>,</span> <span class=s1>&#39;Hemoglobin_g_dL&#39;</span><span class=p>,</span> <span class=s1>&#39;LDH_U_L&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Lymphocytes_pct&#39;</span><span class=p>,</span> <span class=s1>&#39;MDRD_eGFR_mL_min_BSA&#39;</span><span class=p>,</span> <span class=s1>&#39;Seg_neutrophils_pct&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;O2_Saturation_pct&#39;</span><span class=p>,</span> <span class=s1>&#39;PCO2_mmHg&#39;</span><span class=p>,</span> <span class=s1>&#39;PO2_mmHg&#39;</span><span class=p>,</span> <span class=s1>&#39;Platelet_count_10^3_uL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Potassium_mmol_L&#39;</span><span class=p>,</span> <span class=s1>&#39;Sodium_mmol_L&#39;</span><span class=p>,</span> <span class=s1>&#39;WBC_Count_10＾3_uL&#39;</span><span class=p>,</span> <span class=s1>&#39;CRP_mg_dL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;pH_&#39;</span><span class=p>,</span> <span class=s1>&#39;total_CO2_mmol_L&#39;</span><span class=p>,</span> <span class=s1>&#39;med_cnt&#39;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 범주형 변수</span>
</span></span><span class=line><span class=cl><span class=n>categorical_features</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;pid&#34;</span><span class=p>,</span> <span class=s2>&#34;med&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 타입 정리</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;time_idx&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;time_idx&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;pid&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;pid&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;med&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;med&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;group_id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;group_id&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 결측치 제거</span>
</span></span><span class=line><span class=cl><span class=n>sequence</span> <span class=o>=</span> <span class=n>sequence</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=p>[</span><span class=n>target_variable</span><span class=p>,</span> <span class=s2>&#34;time_idx&#34;</span><span class=p>,</span> <span class=s2>&#34;pid&#34;</span><span class=p>])</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 유효한 group_id만 필터링 (10개 이상만 통과)</span>
</span></span><span class=line><span class=cl><span class=n>valid_groups</span> <span class=o>=</span> <span class=n>sequence</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s2>&#34;group_id&#34;</span><span class=p>)[</span><span class=s2>&#34;time_idx&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>valid_groups</span> <span class=o>=</span> <span class=n>valid_groups</span><span class=p>[</span><span class=n>valid_groups</span> <span class=o>&gt;=</span> <span class=n>context_length</span><span class=p>]</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl><span class=n>filtered_df</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=n>sequence</span><span class=p>[</span><span class=s2>&#34;group_id&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>valid_groups</span><span class=p>)]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TimeSeriesDataSet 정의</span>
</span></span><span class=line><span class=cl><span class=n>ts_dataset</span> <span class=o>=</span> <span class=n>TimeSeriesDataSet</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>filtered_df</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>time_idx</span><span class=o>=</span><span class=s2>&#34;time_idx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>=</span><span class=s2>&#34;NEWS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>group_ids</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;group_id&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>max_encoder_length</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_prediction_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>static_categoricals</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;pid&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>time_varying_known_categoricals</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;med&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>time_varying_known_reals</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;time_idx&#34;</span><span class=p>,</span> <span class=s2>&#34;effective_med&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>time_varying_unknown_reals</span><span class=o>=</span><span class=n>numeric_features</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>target_normalizer</span><span class=o>=</span><span class=n>GroupNormalizer</span><span class=p>(</span><span class=n>groups</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;group_id&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=n>categorical_encoders</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;med&#34;</span><span class=p>:</span> <span class=n>NaNLabelEncoder</span><span class=p>(</span><span class=n>add_nan</span><span class=o>=</span><span class=kc>True</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>add_relative_time_idx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>add_target_scales</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>add_encoder_length</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>allow_missing_timesteps</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 검증용 데이터셋 (predict=True)</span>
</span></span><span class=line><span class=cl><span class=n>validation</span> <span class=o>=</span> <span class=n>TimeSeriesDataSet</span><span class=o>.</span><span class=n>from_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>ts_dataset</span><span class=p>,</span> <span class=n>merged_df</span><span class=p>,</span> <span class=n>predict</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stop_randomization</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># DataLoader 생성</span>
</span></span><span class=line><span class=cl><span class=n>batch_size</span> <span class=o>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>train_dataloader</span> <span class=o>=</span> <span class=n>ts_dataset</span><span class=o>.</span><span class=n>to_dataloader</span><span class=p>(</span><span class=n>train</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>num_workers</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>val_dataloader</span> <span class=o>=</span> <span class=n>validation</span><span class=o>.</span><span class=n>to_dataloader</span><span class=p>(</span><span class=n>train</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span> <span class=o>*</span> <span class=mi>10</span><span class=p>,</span> <span class=n>num_workers</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Baseline 예측</span>
</span></span><span class=line><span class=cl><span class=n>baseline_model</span> <span class=o>=</span> <span class=n>Baseline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>y_pred</span> <span class=o>=</span> <span class=n>baseline_model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>val_dataloader</span><span class=p>)</span>  <span class=c1># y는 별도로 저장되지 않음</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실제 정답 y 추출 (val_dataloader에서 수동으로 추출해야 함)</span>
</span></span><span class=line><span class=cl><span class=n>actuals</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>y</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>iter</span><span class=p>(</span><span class=n>val_dataloader</span><span class=p>)])</span>  <span class=c1># y[0] = target 값</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MAE 계산</span>
</span></span><span class=line><span class=cl><span class=n>mae_score</span> <span class=o>=</span> <span class=n>MAE</span><span class=p>()(</span><span class=n>y_pred</span><span class=p>,</span> <span class=n>actuals</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Baseline MAE: </span><span class=si>{</span><span class=n>mae_score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Baseline MAE: 1.2169
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># configure network and trainer</span>
</span></span><span class=line><span class=cl><span class=n>pl</span><span class=o>.</span><span class=n>seed_everything</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>trainer</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>Trainer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>accelerator</span><span class=o>=</span><span class=s2>&#34;cpu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>gradient_clip_val</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tft</span> <span class=o>=</span> <span class=n>TemporalFusionTransformer</span><span class=o>.</span><span class=n>from_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>ts_dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># not meaningful for finding the learning rate but otherwise very important</span>
</span></span><span class=line><span class=cl>    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>0.03</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>hidden_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>  <span class=c1># most important hyperparameter apart from learning rate</span>
</span></span><span class=line><span class=cl>    <span class=c1># number of attention heads. Set to up to 4 for large datasets</span>
</span></span><span class=line><span class=cl>    <span class=n>attention_head_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dropout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>  <span class=c1># between 0.1 and 0.3 are good values</span>
</span></span><span class=line><span class=cl>    <span class=n>hidden_continuous_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>  <span class=c1># set to &lt;= hidden_size</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>=</span><span class=n>QuantileLoss</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=o>=</span><span class=s2>&#34;adam&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># reduce learning rate if no improvement in validation loss after x epochs</span>
</span></span><span class=line><span class=cl>    <span class=c1># reduce_on_plateau_patience=1000,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Number of parameters in network: </span><span class=si>{</span><span class=n>tft</span><span class=o>.</span><span class=n>size</span><span class=p>()</span> <span class=o>/</span> <span class=mf>1e3</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>k&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Number of parameters in network: 65.3k
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#학습률 계산</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lr_finder</span> <span class=o>=</span> <span class=n>trainer</span><span class=o>.</span><span class=n>tuner</span><span class=o>.</span><span class=n>lr_find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>tft</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>train_dataloaders</span><span class=o>=</span><span class=n>train_dataloader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>val_dataloaders</span><span class=o>=</span><span class=n>val_dataloader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>min_lr</span><span class=o>=</span><span class=mf>1e-6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_lr</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_training</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;suggested learning rate: </span><span class=si>{</span><span class=n>lr_finder</span><span class=o>.</span><span class=n>suggestion</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>lr_finder</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>show</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>suggest</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Finding best initial lr: 100%|██████████| 100/100 [00:46&lt;00:00,  2.17it/s]
</span></span><span class=line><span class=cl>`Trainer.fit` stopped: `max_steps=100` reached.
</span></span><span class=line><span class=cl>suggested learning rate: 0.007079457843841384
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/747b5393-4da9-4acc-b3c3-f55133ca8191 alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>early_stop_callback</span> <span class=o>=</span> <span class=n>EarlyStopping</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>monitor</span><span class=o>=</span><span class=s2>&#34;val_loss&#34;</span><span class=p>,</span> <span class=n>min_delta</span><span class=o>=</span><span class=mf>1e-4</span><span class=p>,</span> <span class=n>patience</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;min&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lr_logger</span> <span class=o>=</span> <span class=n>LearningRateMonitor</span><span class=p>()</span>  <span class=c1># log the learning rate</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>TensorBoardLogger</span><span class=p>(</span><span class=s2>&#34;lightning_logs&#34;</span><span class=p>)</span>  <span class=c1># logging results to a tensorboard</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>trainer</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>Trainer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>max_epochs</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>accelerator</span><span class=o>=</span><span class=s2>&#34;cpu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>enable_model_summary</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>gradient_clip_val</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>limit_train_batches</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>  <span class=c1># coment in for training, running valiation every 30 batches</span>
</span></span><span class=line><span class=cl>    <span class=n>callbacks</span><span class=o>=</span><span class=p>[</span><span class=n>lr_logger</span><span class=p>,</span> <span class=n>early_stop_callback</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>=</span><span class=n>logger</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tft</span> <span class=o>=</span> <span class=n>TemporalFusionTransformer</span><span class=o>.</span><span class=n>from_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>ts_dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding_sizes</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;med&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>140</span><span class=p>,</span> <span class=mi>25</span><span class=p>),</span> <span class=s1>&#39;pid&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>5688</span><span class=p>,</span> <span class=mi>100</span><span class=p>)},</span>  <span class=c1># ✅ 이렇게 넘겨줘야 함!</span>
</span></span><span class=line><span class=cl>    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>0.00708</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>hidden_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>attention_head_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dropout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>hidden_continuous_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>=</span><span class=n>QuantileLoss</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>log_interval</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=o>=</span><span class=s2>&#34;adam&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>reduce_on_plateau_patience</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Number of parameters in network: </span><span class=si>{</span><span class=n>tft</span><span class=o>.</span><span class=n>size</span><span class=p>()</span> <span class=o>/</span> <span class=mf>1e3</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>k&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Number of parameters in network: 65.3k
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>trainer</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>tft</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>train_dataloaders</span><span class=o>=</span><span class=n>train_dataloader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>val_dataloaders</span><span class=o>=</span><span class=n>val_dataloader</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>   | Name                               | Type                            | Params
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>0  | loss                               | QuantileLoss                    | 0     
</span></span><span class=line><span class=cl>1  | logging_metrics                    | ModuleList                      | 0     
</span></span><span class=line><span class=cl>2  | input_embeddings                   | MultiEmbedding                  | 46.6 K
</span></span><span class=line><span class=cl>3  | prescalers                         | ModuleDict                      | 528   
</span></span><span class=line><span class=cl>4  | static_variable_selection          | VariableSelectionNetwork        | 1.2 K 
</span></span><span class=line><span class=cl>5  | encoder_variable_selection         | VariableSelectionNetwork        | 12.5 K
</span></span><span class=line><span class=cl>6  | decoder_variable_selection         | VariableSelectionNetwork        | 1.2 K 
</span></span><span class=line><span class=cl>7  | static_context_variable_selection  | GatedResidualNetwork            | 304   
</span></span><span class=line><span class=cl>8  | static_context_initial_hidden_lstm | GatedResidualNetwork            | 304   
</span></span><span class=line><span class=cl>9  | static_context_initial_cell_lstm   | GatedResidualNetwork            | 304   
</span></span><span class=line><span class=cl>10 | static_context_enrichment          | GatedResidualNetwork            | 304   
</span></span><span class=line><span class=cl>11 | lstm_encoder                       | LSTM                            | 576   
</span></span><span class=line><span class=cl>12 | lstm_decoder                       | LSTM                            | 576   
</span></span><span class=line><span class=cl>13 | post_lstm_gate_encoder             | GatedLinearUnit                 | 144   
</span></span><span class=line><span class=cl>14 | post_lstm_add_norm_encoder         | AddNorm                         | 16    
</span></span><span class=line><span class=cl>15 | static_enrichment                  | GatedResidualNetwork            | 368   
</span></span><span class=line><span class=cl>16 | multihead_attn                     | InterpretableMultiHeadAttention | 280   
</span></span><span class=line><span class=cl>17 | post_attn_gate_norm                | GateAddNorm                     | 160   
</span></span><span class=line><span class=cl>18 | pos_wise_ff                        | GatedResidualNetwork            | 304   
</span></span><span class=line><span class=cl>19 | pre_output_gate_norm               | GateAddNorm                     | 160   
</span></span><span class=line><span class=cl>20 | output_layer                       | Linear                          | 63    
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>65.3 K    Trainable params
</span></span><span class=line><span class=cl>0         Non-trainable params
</span></span><span class=line><span class=cl>65.3 K    Total params
</span></span><span class=line><span class=cl>0.261     Total estimated model params size (MB)
</span></span><span class=line><span class=cl>Sanity Checking: 0it [00:00, ?it/s]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Epoch 0:  74%|███████▎  | 50/68 [00:22&lt;00:08,  2.21it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Validation: 0it [00:00, ?it/s]
</span></span><span class=line><span class=cl>Validation:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span class=line><span class=cl>Validation DataLoader 0:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span class=line><span class=cl>Epoch 0:  75%|███████▌  | 51/68 [00:23&lt;00:07,  2.15it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  76%|███████▋  | 52/68 [00:24&lt;00:07,  2.09it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  78%|███████▊  | 53/68 [00:26&lt;00:07,  2.02it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  79%|███████▉  | 54/68 [00:27&lt;00:07,  1.96it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  81%|████████  | 55/68 [00:29&lt;00:06,  1.89it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  82%|████████▏ | 56/68 [00:32&lt;00:06,  1.74it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  84%|████████▍ | 57/68 [00:33&lt;00:06,  1.71it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  85%|████████▌ | 58/68 [00:34&lt;00:05,  1.68it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  87%|████████▋ | 59/68 [00:36&lt;00:05,  1.63it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  88%|████████▊ | 60/68 [00:37&lt;00:04,  1.60it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  90%|████████▉ | 61/68 [00:38&lt;00:04,  1.57it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  91%|█████████ | 62/68 [00:40&lt;00:03,  1.54it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  93%|█████████▎| 63/68 [00:41&lt;00:03,  1.53it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  94%|█████████▍| 64/68 [00:42&lt;00:02,  1.51it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  96%|█████████▌| 65/68 [00:43&lt;00:02,  1.50it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  97%|█████████▋| 66/68 [00:44&lt;00:01,  1.48it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0:  99%|█████████▊| 67/68 [00:45&lt;00:00,  1.46it/s, loss=0.543, v_num=8, train_loss_step=0.582]
</span></span><span class=line><span class=cl>Epoch 0: 100%|██████████| 68/68 [00:47&lt;00:00,  1.44it/s, loss=0.543, v_num=8, train_loss_step=0.582, val_loss=0.524]
</span></span><span class=line><span class=cl>Epoch 1:  74%|███████▎  | 50/68 [00:22&lt;00:08,  2.22it/s, loss=0.531, v_num=8, train_loss_step=0.493, val_loss=0.524, train_loss_epoch=0.581]
</span></span><span class=line><span class=cl>Validation: 0it [00:00, ?it/s]
</span></span><span class=line><span class=cl>Validation:   0%|          | 0/18 [00:00&lt;?, ?it/s]
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Epoch 49:  96%|█████████▌| 65/68 [00:46&lt;00:02,  1.41it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span class=line><span class=cl>Epoch 49:  97%|█████████▋| 66/68 [00:47&lt;00:01,  1.39it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span class=line><span class=cl>Epoch 49:  99%|█████████▊| 67/68 [00:48&lt;00:00,  1.37it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.434, train_loss_epoch=0.453]
</span></span><span class=line><span class=cl>Epoch 49: 100%|██████████| 68/68 [00:49&lt;00:00,  1.36it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.453]
</span></span><span class=line><span class=cl>Epoch 49: 100%|██████████| 68/68 [00:49&lt;00:00,  1.36it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.444]
</span></span><span class=line><span class=cl>Output is truncated. View as a scrollable element or open in a text editor. Adjust cell output settings...
</span></span><span class=line><span class=cl>`Trainer.fit` stopped: `max_epochs=50` reached.
</span></span><span class=line><span class=cl>Epoch 49: 100%|██████████| 68/68 [00:50&lt;00:00,  1.35it/s, loss=0.446, v_num=8, train_loss_step=0.416, val_loss=0.431, train_loss_epoch=0.444]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>n_rows</span><span class=p>,</span> <span class=n>n_cols</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axs</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>n_rows</span><span class=p>,</span> <span class=n>n_cols</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plotted</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>idx</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>max_plots</span> <span class=o>=</span> <span class=n>n_rows</span> <span class=o>*</span> <span class=n>n_cols</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=n>plotted</span> <span class=o>&lt;</span> <span class=n>max_plots</span> <span class=ow>and</span> <span class=n>idx</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;decoder_target&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;decoder_target&#34;</span><span class=p>][</span><span class=n>idx</span><span class=p>]</span><span class=o>.</span><span class=n>detach</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>target</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span> <span class=ow>or</span> <span class=n>np</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>target</span> <span class=o>==</span> <span class=n>target</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ax</span> <span class=o>=</span> <span class=n>axs</span><span class=o>.</span><span class=n>flat</span><span class=p>[</span><span class=n>plotted</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>tft</span><span class=o>.</span><span class=n>plot_prediction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_predictions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span><span class=o>=</span><span class=n>idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>add_loss_to_title</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>=</span><span class=n>ax</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>plotted</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>] 예측 시각화 중 오류 발생: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/a853fe73-f5dc-49a6-91d9-0a0273c4d238 alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 예측 결과 시각화: y축을 고정하여 개별 출력</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span> <span class=mi>21</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span>  <span class=c1># 각 그래프는 개별로</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tft</span><span class=o>.</span><span class=n>plot_prediction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_predictions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span><span class=o>=</span><span class=n>idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>add_loss_to_title</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ax</span><span class=o>=</span><span class=n>ax</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>  <span class=c1># y축 범위 고정 (원하는 범위로 수정 가능)</span>
</span></span><span class=line><span class=cl>        <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>] 예측 시각화 중 오류 발생: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/408b7342-1e80-4b8a-83f5-ec86e55ff3b0 alt=image>
<img src=https://github.com/user-attachments/assets/0b205eaa-9cad-4a36-b876-1420c7b819a1 alt=image>
<img src=https://github.com/user-attachments/assets/ab685d82-a121-41ca-a623-e4214c2938d7 alt=image>
<img src=https://github.com/user-attachments/assets/509c4721-fa37-4c17-b079-eba584602f7e alt=image>
<img src=https://github.com/user-attachments/assets/39d98517-482e-4d3e-ad28-1058b855329c alt=image>
<img src=https://github.com/user-attachments/assets/3c3f27d7-2569-4b73-873c-10dc7e7e2b97 alt=image>
<img src=https://github.com/user-attachments/assets/4dd58b53-12f9-4e0c-a2e0-3c3e631ec824 alt=image>
<img src=https://github.com/user-attachments/assets/9a89cacd-66b1-4f1d-9c83-5534d275cb56 alt=image>
<img src=https://github.com/user-attachments/assets/041525c9-1e8f-4637-a406-ee2bce5af35a alt=image>
<img src=https://github.com/user-attachments/assets/e0e967eb-31a4-457e-b104-b54491c1facd alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>raw_predictions</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>raw_predictions</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>item</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>raw_predictions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>] type: </span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;예측 길이:&#34;</span><span class=p>,</span> <span class=n>ts_dataset</span><span class=o>.</span><span class=n>max_prediction_length</span><span class=p>)</span>  <span class=c1># 3이어야 함</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 예측 결과에서 예측값만 추출</span>
</span></span><span class=line><span class=cl><span class=n>y_hat</span> <span class=o>=</span> <span class=n>raw_predictions</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 예측값 shape 확인</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;y_hat shape:&#34;</span><span class=p>,</span> <span class=n>y_hat</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>  <span class=c1># 예상: (batch_size, target_dim=1, prediction_length=3)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>&lt;class &#39;pytorch_forecasting.utils.TupleOutputMixIn.to_network_output.&lt;locals&gt;.Output&#39;&gt;
</span></span><span class=line><span class=cl>8
</span></span><span class=line><span class=cl>[0] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[1] type: &lt;class &#39;list&#39;&gt;
</span></span><span class=line><span class=cl>[2] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[3] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[4] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[5] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[6] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>[7] type: &lt;class &#39;torch.Tensor&#39;&gt;
</span></span><span class=line><span class=cl>예측 길이: 3
</span></span><span class=line><span class=cl>y_hat shape: torch.Size([23001, 3, 7])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 인코딩된 항생제 정보 확인</span>
</span></span><span class=line><span class=cl><span class=n>ts_dataset</span><span class=o>.</span><span class=n>get_parameters</span><span class=p>()[</span><span class=s2>&#34;categorical_encoders&#34;</span><span class=p>][</span><span class=s2>&#34;med&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>classes_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dict 방향 뒤집기</span>
</span></span><span class=line><span class=cl><span class=n>med_index_to_str</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>med_index_to_str</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 인코더 정보 가져오기</span>
</span></span><span class=line><span class=cl><span class=n>cat_encoders</span> <span class=o>=</span> <span class=n>ts_dataset</span><span class=o>.</span><span class=n>get_parameters</span><span class=p>()[</span><span class=s2>&#34;categorical_encoders&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># med 클래스: str → int 형태라면 → dict 뒤집기</span>
</span></span><span class=line><span class=cl><span class=n>med_index_to_str</span> <span class=o>=</span> <span class=n>cat_encoders</span><span class=p>[</span><span class=s2>&#34;med&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>classes_</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>med_index_to_str</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>list</span><span class=p>(</span><span class=n>med_index_to_str</span><span class=o>.</span><span class=n>values</span><span class=p>())[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=p>:</span>  <span class=c1># int 값이면 → 뒤집기</span>
</span></span><span class=line><span class=cl>        <span class=n>med_index_to_str</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>med_index_to_str</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># med가 categorical feature 몇 번째인지 확인</span>
</span></span><span class=line><span class=cl><span class=n>cat_features</span> <span class=o>=</span> <span class=n>ts_dataset</span><span class=o>.</span><span class=n>categoricals</span>
</span></span><span class=line><span class=cl><span class=n>med_index</span> <span class=o>=</span> <span class=n>cat_features</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;med&#34;</span><span class=p>)</span>  <span class=c1># 예: 1번</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 예측 구간에서 med 인덱스 가져오기</span>
</span></span><span class=line><span class=cl><span class=n>future_med_indices</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=s1>&#39;decoder_cat&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>,</span> <span class=p>:,</span> <span class=n>med_index</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 인덱스 → 약물이름</span>
</span></span><span class=line><span class=cl><span class=n>future_med_names</span> <span class=o>=</span> <span class=p>[</span><span class=n>med_index_to_str</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>idx</span><span class=p>),</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>future_med_indices</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;예측 구간의 항생제:&#34;</span><span class=p>,</span> <span class=n>future_med_names</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>예측 구간의 항생제: [&#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>  <span class=c1># 첫 5개 시퀀스</span>
</span></span><span class=line><span class=cl>    <span class=n>meds</span> <span class=o>=</span> <span class=p>[</span><span class=n>med_index_to_str</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>idx</span><span class=p>),</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>x</span><span class=p>[</span><span class=s1>&#39;decoder_cat&#39;</span><span class=p>][</span><span class=n>i</span><span class=p>,</span> <span class=p>:,</span> <span class=n>med_index</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;#</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> 예측 구간 항생제:&#34;</span><span class=p>,</span> <span class=n>meds</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>#0 예측 구간 항생제: [&#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;, &#39;Cefotaxime&#39;]
</span></span><span class=line><span class=cl>#1 예측 구간 항생제: [&#39;Remdesivir&#39;, &#39;Remdesivir&#39;, &#39;Remdesivir&#39;]
</span></span><span class=line><span class=cl>#2 예측 구간 항생제: [&#39;Tazocin&#39;, &#39;Tazocin&#39;, &#39;Tazocin&#39;]
</span></span><span class=line><span class=cl>#3 예측 구간 항생제: [&#39;Hanomycin&#39;, &#39;Hanomycin&#39;, &#39;Hanomycin&#39;]
</span></span><span class=line><span class=cl>#4 예측 구간 항생제: [&#39;Meropen&#39;, &#39;Meropen&#39;, &#39;Meropen&#39;]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 예측 수행 (validation 데이터셋 대상)</span>
</span></span><span class=line><span class=cl><span class=n>raw_predictions</span><span class=p>,</span> <span class=n>x</span> <span class=o>=</span> <span class=n>tft</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>val_dataloader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;raw&#34;</span><span class=p>,</span>       <span class=c1># 예측값 전체를 출력 (raw tensor)</span>
</span></span><span class=line><span class=cl>    <span class=n>return_x</span><span class=o>=</span><span class=kc>True</span>     <span class=c1># 입력 데이터도 함께 반환</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 디코딩용 인덱스</span>
</span></span><span class=line><span class=cl><span class=n>med_index_to_str</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>ts_dataset</span><span class=o>.</span><span class=n>get_parameters</span><span class=p>()[</span><span class=s2>&#34;categorical_encoders&#34;</span><span class=p>][</span><span class=s2>&#34;med&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>classes_</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pid_index_to_str</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>ts_dataset</span><span class=o>.</span><span class=n>get_parameters</span><span class=p>()[</span><span class=s2>&#34;categorical_encoders&#34;</span><span class=p>][</span><span class=s2>&#34;pid&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>classes_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 예측 및 실제값</span>
</span></span><span class=line><span class=cl><span class=n>preds</span> <span class=o>=</span> <span class=n>raw_predictions</span><span class=p>[</span><span class=s2>&#34;prediction&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>detach</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()[:,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>targets</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;decoder_target&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>detach</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 인덱스 추출</span>
</span></span><span class=line><span class=cl><span class=n>med_indices</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;decoder_cat&#34;</span><span class=p>][:,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>int</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>pid_indices</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;groups&#34;</span><span class=p>][:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>int</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>maes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>preds</span> <span class=o>-</span> <span class=n>targets</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 시각화</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl><span class=n>ncols</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>nrows</span> <span class=o>=</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=n>ncols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=n>ncols</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=n>ncols</span> <span class=o>*</span> <span class=mi>4</span><span class=p>,</span> <span class=n>nrows</span> <span class=o>*</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=n>nrows</span><span class=p>,</span> <span class=n>ncols</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>true</span> <span class=o>=</span> <span class=n>targets</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>pred</span> <span class=o>=</span> <span class=n>preds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>mae</span> <span class=o>=</span> <span class=n>maes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># med 및 pid 인덱스를 문자열로 변환</span>
</span></span><span class=line><span class=cl>    <span class=n>med_idx</span> <span class=o>=</span> <span class=n>med_indices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>med</span> <span class=o>=</span> <span class=n>med_index_to_str</span><span class=p>[</span><span class=n>med_idx</span><span class=p>]</span> <span class=k>if</span> <span class=n>med_idx</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>med_index_to_str</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;UNKNOWN&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>pid_idx</span> <span class=o>=</span> <span class=n>pid_indices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>pid</span> <span class=o>=</span> <span class=n>pid_index_to_str</span><span class=p>[</span><span class=n>pid_idx</span><span class=p>]</span> <span class=k>if</span> <span class=n>pid_idx</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>pid_index_to_str</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;UNKNOWN&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 플롯</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>true</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;True&#34;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s2>&#34;o&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Pred&#34;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s2>&#34;x&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;PID: </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=se>\n</span><span class=s2>MED: </span><span class=si>{</span><span class=n>med</span><span class=si>}</span><span class=se>\n</span><span class=s2>MAE: </span><span class=si>{</span><span class=n>mae</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper right&#34;</span><span class=p>,</span> <span class=n>bbox_to_anchor</span><span class=o>=</span><span class=p>(</span><span class=mf>1.2</span><span class=p>,</span> <span class=mf>1.05</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p><img src=https://github.com/user-attachments/assets/1c11b019-9ec4-450d-85c5-c668c235c6d1 alt=image></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-load-package>1. Load package</a></li><li><a href=#2-load-data>2. Load data</a></li><li><a href=#3>3.</a></li></ul></li></ul></nav></div></aside></main></body></html>