<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드
  #

#2026-02-08


  🏥 VitalTime - Database 구축 포트폴리오
  #


  프로젝트 개요
  #

AI 기반 환자 전원 의뢰 시스템의 데이터베이스를 설계하고 구축한 프로젝트입니다.
PostgreSQL 14와 SQLAlchemy 2.0 비동기 ORM을 활용하여 시계열 임상 데이터를 저장하고, LATERAL JOIN 기반의 예측 NEWS Score 조회 및 LSTM 모델 학습 파이프라인을 구현했습니다.

  
      
          항목
          내용
      
  
  
      
          프로젝트 기간
          2025년
      
      
          역할
          Database Engineer / Backend Developer
      
      
          기술 스택
          PostgreSQL 14, SQLAlchemy 2.0 (Async), asyncpg, FastAPI
      
      
          프로젝트 유형
          Healthcare / Medical System
      
  



  📋 목차
  #


기술적 의사결정
데이터베이스 아키텍처
스키마 설계
시계열 데이터 처리
ORM 및 비동기 처리
API 엔드포인트 설계
ML 파이프라인 통합
성능 최적화
문제 해결 사례
프로젝트 성과



  1. 기술적 의사결정
  #


  1.1 데이터베이스 선정 근거
  #


  PostgreSQL 14
  #

선정 이유:
├── 의료 데이터의 ACID 트랜잭션 보장 (환자 안전 필수)
├── 시계열 데이터 처리에 강력한 날짜/시간 함수 지원
├── LATERAL JOIN으로 복잡한 시계열 예측 조회 구현
├── DATE_TRUNC, INTERVAL 등 시간 연산 네이티브 지원
└── 비동기 드라이버 (asyncpg) 지원으로 실시간 모니터링 가능

  대안 비교 분석
  #


  
      
          데이터베이스
          시계열 지원
          LATERAL JOIN
          비동기 지원
          의료 표준
          비용
      
  
  
      
          PostgreSQL 14
          ✅ 네이티브
          ✅ 지원
          ✅ asyncpg
          ✅ HIPAA 호환
          무료
      
      
          TimescaleDB
          ✅✅ 전용
          ✅ 지원
          ✅ asyncpg
          ✅
          유료
      
      
          InfluxDB
          ✅✅ 전용
          ❌ 없음
          ⚠️ 제한적
          ⚠️
          유료
      
      
          MySQL 8
          ⚠️ 제한적
          ✅ 지원
          ✅ aiomysql
          ✅
          무료
      
      
          MongoDB
          ⚠️ 제한적
          ❌ 없음
          ✅ Motor
          ⚠️
          무료
      
  

최종 선정: PostgreSQL 14"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/be/portfolio_vitaltime_db/"><meta property="og:site_name" content=" "><meta property="og:title" content="AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드"><meta property="og:description" content="AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드 # #2026-02-08
🏥 VitalTime - Database 구축 포트폴리오 # 프로젝트 개요 # AI 기반 환자 전원 의뢰 시스템의 데이터베이스를 설계하고 구축한 프로젝트입니다. PostgreSQL 14와 SQLAlchemy 2.0 비동기 ORM을 활용하여 시계열 임상 데이터를 저장하고, LATERAL JOIN 기반의 예측 NEWS Score 조회 및 LSTM 모델 학습 파이프라인을 구현했습니다.
항목 내용 프로젝트 기간 2025년 역할 Database Engineer / Backend Developer 기술 스택 PostgreSQL 14, SQLAlchemy 2.0 (Async), asyncpg, FastAPI 프로젝트 유형 Healthcare / Medical System 📋 목차 # 기술적 의사결정 데이터베이스 아키텍처 스키마 설계 시계열 데이터 처리 ORM 및 비동기 처리 API 엔드포인트 설계 ML 파이프라인 통합 성능 최적화 문제 해결 사례 프로젝트 성과 1. 기술적 의사결정 # 1.1 데이터베이스 선정 근거 # PostgreSQL 14 # 선정 이유: ├── 의료 데이터의 ACID 트랜잭션 보장 (환자 안전 필수) ├── 시계열 데이터 처리에 강력한 날짜/시간 함수 지원 ├── LATERAL JOIN으로 복잡한 시계열 예측 조회 구현 ├── DATE_TRUNC, INTERVAL 등 시간 연산 네이티브 지원 └── 비동기 드라이버 (asyncpg) 지원으로 실시간 모니터링 가능 대안 비교 분석 # 데이터베이스 시계열 지원 LATERAL JOIN 비동기 지원 의료 표준 비용 PostgreSQL 14 ✅ 네이티브 ✅ 지원 ✅ asyncpg ✅ HIPAA 호환 무료 TimescaleDB ✅✅ 전용 ✅ 지원 ✅ asyncpg ✅ 유료 InfluxDB ✅✅ 전용 ❌ 없음 ⚠️ 제한적 ⚠️ 유료 MySQL 8 ⚠️ 제한적 ✅ 지원 ✅ aiomysql ✅ 무료 MongoDB ⚠️ 제한적 ❌ 없음 ✅ Motor ⚠️ 무료 최종 선정: PostgreSQL 14"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2026-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-08T00:00:00+00:00"><meta property="article:tag" content="2026-02"><title>AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/be/portfolio_vitaltime_db/><link rel=stylesheet href=/book.min.30a7836b6a89342da3b88e7afd1036166aeced16c8de12df060ded2031837886.css integrity="sha256-MKeDa2qJNC2juI56/RA2Fmrs7RbI3hLfBg3tIDGDeIY=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.349ca1e9b40cafda617a5f46a3bcc7eb633fb9d8242e67829c5a4bdde6ca1730.js integrity="sha256-NJyh6bQMr9phel9Go7zH62M/udgkLmeCnFpL3ebKFzA=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/ai/>AI/Data</a><ul></ul></li><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/be/>BE</a><ul></ul></li><li><a href=/docs/study/fe/>FE</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#프로젝트-개요>프로젝트 개요</a></li><li><a href=#-목차>📋 목차</a></li><li><a href=#1-기술적-의사결정>1. 기술적 의사결정</a><ul><li><a href=#11-데이터베이스-선정-근거>1.1 데이터베이스 선정 근거</a></li><li><a href=#12-orm-및-드라이버-선정>1.2 ORM 및 드라이버 선정</a></li><li><a href=#13-aiml-모델-선정>1.3 AI/ML 모델 선정</a></li></ul></li><li><a href=#2-데이터베이스-아키텍처>2. 데이터베이스 아키텍처</a><ul><li><a href=#21-프로젝트-디렉토리-구조>2.1 프로젝트 디렉토리 구조</a></li><li><a href=#22-전체-시스템-아키텍처>2.2 전체 시스템 아키텍처</a></li><li><a href=#23-데이터-흐름>2.3 데이터 흐름</a></li><li><a href=#24-erd-entity-relationship-diagram>2.4 ERD (Entity Relationship Diagram)</a></li></ul></li><li><a href=#3-스키마-설계>3. 스키마 설계</a><ul><li><a href=#31-테이블-정의>3.1 테이블 정의</a></li><li><a href=#32-시계열-데이터-구조-설계>3.2 시계열 데이터 구조 설계</a></li><li><a href=#33-초기-데이터-구성>3.3 초기 데이터 구성</a></li></ul></li><li><a href=#4-시계열-데이터-처리>4. 시계열 데이터 처리</a><ul><li><a href=#41-lateral-join-기반-예측값-조회>4.1 LATERAL JOIN 기반 예측값 조회</a></li><li><a href=#42-date_trunc-기반-예측값-조회>4.2 DATE_TRUNC 기반 예측값 조회</a></li><li><a href=#43-시간-범위-임상-데이터-조회>4.3 시간 범위 임상 데이터 조회</a></li><li><a href=#44-통계-집계-pandas-연동>4.4 통계 집계 (Pandas 연동)</a></li></ul></li><li><a href=#5-orm-및-비동기-처리>5. ORM 및 비동기 처리</a><ul><li><a href=#51-sqlalchemy-비동기-설정>5.1 SQLAlchemy 비동기 설정</a></li><li><a href=#52-의존성-주입-패턴>5.2 의존성 주입 패턴</a></li><li><a href=#53-생명주기-관리>5.3 생명주기 관리</a></li><li><a href=#54-raw-sql-선택-근거>5.4 Raw SQL 선택 근거</a></li></ul></li><li><a href=#6-api-엔드포인트-설계>6. API 엔드포인트 설계</a><ul><li><a href=#61-엔드포인트-구조>6.1 엔드포인트 구조</a></li><li><a href=#62-주요-엔드포인트-구현>6.2 주요 엔드포인트 구현</a></li><li><a href=#63-pydantic-스키마>6.3 Pydantic 스키마</a></li><li><a href=#64-api-모니터링-미들웨어>6.4 API 모니터링 미들웨어</a></li></ul></li><li><a href=#7-ml-파이프라인-통합>7. ML 파이프라인 통합</a><ul><li><a href=#71-lstm-모델-학습-파이프라인>7.1 LSTM 모델 학습 파이프라인</a></li><li><a href=#72-데이터-파이프라인-구조>7.2 데이터 파이프라인 구조</a></li><li><a href=#73-주기적-학습-스케줄러>7.3 주기적 학습 스케줄러</a></li><li><a href=#74-llm-전원-의뢰서-생성>7.4 LLM 전원 의뢰서 생성</a></li></ul></li><li><a href=#8-성능-최적화>8. 성능 최적화</a><ul><li><a href=#81-인덱스-전략>8.1 인덱스 전략</a></li><li><a href=#82-쿼리-최적화>8.2 쿼리 최적화</a></li><li><a href=#83-연결-관리>8.3 연결 관리</a></li><li><a href=#84-타임존-처리-최적화>8.4 타임존 처리 최적화</a></li><li><a href=#85-성능-측정-결과>8.5 성능 측정 결과</a></li></ul></li><li><a href=#9-문제-해결-사례>9. 문제 해결 사례</a><ul><li><a href=#91-타임존timezone-불일치-문제>9.1 타임존(Timezone) 불일치 문제</a></li><li><a href=#92-lateral-join-null-처리>9.2 LATERAL JOIN NULL 처리</a></li><li><a href=#93-비동기-세션-미초기화-오류>9.3 비동기 세션 미초기화 오류</a></li><li><a href=#94-lstm-학습-시-비동기동기-충돌>9.4 LSTM 학습 시 비동기/동기 충돌</a></li><li><a href=#95-date_trunc-시간-비교-정밀도-문제>9.5 DATE_TRUNC 시간 비교 정밀도 문제</a></li></ul></li><li><a href=#10-프로젝트-성과>10. 프로젝트 성과</a><ul><li><a href=#101-기술적-성과>10.1 기술적 성과</a></li><li><a href=#102-데이터-구조-성과>10.2 데이터 구조 성과</a></li><li><a href=#103-api-성능-지표>10.3 API 성능 지표</a></li><li><a href=#104-학습-및-성장>10.4 학습 및 성장</a></li></ul></li><li><a href=#-부록>📎 부록</a><ul><li><a href=#a-실행-방법>A. 실행 방법</a></li><li><a href=#b-데이터베이스-접속>B. 데이터베이스 접속</a></li><li><a href=#c-유용한-sql-쿼리>C. 유용한 SQL 쿼리</a></li><li><a href=#d-의존성-목록>D. 의존성 목록</a></li><li><a href=#e-관련-링크>E. 관련 링크</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=aws-5-silok-프로젝트-ecs-파이프라인-빌드>AWS #5 SiLok 프로젝트 ECS 파이프라인 빌드
<a class=anchor href=#aws-5-silok-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-ecs-%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8-%eb%b9%8c%eb%93%9c>#</a></h1><p>#2026-02-08</p><hr><h1 id=-vitaltime---database-구축-포트폴리오>🏥 VitalTime - Database 구축 포트폴리오
<a class=anchor href=#-vitaltime---database-%ea%b5%ac%ec%b6%95-%ed%8f%ac%ed%8a%b8%ed%8f%b4%eb%a6%ac%ec%98%a4>#</a></h1><h2 id=프로젝트-개요>프로젝트 개요
<a class=anchor href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ea%b0%9c%ec%9a%94>#</a></h2><p><strong>AI 기반 환자 전원 의뢰 시스템</strong>의 데이터베이스를 설계하고 구축한 프로젝트입니다.
PostgreSQL 14와 SQLAlchemy 2.0 비동기 ORM을 활용하여 시계열 임상 데이터를 저장하고, LATERAL JOIN 기반의 예측 NEWS Score 조회 및 LSTM 모델 학습 파이프라인을 구현했습니다.</p><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>프로젝트 기간</strong></td><td>2025년</td></tr><tr><td><strong>역할</strong></td><td>Database Engineer / Backend Developer</td></tr><tr><td><strong>기술 스택</strong></td><td>PostgreSQL 14, SQLAlchemy 2.0 (Async), asyncpg, FastAPI</td></tr><tr><td><strong>프로젝트 유형</strong></td><td>Healthcare / Medical System</td></tr></tbody></table><hr><h2 id=-목차>📋 목차
<a class=anchor href=#-%eb%aa%a9%ec%b0%a8>#</a></h2><ol><li><a href=#1-%ea%b8%b0%ec%88%a0%ec%a0%81-%ec%9d%98%ec%82%ac%ea%b2%b0%ec%a0%95>기술적 의사결정</a></li><li><a href=#2-%eb%8d%b0%ec%9d%b4%ed%84%b0%eb%b2%a0%ec%9d%b4%ec%8a%a4-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98>데이터베이스 아키텍처</a></li><li><a href=#3-%ec%8a%a4%ed%82%a4%eb%a7%88-%ec%84%a4%ea%b3%84>스키마 설계</a></li><li><a href=#4-%ec%8b%9c%ea%b3%84%ec%97%b4-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%b2%98%eb%a6%ac>시계열 데이터 처리</a></li><li><a href=#5-orm-%eb%b0%8f-%eb%b9%84%eb%8f%99%ea%b8%b0-%ec%b2%98%eb%a6%ac>ORM 및 비동기 처리</a></li><li><a href=#6-api-%ec%97%94%eb%93%9c%ed%8f%ac%ec%9d%b8%ed%8a%b8-%ec%84%a4%ea%b3%84>API 엔드포인트 설계</a></li><li><a href=#7-ml-%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8-%ed%86%b5%ed%95%a9>ML 파이프라인 통합</a></li><li><a href=#8-%ec%84%b1%eb%8a%a5-%ec%b5%9c%ec%a0%81%ed%99%94>성능 최적화</a></li><li><a href=#9-%eb%ac%b8%ec%a0%9c-%ed%95%b4%ea%b2%b0-%ec%82%ac%eb%a1%80>문제 해결 사례</a></li><li><a href=#10-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ec%84%b1%ea%b3%bc>프로젝트 성과</a></li></ol><hr><h2 id=1-기술적-의사결정>1. 기술적 의사결정
<a class=anchor href=#1-%ea%b8%b0%ec%88%a0%ec%a0%81-%ec%9d%98%ec%82%ac%ea%b2%b0%ec%a0%95>#</a></h2><h3 id=11-데이터베이스-선정-근거>1.1 데이터베이스 선정 근거
<a class=anchor href=#11-%eb%8d%b0%ec%9d%b4%ed%84%b0%eb%b2%a0%ec%9d%b4%ec%8a%a4-%ec%84%a0%ec%a0%95-%ea%b7%bc%ea%b1%b0>#</a></h3><h4 id=postgresql-14>PostgreSQL 14
<a class=anchor href=#postgresql-14>#</a></h4><pre tabindex=0><code>선정 이유:
├── 의료 데이터의 ACID 트랜잭션 보장 (환자 안전 필수)
├── 시계열 데이터 처리에 강력한 날짜/시간 함수 지원
├── LATERAL JOIN으로 복잡한 시계열 예측 조회 구현
├── DATE_TRUNC, INTERVAL 등 시간 연산 네이티브 지원
└── 비동기 드라이버 (asyncpg) 지원으로 실시간 모니터링 가능
</code></pre><h4 id=대안-비교-분석>대안 비교 분석
<a class=anchor href=#%eb%8c%80%ec%95%88-%eb%b9%84%ea%b5%90-%eb%b6%84%ec%84%9d>#</a></h4><table><thead><tr><th>데이터베이스</th><th>시계열 지원</th><th>LATERAL JOIN</th><th>비동기 지원</th><th>의료 표준</th><th>비용</th></tr></thead><tbody><tr><td><strong>PostgreSQL 14</strong></td><td>✅ 네이티브</td><td>✅ 지원</td><td>✅ asyncpg</td><td>✅ HIPAA 호환</td><td>무료</td></tr><tr><td>TimescaleDB</td><td>✅✅ 전용</td><td>✅ 지원</td><td>✅ asyncpg</td><td>✅</td><td>유료</td></tr><tr><td>InfluxDB</td><td>✅✅ 전용</td><td>❌ 없음</td><td>⚠️ 제한적</td><td>⚠️</td><td>유료</td></tr><tr><td>MySQL 8</td><td>⚠️ 제한적</td><td>✅ 지원</td><td>✅ aiomysql</td><td>✅</td><td>무료</td></tr><tr><td>MongoDB</td><td>⚠️ 제한적</td><td>❌ 없음</td><td>✅ Motor</td><td>⚠️</td><td>무료</td></tr></tbody></table><p><strong>최종 선정:</strong> PostgreSQL 14</p><ul><li>시계열 확장 없이도 DATE_TRUNC, INTERVAL로 시간 연산 충분</li><li>LATERAL JOIN으로 다음 시점 예측값 조회 구현 가능</li><li>의료 데이터의 관계 무결성 (FK CASCADE) 보장</li><li>별도 시계열 DB 도입 비용 및 복잡도 절감</li></ul><h3 id=12-orm-및-드라이버-선정>1.2 ORM 및 드라이버 선정
<a class=anchor href=#12-orm-%eb%b0%8f-%eb%93%9c%eb%9d%bc%ec%9d%b4%eb%b2%84-%ec%84%a0%ec%a0%95>#</a></h3><h4 id=sqlalchemy-20-async>SQLAlchemy 2.0 (Async)
<a class=anchor href=#sqlalchemy-20-async>#</a></h4><pre tabindex=0><code>선정 이유:
├── Python 생태계 표준 ORM
├── 비동기 세션 지원 (AsyncSession)
├── FastAPI 의존성 주입 패턴과 완벽한 호환
├── text() 함수로 복잡한 Raw SQL 안전 실행
└── 연결 풀 관리 내장 (pool_size, max_overflow)
</code></pre><h4 id=asyncpg-vs-psycopg2>asyncpg vs psycopg2
<a class=anchor href=#asyncpg-vs-psycopg2>#</a></h4><table><thead><tr><th>비교 항목</th><th>asyncpg</th><th>psycopg2</th></tr></thead><tbody><tr><td>동기/비동기</td><td>비동기</td><td>동기</td></tr><tr><td>성능 (TPS)</td><td>~50,000</td><td>~20,000</td></tr><tr><td>연결 풀링</td><td>내장</td><td>외부 필요</td></tr><tr><td>FastAPI 호환</td><td>✅ 완벽</td><td>⚠️ 블로킹</td></tr><tr><td>실시간 모니터링</td><td>✅ 적합</td><td>❌ 부적합</td></tr></tbody></table><p><strong>선정:</strong> asyncpg - 실시간 환자 모니터링에 필수적인 비동기 I/O 지원</p><h3 id=13-aiml-모델-선정>1.3 AI/ML 모델 선정
<a class=anchor href=#13-aiml-%eb%aa%a8%eb%8d%b8-%ec%84%a0%ec%a0%95>#</a></h3><h4 id=lstm-long-short-term-memory>LSTM (Long Short-Term Memory)
<a class=anchor href=#lstm-long-short-term-memory>#</a></h4><pre tabindex=0><code>선정 이유:
├── 시계열 임상 데이터의 패턴 학습에 최적
├── 환자별 10개 시점 데이터의 순차적 의존성 포착
├── 9개 생체 지표 → NEWS Score 예측 가능
├── TensorFlow/Keras로 빠른 프로토타이핑
└── 주기적 재학습 (8시간 간격) 지원
</code></pre><h4 id=llm-전원-의뢰서-생성>LLM (전원 의뢰서 생성)
<a class=anchor href=#llm-%ec%a0%84%ec%9b%90-%ec%9d%98%eb%a2%b0%ec%84%9c-%ec%83%9d%ec%84%b1>#</a></h4><table><thead><tr><th>모델</th><th>용도</th><th>성능</th><th>비용</th></tr></thead><tbody><tr><td><strong>GPT-4</strong></td><td>전원 의뢰서 생성 (API)</td><td>✅ 높음</td><td>유료</td></tr><tr><td><strong>Gemma (로컬)</strong></td><td>전원 의뢰서 생성 (오프라인)</td><td>⚠️ 보통</td><td>무료</td></tr></tbody></table><p><strong>선정:</strong> GPT-4 (기본) + Gemma (폴백) - 의료 문서의 정확성과 비용 효율 균형</p><hr><h2 id=2-데이터베이스-아키텍처>2. 데이터베이스 아키텍처
<a class=anchor href=#2-%eb%8d%b0%ec%9d%b4%ed%84%b0%eb%b2%a0%ec%9d%b4%ec%8a%a4-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98>#</a></h2><h3 id=21-프로젝트-디렉토리-구조>2.1 프로젝트 디렉토리 구조
<a class=anchor href=#21-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%eb%94%94%eb%a0%89%ed%86%a0%eb%a6%ac-%ea%b5%ac%ec%a1%b0>#</a></h3><pre tabindex=0><code>VitalTime/
├── backend/                    # FastAPI 백엔드
│   ├── main.py                # 통합 백엔드 (API + DB + ML 로직)
│   ├── requirements.txt       # Python 의존성
│   ├── logs/                  # 모니터링 로그
│   │   ├── api_monitoring.log
│   │   └── ml_monitoring.log
│   └── saved_models/          # 학습된 LSTM 모델
│       ├── lstm_model_*.h5
│       ├── scalers_*.pkl
│       └── model_info_*.json
│
├── frontend/                   # Vue.js 프론트엔드
│   ├── components/            # Vue 컴포넌트
│   │   ├── PatientSearch.vue  # 환자 검색
│   │   ├── PatientDetail.vue  # 환자 상세 정보
│   │   ├── PatientReport.vue  # 전원 의뢰서
│   │   └── Map.vue            # 병원 지도
│   ├── index.html             # 메인 페이지
│   ├── main.js                # 앱 진입점
│   ├── monitoring.html        # 모니터링 대시보드
│   └── monitoring.js          # 모니터링 로직
│
├── data/                       # 데이터베이스 스크립트
│   ├── dump.sql               # Full DB dump (스키마 + 데이터)
│   ├── sample.sql             # 스키마 생성 스크립트
│   ├── sample_root.sql        # root 권한 스키마
│   └── data.xlsx              # 원본 임상 데이터
│
└── .env                        # 환경 변수 (DATABASE_URL, API 키)
</code></pre><h3 id=22-전체-시스템-아키텍처>2.2 전체 시스템 아키텍처
<a class=anchor href=#22-%ec%a0%84%ec%b2%b4-%ec%8b%9c%ec%8a%a4%ed%85%9c-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98>#</a></h3><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────────┐
│                        Frontend (Vue.js)                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │PatientSearch│  │PatientDetail│  │PatientReport│  │  Map.vue    │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
└─────────┼────────────────┼────────────────┼────────────────┼──────────┘
          │                │                │                │
          └────────────────┼────────────────┼────────────────┘
                           ▼                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        FastAPI Backend                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ Patient API │  │Clinical API │  │ Report API  │  │Monitoring   │   │
│  │ (검색/조회) │  │ (시계열)    │  │ (전원의뢰)  │  │ API         │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│         │                │                │                │            │
│         └────────────────┼────────────────┼────────────────┘            │
│                          ▼                ▼                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                 Pydantic Schemas (요청/응답 모델)                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    SQLAlchemy AsyncSession                         │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │                    Connection Pool (asyncpg)                 │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │              LSTM Model Training (8시간 주기)                      │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                            │  │
│  │  │ Scaler  │  │  LSTM   │  │  Model  │                            │  │
│  │  │  (X/Y)  │  │ 학습    │  │  저장   │                            │  │
│  │  └─────────┘  └─────────┘  └─────────┘                            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │           LLM (GPT-4 / Gemma) - 전원 의뢰서 생성                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       PostgreSQL 14 (Local)                              │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                       public schema                                  ││
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────┐              ││
│  │  │   patient   │  │  clinical_data  │  │   report    │              ││
│  │  │  (10 rows)  │  │   (100 rows)    │  │  (dynamic)  │              ││
│  │  └──────┬──────┘  └────────┬────────┘  └──────┬──────┘              ││
│  │         │    1:N           │    N:1            │    N:1              ││
│  │         └─────────────────►│◄──────────────────┘                    ││
│  │                            │                                         ││
│  │              Time-Series Clinical Data                               ││
│  │         (8-hour intervals, NEWS Score prediction)                    ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=23-데이터-흐름>2.3 데이터 흐름
<a class=anchor href=#23-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ed%9d%90%eb%a6%84>#</a></h3><pre tabindex=0><code>┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   Patient Data   │     │  Clinical Labs   │     │  NEWS Score      │
│  (환자 기본정보) │     │  (생체 지표)     │     │  (조기경보점수)  │
└────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘
         │                       │                         │
         └───────────────────────┼─────────────────────────┘
                                 ▼
                   ┌─────────────────────────────┐
                   │    Data Ingestion Layer     │
                   │  (Excel → SQL COPY 변환)    │
                   └─────────────┬───────────────┘
                                 │
                   ┌─────────────▼───────────────┐
                   │   PostgreSQL 14 Storage     │
                   │  (patient + clinical_data)  │
                   └─────────────┬───────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          ▼                      ▼                      ▼
┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐
│  Patient Info    │   │  LSTM Training   │   │  Transfer Report │
│  (LATERAL JOIN)  │   │  (Pandas + TF)   │   │  (GPT-4 / Gemma) │
│  NEWS Score 조회 │   │  NEWS 예측 학습  │   │  의뢰서 생성     │
└──────────────────┘   └──────────────────┘   └──────────────────┘
</code></pre><h3 id=24-erd-entity-relationship-diagram>2.4 ERD (Entity Relationship Diagram)
<a class=anchor href=#24-erd-entity-relationship-diagram>#</a></h3><pre tabindex=0><code>┌──────────────────────────────────────┐
│              patient                  │
├──────────────────────────────────────┤
│ patient_id    (PK, SERIAL)           │
│ patient_name  VARCHAR(100)           │
│ severity      INTEGER                │
│ doctor_name   VARCHAR(100)           │
│ hospital_name VARCHAR(200)           │
└──────────────────┬───────────────────┘
                   │
                   │ 1:N (ON DELETE CASCADE)
                   │
         ┌─────────┴─────────┐
         │                   │
         ▼                   ▼
┌──────────────────┐  ┌──────────────────┐
│  clinical_data   │  │     report       │
├──────────────────┤  ├──────────────────┤
│ clinical_id (PK) │  │ report_id  (PK)  │
│ patient_id  (FK) │  │ patient_id (FK)  │
│ timestamp   TS   │  │ from_hospital    │
│ timepoint   INT  │  │ to_hospital      │
│ creatinine  DBL  │  │ context          │
│ hemoglobin  DBL  │  │ createdat   TS   │
│ ldh         INT  │  │ reservedat  TS   │
│ lymphocytes DBL  │  └──────────────────┘
│ neutrophils DBL  │
│ platelet_count   │
│ wbc_count   DBL  │
│ hs_crp      DBL  │
│ d_dimer     DBL  │
│ news_score  INT  │
│ news_score_label │
└──────────────────┘
</code></pre><hr><h2 id=3-스키마-설계>3. 스키마 설계
<a class=anchor href=#3-%ec%8a%a4%ed%82%a4%eb%a7%88-%ec%84%a4%ea%b3%84>#</a></h2><h3 id=31-테이블-정의>3.1 테이블 정의
<a class=anchor href=#31-%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%a0%95%ec%9d%98>#</a></h3><h4 id=patient-테이블-환자-기본-정보>patient 테이블 (환자 기본 정보)
<a class=anchor href=#patient-%ed%85%8c%ec%9d%b4%eb%b8%94-%ed%99%98%ec%9e%90-%ea%b8%b0%eb%b3%b8-%ec%a0%95%eb%b3%b4>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>public</span>.patient (
</span></span><span style=display:flex><span>    patient_id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    patient_name CHARACTER VARYING(<span style=color:#ae81ff>100</span>),
</span></span><span style=display:flex><span>    severity INTEGER,
</span></span><span style=display:flex><span>    doctor_name CHARACTER VARYING(<span style=color:#ae81ff>100</span>),
</span></span><span style=display:flex><span>    hospital_name CHARACTER VARYING(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><table><thead><tr><th>컬럼</th><th>타입</th><th>제약조건</th><th>설명</th></tr></thead><tbody><tr><td>patient_id</td><td>SERIAL</td><td>PRIMARY KEY</td><td>자동 증가 환자 ID</td></tr><tr><td>patient_name</td><td>VARCHAR(100)</td><td>-</td><td>환자 이름</td></tr><tr><td>severity</td><td>INTEGER</td><td>-</td><td>중증도 (1-10, 높을수록 위험)</td></tr><tr><td>doctor_name</td><td>VARCHAR(100)</td><td>-</td><td>담당 의사 이름</td></tr><tr><td>hospital_name</td><td>VARCHAR(200)</td><td>-</td><td>소속 병원명</td></tr></tbody></table><p><strong>설계 근거:</strong></p><ul><li><code>severity</code>를 INTEGER로 설정하여 10단계 중증도 분류 (경증 1-4, 중등도 5-7, 중증 8-10)</li><li><code>doctor_name</code>과 <code>hospital_name</code>을 비정규화하여 조회 성능 우선 (의사/병원 테이블 JOIN 제거)</li><li>의료 시스템 특성상 조회가 압도적으로 많고 갱신이 적은 패턴에 최적화</li></ul><h4 id=clinical_data-테이블-시계열-임상-데이터>clinical_data 테이블 (시계열 임상 데이터)
<a class=anchor href=#clinical_data-%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%8b%9c%ea%b3%84%ec%97%b4-%ec%9e%84%ec%83%81-%eb%8d%b0%ec%9d%b4%ed%84%b0>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>public</span>.clinical_data (
</span></span><span style=display:flex><span>    clinical_id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    patient_id INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;timestamp&#34;</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>WITHOUT</span> TIME <span style=color:#66d9ef>ZONE</span>,
</span></span><span style=display:flex><span>    timepoint INTEGER,
</span></span><span style=display:flex><span>    creatinine DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    hemoglobin DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    ldh INTEGER,
</span></span><span style=display:flex><span>    lymphocytes DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    neutrophils DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    platelet_count DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    wbc_count DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    hs_crp DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    d_dimer DOUBLE <span style=color:#66d9ef>PRECISION</span>,
</span></span><span style=display:flex><span>    news_score INTEGER,
</span></span><span style=display:flex><span>    news_score_label INTEGER,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>CONSTRAINT</span> fk_clinical_patient
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (patient_id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>REFERENCES</span> <span style=color:#66d9ef>public</span>.patient(patient_id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 시퀀스 정의
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> SEQUENCE <span style=color:#66d9ef>public</span>.clinical_data_clinical_id_seq
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AS</span> INTEGER <span style=color:#66d9ef>START</span> <span style=color:#66d9ef>WITH</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>INCREMENT</span> <span style=color:#66d9ef>BY</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>NO</span> <span style=color:#66d9ef>MINVALUE</span> <span style=color:#66d9ef>NO</span> <span style=color:#66d9ef>MAXVALUE</span> <span style=color:#66d9ef>CACHE</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> SEQUENCE <span style=color:#66d9ef>public</span>.clinical_data_clinical_id_seq
</span></span><span style=display:flex><span>    OWNED <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>public</span>.clinical_data.clinical_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>ONLY</span> <span style=color:#66d9ef>public</span>.clinical_data
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> clinical_id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>DEFAULT</span> nextval(<span style=color:#e6db74>&#39;public.clinical_data_clinical_id_seq&#39;</span>::regclass);
</span></span></code></pre></div><table><thead><tr><th>컬럼</th><th>타입</th><th>제약조건</th><th>설명</th></tr></thead><tbody><tr><td>clinical_id</td><td>SERIAL</td><td>PRIMARY KEY</td><td>자동 증가 임상 데이터 ID</td></tr><tr><td>patient_id</td><td>INTEGER</td><td>FK → patient, NOT NULL</td><td>환자 참조</td></tr><tr><td>timestamp</td><td>TIMESTAMP</td><td>-</td><td>측정 시각</td></tr><tr><td>timepoint</td><td>INTEGER</td><td>-</td><td>시점 번호 (1-10)</td></tr><tr><td>creatinine</td><td>DOUBLE PRECISION</td><td>-</td><td>크레아티닌 (mg/dL)</td></tr><tr><td>hemoglobin</td><td>DOUBLE PRECISION</td><td>-</td><td>헤모글로빈 (g/dL)</td></tr><tr><td>ldh</td><td>INTEGER</td><td>-</td><td>젖산탈수소효소 (U/L)</td></tr><tr><td>lymphocytes</td><td>DOUBLE PRECISION</td><td>-</td><td>림프구 수</td></tr><tr><td>neutrophils</td><td>DOUBLE PRECISION</td><td>-</td><td>호중구 수</td></tr><tr><td>platelet_count</td><td>DOUBLE PRECISION</td><td>-</td><td>혈소판 수</td></tr><tr><td>wbc_count</td><td>DOUBLE PRECISION</td><td>-</td><td>백혈구 수</td></tr><tr><td>hs_crp</td><td>DOUBLE PRECISION</td><td>-</td><td>고감도 C-반응성 단백질 (mg/L)</td></tr><tr><td>d_dimer</td><td>DOUBLE PRECISION</td><td>-</td><td>D-이합체 (ng/mL)</td></tr><tr><td>news_score</td><td>INTEGER</td><td>-</td><td>NEWS 예측 점수 (ML 모델 결과)</td></tr><tr><td>news_score_label</td><td>INTEGER</td><td>-</td><td>NEWS 실제 레이블 (정답)</td></tr></tbody></table><p><strong>설계 근거:</strong></p><ul><li>환자당 10개 시점, 8시간 간격으로 총 100개 레코드 (10 환자 x 10 시점)</li><li><code>news_score</code>와 <code>news_score_label</code>을 분리하여 예측값과 실측값 비교 가능</li><li><code>ON DELETE CASCADE</code>로 환자 삭제 시 연관 임상 데이터 자동 정리</li><li><code>TIMESTAMP WITHOUT TIME ZONE</code>으로 단일 병원 내 시간 관리 단순화</li></ul><h4 id=report-테이블-전원-의뢰서>report 테이블 (전원 의뢰서)
<a class=anchor href=#report-%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%a0%84%ec%9b%90-%ec%9d%98%eb%a2%b0%ec%84%9c>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>public</span>.report (
</span></span><span style=display:flex><span>    report_id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    patient_id INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    from_hospital CHARACTER VARYING(<span style=color:#ae81ff>200</span>),
</span></span><span style=display:flex><span>    to_hospital CHARACTER VARYING(<span style=color:#ae81ff>200</span>),
</span></span><span style=display:flex><span>    context CHARACTER VARYING(<span style=color:#ae81ff>500</span>),
</span></span><span style=display:flex><span>    createdat <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>WITHOUT</span> TIME <span style=color:#66d9ef>ZONE</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>,
</span></span><span style=display:flex><span>    reservedat <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>WITHOUT</span> TIME <span style=color:#66d9ef>ZONE</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>CONSTRAINT</span> fk_report_patient
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (patient_id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>REFERENCES</span> <span style=color:#66d9ef>public</span>.patient(patient_id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><table><thead><tr><th>컬럼</th><th>타입</th><th>제약조건</th><th>설명</th></tr></thead><tbody><tr><td>report_id</td><td>SERIAL</td><td>PRIMARY KEY</td><td>자동 증가 보고서 ID</td></tr><tr><td>patient_id</td><td>INTEGER</td><td>FK → patient, NOT NULL</td><td>환자 참조</td></tr><tr><td>from_hospital</td><td>VARCHAR(200)</td><td>-</td><td>전원 출발 병원</td></tr><tr><td>to_hospital</td><td>VARCHAR(200)</td><td>-</td><td>전원 도착 병원</td></tr><tr><td>context</td><td>VARCHAR(500)</td><td>-</td><td>AI 생성 의뢰서 내용</td></tr><tr><td>createdat</td><td>TIMESTAMP</td><td>DEFAULT CURRENT_TIMESTAMP</td><td>생성 시각</td></tr><tr><td>reservedat</td><td>TIMESTAMP</td><td>-</td><td>예약 시각</td></tr></tbody></table><p><strong>설계 근거:</strong></p><ul><li><code>from_hospital</code>과 <code>to_hospital</code>을 VARCHAR로 저장하여 외부 병원 정보 유연하게 관리</li><li><code>createdat</code>에 DEFAULT CURRENT_TIMESTAMP로 자동 기록</li><li><code>context</code>에 AI 생성 전원 의뢰서 내용 저장 (GPT-4/Gemma 출력)</li></ul><h3 id=32-시계열-데이터-구조-설계>3.2 시계열 데이터 구조 설계
<a class=anchor href=#32-%ec%8b%9c%ea%b3%84%ec%97%b4-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ea%b5%ac%ec%a1%b0-%ec%84%a4%ea%b3%84>#</a></h3><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────┐
│                 Time-Series Data Structure                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  환자당 데이터 구조:                                                  │
│  ├── 10개 시점 (timepoint 1~10)                                     │
│  ├── 8시간 간격 (INTERVAL &#39;8 hours&#39;)                                │
│  ├── 측정 기간: 약 3일 (72시간)                                      │
│  └── 시작 시각: 환자별 상이 (입원 시점 기준)                          │
│                                                                      │
│  생체 지표 구성:                                                      │
│  ├── 혈액학적 지표: hemoglobin, platelet_count, wbc_count            │
│  ├── 생화학적 지표: creatinine, ldh, hs_crp, d_dimer                │
│  ├── 면역학적 지표: lymphocytes, neutrophils                         │
│  └── 복합 점수: news_score (예측), news_score_label (실측)           │
│                                                                      │
│  NEWS Score 범위:                                                     │
│  ├── 0-4:  저위험 (Low Risk)                                         │
│  ├── 5-6:  중위험 (Medium Risk)                                      │
│  └── 7+:   고위험 (High Risk) → 전원 의뢰 대상                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=33-초기-데이터-구성>3.3 초기 데이터 구성
<a class=anchor href=#33-%ec%b4%88%ea%b8%b0-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ea%b5%ac%ec%84%b1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 환자 데이터 (10명)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>COPY</span> <span style=color:#66d9ef>public</span>.patient (patient_id, patient_name, severity, doctor_name, hospital_name) <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>stdin</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>   <span style=color:#960050;background-color:#1e0010>김민우</span>   <span style=color:#ae81ff>3</span>   <span style=color:#960050;background-color:#1e0010>박철수</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>   <span style=color:#960050;background-color:#1e0010>이서현</span>   <span style=color:#ae81ff>3</span>   <span style=color:#960050;background-color:#1e0010>김지훈</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#960050;background-color:#1e0010>박지훈</span>   <span style=color:#ae81ff>2</span>   <span style=color:#960050;background-color:#1e0010>이영희</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>   <span style=color:#960050;background-color:#1e0010>최유진</span>   <span style=color:#ae81ff>2</span>   <span style=color:#960050;background-color:#1e0010>정우성</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>   <span style=color:#960050;background-color:#1e0010>정하늘</span>   <span style=color:#ae81ff>6</span>   <span style=color:#960050;background-color:#1e0010>한지민</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>   <span style=color:#960050;background-color:#1e0010>한도윤</span>   <span style=color:#ae81ff>4</span>   <span style=color:#960050;background-color:#1e0010>최민호</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span>   <span style=color:#960050;background-color:#1e0010>윤지호</span>   <span style=color:#ae81ff>6</span>   <span style=color:#960050;background-color:#1e0010>오하늘</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>   <span style=color:#960050;background-color:#1e0010>서지민</span>   <span style=color:#ae81ff>7</span>   <span style=color:#960050;background-color:#1e0010>김도현</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>   <span style=color:#960050;background-color:#1e0010>장예린</span>   <span style=color:#ae81ff>5</span>   <span style=color:#960050;background-color:#1e0010>송혜교</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>  <span style=color:#960050;background-color:#1e0010>오승현</span>   <span style=color:#ae81ff>8</span>   <span style=color:#960050;background-color:#1e0010>김범수</span>   SKALA대학병원
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 임상 데이터 (100건 = 10환자 x 10시점, 8시간 간격)
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 측정 기간: 2025-01-01 ~ 2025-01-04
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>COPY</span> <span style=color:#66d9ef>public</span>.clinical_data (...) <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>stdin</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>2025</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span> <span style=color:#ae81ff>23</span>:<span style=color:#ae81ff>25</span>:<span style=color:#ae81ff>05</span>   <span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>9</span>   <span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>180</span>   <span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>4</span>.<span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>220</span>   <span style=color:#ae81ff>7</span>   <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>8</span>   <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>4</span>   <span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>2025</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span> <span style=color:#ae81ff>07</span>:<span style=color:#ae81ff>25</span>:<span style=color:#ae81ff>05</span>   <span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>14</span>     <span style=color:#ae81ff>210</span>   <span style=color:#ae81ff>2</span>     <span style=color:#ae81ff>4</span>.<span style=color:#ae81ff>5</span>   <span style=color:#ae81ff>210</span>   <span style=color:#ae81ff>7</span>.<span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>2</span>     <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>6</span>   <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span> <span style=color:#ae81ff>10</span>  <span style=color:#ae81ff>2025</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>04</span> <span style=color:#ae81ff>21</span>:<span style=color:#ae81ff>34</span>:<span style=color:#ae81ff>06</span>   <span style=color:#ae81ff>10</span>  <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>43</span>  <span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>6</span>   <span style=color:#ae81ff>172</span>   <span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>93</span>  <span style=color:#ae81ff>309</span>   <span style=color:#ae81ff>4</span>.<span style=color:#ae81ff>67</span>  <span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>61</span>  <span style=color:#ae81ff>8</span>   <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>.
</span></span></code></pre></div><hr><h2 id=4-시계열-데이터-처리>4. 시계열 데이터 처리
<a class=anchor href=#4-%ec%8b%9c%ea%b3%84%ec%97%b4-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%b2%98%eb%a6%ac>#</a></h2><h3 id=41-lateral-join-기반-예측값-조회>4.1 LATERAL JOIN 기반 예측값 조회
<a class=anchor href=#41-lateral-join-%ea%b8%b0%eb%b0%98-%ec%98%88%ec%b8%a1%ea%b0%92-%ec%a1%b0%ed%9a%8c>#</a></h3><p>환자 목록 조회 시 현재 NEWS Score와 다음 시점 예측값을 동시에 조회하는 핵심 쿼리입니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - get_patient_info_crud()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_info_crud</span>(timestamp: datetime, session: AsyncSession):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;기준 timestamp 기반 환자 정보 조회 (LATERAL JOIN)&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> timestamp<span style=color:#f92672>.</span>tzinfo <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        timestamp <span style=color:#f92672>=</span> timestamp<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    start_time <span style=color:#f92672>=</span> timestamp <span style=color:#f92672>-</span> timedelta(hours<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    end_time <span style=color:#f92672>=</span> timestamp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            p.patient_name, p.patient_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c_cur.timestamp AS cur_timestamp,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c_cur.news_score_label AS cur_news,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c_next.news_score AS cur_predicted
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM public.patient p
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        JOIN (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            -- 서브쿼리: 8시간 윈도우 내 가장 최신 임상 데이터
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT c1.*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM public.clinical_data c1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            JOIN (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                SELECT patient_id, MAX(timestamp) AS max_ts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                FROM public.clinical_data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                WHERE timestamp BETWEEN :start_time AND :end_time
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                GROUP BY patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ) c2 ON c1.patient_id = c2.patient_id AND c1.timestamp = c2.max_ts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ) c_cur ON p.patient_id = c_cur.patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        -- LATERAL JOIN: 현재 시점 이후 8시간 내 다음 예측값
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        LEFT JOIN LATERAL (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT c2.news_score
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM public.clinical_data c2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            WHERE c2.patient_id = c_cur.patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              AND c2.timestamp &gt; c_cur.timestamp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              AND c2.timestamp &lt;= c_cur.timestamp + INTERVAL &#39;8 hours&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ORDER BY c2.timestamp ASC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LIMIT 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ) c_next ON TRUE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY p.patient_id;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(query, {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;start_time&#34;</span>: start_time,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;end_time&#34;</span>: end_time,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    rows <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    patients <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> rows:
</span></span><span style=display:flex><span>        cur_news <span style=color:#f92672>=</span> int(row[<span style=color:#ae81ff>3</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        cur_predicted <span style=color:#f92672>=</span> int(row[<span style=color:#ae81ff>4</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        patients<span style=color:#f92672>.</span>append(PatientInfo(
</span></span><span style=display:flex><span>            patient_id<span style=color:#f92672>=</span>row[<span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>            patient_name<span style=color:#f92672>=</span>row[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>            timestamp<span style=color:#f92672>=</span>row[<span style=color:#ae81ff>2</span>],
</span></span><span style=display:flex><span>            cur_news<span style=color:#f92672>=</span>float(cur_news),
</span></span><span style=display:flex><span>            cur_predicted<span style=color:#f92672>=</span>float(cur_predicted),
</span></span><span style=display:flex><span>        ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> PatientInfoResponse(
</span></span><span style=display:flex><span>        patients<span style=color:#f92672>=</span>patients,
</span></span><span style=display:flex><span>        total_count<span style=color:#f92672>=</span>len(patients),
</span></span><span style=display:flex><span>        timestamp<span style=color:#f92672>=</span>timestamp,
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><h4 id=lateral-join-동작-원리>LATERAL JOIN 동작 원리
<a class=anchor href=#lateral-join-%eb%8f%99%ec%9e%91-%ec%9b%90%eb%a6%ac>#</a></h4><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────┐
│                    LATERAL JOIN 실행 흐름                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Step 1: 시간 윈도우 설정                                            │
│  ├── end_time = 기준 timestamp                                       │
│  └── start_time = end_time - 8 hours                                │
│                                                                      │
│  Step 2: 서브쿼리 (c_cur)                                            │
│  ├── 8시간 윈도우 내 환자별 최신 레코드 선택                          │
│  └── MAX(timestamp) GROUP BY patient_id                              │
│                                                                      │
│  Step 3: LATERAL JOIN (c_next)                                       │
│  ├── c_cur의 각 행에 대해 독립적으로 실행                             │
│  ├── 현재 시점 이후 ~ +8시간 이내 다음 레코드 검색                    │
│  ├── ORDER BY timestamp ASC LIMIT 1 (가장 가까운 미래 시점)          │
│  └── LEFT JOIN → 미래 데이터 없으면 NULL 반환                        │
│                                                                      │
│  결과: 환자 ID, 이름, 현재 NEWS, 예측 NEWS                           │
│                                                                      │
│  Timeline:                                                           │
│  ──────[start_time]────────[c_cur]────────[c_next]──────►            │
│         -8h                  현재         +8h (예측)                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=42-date_trunc-기반-예측값-조회>4.2 DATE_TRUNC 기반 예측값 조회
<a class=anchor href=#42-date_trunc-%ea%b8%b0%eb%b0%98-%ec%98%88%ec%b8%a1%ea%b0%92-%ec%a1%b0%ed%9a%8c>#</a></h3><p>특정 환자의 기준 timestamp 이후 가장 가까운 미래 시점의 NEWS Score를 조회합니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - get_patient_predicted_by_timestamp_crud()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_predicted_by_timestamp_crud</span>(
</span></span><span style=display:flex><span>    patient_id: int, timestamp: datetime, session: AsyncSession
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;특정 환자의 기준 timestamp 이후 예측값 조회&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT clinical_id, patient_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               DATE_TRUNC(&#39;hour&#39;, timestamp) AS truncated_timestamp,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               timepoint, news_score
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM public.clinical_data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE patient_id = :patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          AND DATE_TRUNC(&#39;hour&#39;, timestamp) &gt; DATE_TRUNC(&#39;hour&#39;, CAST(:timestamp AS TIMESTAMP))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY DATE_TRUNC(&#39;hour&#39;, timestamp) ASC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        LIMIT 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(query, {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;patient_id&#34;</span>: patient_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp&#34;</span>: timestamp,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    row <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span>fetchone()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> row:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;patient_id&#34;</span>: patient_id,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;base_timestamp&#34;</span>: timestamp<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M&#34;</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;해당 시점 이후의 예측값 데이터가 없습니다.&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;data&#34;</span>: [],
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    truncated_str <span style=color:#f92672>=</span> row[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M&#34;</span>) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>2</span>] <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;clinical_id&#34;</span>: row[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;patient_id&#34;</span>: row[<span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp_hour&#34;</span>: truncated_str,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timepoint&#34;</span>: row[<span style=color:#ae81ff>3</span>],
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;news_score&#34;</span>: int(row[<span style=color:#ae81ff>4</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;patient_id&#34;</span>: patient_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;base_timestamp&#34;</span>: timestamp<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nearest_future_timestamp_hour&#34;</span>: truncated_str,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;data&#34;</span>: data,
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><strong>DATE_TRUNC 사용 이유:</strong></p><ul><li>임상 데이터의 정확한 측정 시각이 분/초 단위로 다를 수 있음</li><li><code>DATE_TRUNC('hour', ...)</code> 로 시간 단위까지만 비교하여 근사 매칭</li><li>동일 시간대의 중복 조회 방지</li></ul><h3 id=43-시간-범위-임상-데이터-조회>4.3 시간 범위 임상 데이터 조회
<a class=anchor href=#43-%ec%8b%9c%ea%b0%84-%eb%b2%94%ec%9c%84-%ec%9e%84%ec%83%81-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%a1%b0%ed%9a%8c>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - get_patient_data_range_crud()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_data_range_crud</span>(
</span></span><span style=display:flex><span>    patient_id: int, timestamp: datetime, session: AsyncSession
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;특정 환자의 8시간 범위 데이터 조회&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    start_time <span style=color:#f92672>=</span> timestamp <span style=color:#f92672>-</span> timedelta(hours<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    end_time <span style=color:#f92672>=</span> timestamp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT clinical_id, patient_id, timestamp, timepoint,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               creatinine, hemoglobin, ldh, lymphocytes, neutrophils,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               platelet_count, wbc_count, hs_crp, d_dimer,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               news_score, news_score_label
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM public.clinical_data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE patient_id = :patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          AND timestamp BETWEEN :start_time AND :end_time
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY timestamp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(query, {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;patient_id&#34;</span>: patient_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;start_time&#34;</span>: start_time,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;end_time&#34;</span>: end_time,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    rows <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> rows:
</span></span><span style=display:flex><span>        data<span style=color:#f92672>.</span>append({
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;clinical_id&#34;</span>: row[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;patient_id&#34;</span>: row[<span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;timestamp&#34;</span>: row[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>isoformat() <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>2</span>] <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;timepoint&#34;</span>: row[<span style=color:#ae81ff>3</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;creatinine&#34;</span>: float(row[<span style=color:#ae81ff>4</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hemoglobin&#34;</span>: float(row[<span style=color:#ae81ff>5</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ldh&#34;</span>: int(row[<span style=color:#ae81ff>6</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;lymphocytes&#34;</span>: float(row[<span style=color:#ae81ff>7</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>7</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;neutrophils&#34;</span>: float(row[<span style=color:#ae81ff>8</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;platelet_count&#34;</span>: float(row[<span style=color:#ae81ff>9</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>9</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;wbc_count&#34;</span>: float(row[<span style=color:#ae81ff>10</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hs_crp&#34;</span>: float(row[<span style=color:#ae81ff>11</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>11</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;d_dimer&#34;</span>: float(row[<span style=color:#ae81ff>12</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>12</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;news_score&#34;</span>: int(row[<span style=color:#ae81ff>13</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>13</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;news_score_label&#34;</span>: int(row[<span style=color:#ae81ff>14</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>14</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;patient_id&#34;</span>: patient_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp_range&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;start&#34;</span>: start_time<span style=color:#f92672>.</span>isoformat(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;end&#34;</span>: end_time<span style=color:#f92672>.</span>isoformat(),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;total_records&#34;</span>: len(data),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;data&#34;</span>: data,
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=44-통계-집계-pandas-연동>4.4 통계 집계 (Pandas 연동)
<a class=anchor href=#44-%ed%86%b5%ea%b3%84-%ec%a7%91%ea%b3%84-pandas-%ec%97%b0%eb%8f%99>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - get_all_clinical_data()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_all_clinical_data</span>(session: AsyncSession):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;clinical_data 전체 조회 + 통계 생성 (Pandas)&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT clinical_id, patient_id, timestamp, timepoint,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               creatinine, hemoglobin, ldh, lymphocytes, neutrophils,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               platelet_count, wbc_count, hs_crp, d_dimer, news_score
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM public.clinical_data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY patient_id, timepoint
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(query)
</span></span><span style=display:flex><span>    rows <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Pandas DataFrame으로 변환</span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> [<span style=color:#f92672>...</span>]  <span style=color:#75715e># 행 변환</span>
</span></span><span style=display:flex><span>    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 통계 집계</span>
</span></span><span style=display:flex><span>    stats <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;total_records&#34;</span>: len(df),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;unique_patients&#34;</span>: df[<span style=color:#e6db74>&#34;patient_id&#34;</span>]<span style=color:#f92672>.</span>nunique(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timepoint_range&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;min&#34;</span>: int(df[<span style=color:#e6db74>&#34;timepoint&#34;</span>]<span style=color:#f92672>.</span>min()),  <span style=color:#75715e># 1</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;max&#34;</span>: int(df[<span style=color:#e6db74>&#34;timepoint&#34;</span>]<span style=color:#f92672>.</span>max()),  <span style=color:#75715e># 10</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;news_score_stats&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;min&#34;</span>: int(df[<span style=color:#e6db74>&#34;news_score&#34;</span>]<span style=color:#f92672>.</span>min()),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;max&#34;</span>: int(df[<span style=color:#e6db74>&#34;news_score&#34;</span>]<span style=color:#f92672>.</span>max()),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mean&#34;</span>: float(df[<span style=color:#e6db74>&#34;news_score&#34;</span>]<span style=color:#f92672>.</span>mean()),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;data&#34;</span>: data,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dataframe_info&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;shape&#34;</span>: df<span style=color:#f92672>.</span>shape,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;columns&#34;</span>: list(df<span style=color:#f92672>.</span>columns),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;dtypes&#34;</span>: df<span style=color:#f92672>.</span>dtypes<span style=color:#f92672>.</span>to_dict(),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;statistics&#34;</span>: stats,
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><hr><h2 id=5-orm-및-비동기-처리>5. ORM 및 비동기 처리
<a class=anchor href=#5-orm-%eb%b0%8f-%eb%b9%84%eb%8f%99%ea%b8%b0-%ec%b2%98%eb%a6%ac>#</a></h2><h3 id=51-sqlalchemy-비동기-설정>5.1 SQLAlchemy 비동기 설정
<a class=anchor href=#51-sqlalchemy-%eb%b9%84%eb%8f%99%ea%b8%b0-%ec%84%a4%ec%a0%95>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - 데이터베이스 연결 설정</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    create_async_engine,
</span></span><span style=display:flex><span>    async_sessionmaker,
</span></span><span style=display:flex><span>    AsyncSession,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 환경 변수에서 연결 문자열 로드</span>
</span></span><span style=display:flex><span>DATABASE_URL <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;DATABASE_URL&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 예: &#34;postgresql+asyncpg://user:password@localhost:5432/vitaltime&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> DATABASE_URL:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;DATABASE_URL 환경 변수가 설정되지 않았습니다.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 전역 엔진/세션 변수</span>
</span></span><span style=display:flex><span>engine <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>async_session <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>connect</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;비동기 엔진 및 세션 팩토리 초기화&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> engine, async_session
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Attempting to connect to the database...&#34;</span>)
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span> create_async_engine(
</span></span><span style=display:flex><span>        DATABASE_URL,
</span></span><span style=display:flex><span>        echo<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,  <span style=color:#75715e># SQL 로깅 비활성화 (프로덕션)</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    async_session <span style=color:#f92672>=</span> async_sessionmaker(
</span></span><span style=display:flex><span>        engine,
</span></span><span style=display:flex><span>        class_<span style=color:#f92672>=</span>AsyncSession,
</span></span><span style=display:flex><span>        expire_on_commit<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Database connection successful.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>disconnect</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;엔진 리소스 해제&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> engine:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> engine<span style=color:#f92672>.</span>dispose()
</span></span></code></pre></div><h3 id=52-의존성-주입-패턴>5.2 의존성 주입 패턴
<a class=anchor href=#52-%ec%9d%98%ec%a1%b4%ec%84%b1-%ec%a3%bc%ec%9e%85-%ed%8c%a8%ed%84%b4>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># FastAPI 의존성 주입</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> Depends
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_session</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    데이터베이스 세션 의존성 주입
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 요청마다 새 세션 생성
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - async with로 자동 세션 종료
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - None 체크로 미연결 상태 방어
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> async_session <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Database not connected&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> async_session() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 엔드포인트에서 사용</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.get</span>(<span style=color:#e6db74>&#34;/api/get-patient-info&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_info</span>(
</span></span><span style=display:flex><span>    timestamp: str <span style=color:#f92672>=</span> Query(<span style=color:#f92672>...</span>),
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    dt <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromisoformat(timestamp<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;Z&#34;</span>, <span style=color:#e6db74>&#34;+00:00&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> get_patient_info_crud(dt, session)
</span></span></code></pre></div><h3 id=53-생명주기-관리>5.3 생명주기 관리
<a class=anchor href=#53-%ec%83%9d%eb%aa%85%ec%a3%bc%ea%b8%b0-%ea%b4%80%eb%a6%ac>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># FastAPI 이벤트 핸들러</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.on_event</span>(<span style=color:#e6db74>&#34;startup&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>startup</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;애플리케이션 시작 시 DB 연결 + ML 스케줄러 시작&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    connect()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        loop <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>get_running_loop()
</span></span><span style=display:flex><span>        factory <span style=color:#f92672>=</span> get_session_factory()
</span></span><span style=display:flex><span>        start_training_scheduler(factory, loop)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;스케줄러 시작 실패: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.on_event</span>(<span style=color:#e6db74>&#34;shutdown&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>shutdown</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;애플리케이션 종료 시 DB 연결 해제&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> disconnect()
</span></span></code></pre></div><h3 id=54-raw-sql-선택-근거>5.4 Raw SQL 선택 근거
<a class=anchor href=#54-raw-sql-%ec%84%a0%ed%83%9d-%ea%b7%bc%ea%b1%b0>#</a></h3><p>프로젝트에서는 SQLAlchemy ORM 대신 Raw SQL (<code>text()</code>)을 선택했습니다:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Raw SQL 사용 (선택)</span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    SELECT p.patient_name, p.patient_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>           c_cur.timestamp AS cur_timestamp,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>           c_cur.news_score_label AS cur_news,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>           c_next.news_score AS cur_predicted
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FROM public.patient p
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    JOIN (...) c_cur ON p.patient_id = c_cur.patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LEFT JOIN LATERAL (...) c_next ON TRUE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ORDER BY p.patient_id;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(query, params)
</span></span></code></pre></div><table><thead><tr><th>비교 항목</th><th>Raw SQL</th><th>ORM</th></tr></thead><tbody><tr><td>LATERAL JOIN</td><td>✅ 완벽 지원</td><td>❌ 미지원</td></tr><tr><td>DATE_TRUNC</td><td>✅ 직접 사용</td><td>⚠️ func() 필요</td></tr><tr><td>서브쿼리 중첩</td><td>✅ 자유로움</td><td>⚠️ 복잡</td></tr><tr><td>쿼리 가독성</td><td>✅ SQL 그대로</td><td>❌ Python 변환</td></tr><tr><td>타입 안전성</td><td>❌ 없음</td><td>✅ 있음</td></tr><tr><td>SQL 인젝션 방어</td><td>✅ text() 바인딩</td><td>✅ 자동</td></tr></tbody></table><p><strong>선택 이유:</strong> LATERAL JOIN, DATE_TRUNC 등 PostgreSQL 고유 기능을 직접 활용해야 하는 의료 시계열 쿼리에 ORM은 부적합</p><hr><h2 id=6-api-엔드포인트-설계>6. API 엔드포인트 설계
<a class=anchor href=#6-api-%ec%97%94%eb%93%9c%ed%8f%ac%ec%9d%b8%ed%8a%b8-%ec%84%a4%ea%b3%84>#</a></h2><h3 id=61-엔드포인트-구조>6.1 엔드포인트 구조
<a class=anchor href=#61-%ec%97%94%eb%93%9c%ed%8f%ac%ec%9d%b8%ed%8a%b8-%ea%b5%ac%ec%a1%b0>#</a></h3><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────────┐
│                           API Endpoints                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Patient (환자 조회)                                                     │
│  └── GET  /api/get-patient-info?timestamp=    환자 목록 + NEWS Score     │
│                                                                          │
│  Clinical Data (임상 데이터)                                             │
│  ├── GET  /api/get-patient-data-range/{id}?timestamp=   8시간 범위 조회  │
│  └── GET  /api/get-patient-predicted/{id}?timestamp=    예측값 조회      │
│                                                                          │
│  Transfer Report (전원 의뢰)                                             │
│  ├── POST /api/page3/patient-report            GPT-4 전원 의뢰서 생성   │
│  └── POST /api/generate-transfer-report        로컬 LLM 의뢰서 생성    │
│                                                                          │
│  ML (모델 학습)                                                          │
│  └── POST /api/train-model                     LSTM 수동 학습 트리거    │
│                                                                          │
│  Monitoring (모니터링)                                                    │
│  ├── GET  /api/monitoring/api                  API 호출 로그             │
│  └── GET  /api/monitoring/ml                   ML 학습 로그             │
│                                                                          │
│  Health Check (상태 확인)                                                │
│  ├── GET  /health                              서비스 상태               │
│  ├── GET  /db-health                           DB 연결 상태             │
│  └── GET  /schedule-status                     스케줄러 상태            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=62-주요-엔드포인트-구현>6.2 주요 엔드포인트 구현
<a class=anchor href=#62-%ec%a3%bc%ec%9a%94-%ec%97%94%eb%93%9c%ed%8f%ac%ec%9d%b8%ed%8a%b8-%ea%b5%ac%ed%98%84>#</a></h3><h4 id=환자-목록-조회-news-score-포함>환자 목록 조회 (NEWS Score 포함)
<a class=anchor href=#%ed%99%98%ec%9e%90-%eb%aa%a9%eb%a1%9d-%ec%a1%b0%ed%9a%8c-news-score-%ed%8f%ac%ed%95%a8>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.get</span>(<span style=color:#e6db74>&#34;/api/get-patient-info&#34;</span>, response_model<span style=color:#f92672>=</span>PatientInfoResponse, tags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;Patient&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_info</span>(
</span></span><span style=display:flex><span>    timestamp: str <span style=color:#f92672>=</span> Query(<span style=color:#f92672>...</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;기준 timestamp (ISO 형식)&#34;</span>),
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    환자 목록 조회 (LATERAL JOIN 기반)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 기준 시점의 8시간 윈도우 내 최신 임상 데이터 조회
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 현재 NEWS Score + 다음 시점 예측 NEWS Score 반환
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 전체 환자를 patient_id 순으로 정렬
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        dt <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromisoformat(timestamp<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;Z&#34;</span>, <span style=color:#e6db74>&#34;+00:00&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> get_patient_info_crud(dt, session)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>422</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Invalid timestamp format: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span></code></pre></div><h4 id=전원-의뢰서-생성-gpt-4>전원 의뢰서 생성 (GPT-4)
<a class=anchor href=#%ec%a0%84%ec%9b%90-%ec%9d%98%eb%a2%b0%ec%84%9c-%ec%83%9d%ec%84%b1-gpt-4>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/api/page3/patient-report&#34;</span>, response_model<span style=color:#f92672>=</span>Page3Response, tags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;Page3&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_report</span>(
</span></span><span style=display:flex><span>    request: Page3Request,
</span></span><span style=display:flex><span>    db: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    전원 의뢰서 생성
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    1. 환자 기본 정보 조회 (patient 테이블)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    2. 최신 임상 데이터 조회 (clinical_data 테이블)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    3. GPT-4로 전문 전원 의뢰서 생성
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    4. 통합 응답 반환
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># DB 조회</span>
</span></span><span style=display:flex><span>        patient_info <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> get_page3_patient_info(request<span style=color:#f92672>.</span>patient_id, db)
</span></span><span style=display:flex><span>        clinical_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> get_latest_clinical_data(request<span style=color:#f92672>.</span>patient_id, db)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># AI 보고서 생성</span>
</span></span><span style=display:flex><span>        report_content <span style=color:#f92672>=</span> generate_medical_report(
</span></span><span style=display:flex><span>            patient_info, request<span style=color:#f92672>.</span>hospital_info, clinical_data
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Page3Response(
</span></span><span style=display:flex><span>            patient_info<span style=color:#f92672>=</span>patient_info,
</span></span><span style=display:flex><span>            hospital_info<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>hospital_info,
</span></span><span style=display:flex><span>            clinical_data<span style=color:#f92672>=</span>clinical_data,
</span></span><span style=display:flex><span>            ai_report<span style=color:#f92672>=</span>AIReport(report_content<span style=color:#f92672>=</span>report_content),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> HTTPException:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;서버 오류: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><h4 id=db-헬스체크>DB 헬스체크
<a class=anchor href=#db-%ed%97%ac%ec%8a%a4%ec%b2%b4%ed%81%ac>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.get</span>(<span style=color:#e6db74>&#34;/db-health&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>db_health</span>(session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session)):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;PostgreSQL 연결 상태 확인&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(text(<span style=color:#e6db74>&#34;SELECT 1&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;database_status&#34;</span>: <span style=color:#e6db74>&#34;connected&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;result&#34;</span>: result<span style=color:#f92672>.</span>scalar(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span></code></pre></div><h3 id=63-pydantic-스키마>6.3 Pydantic 스키마
<a class=anchor href=#63-pydantic-%ec%8a%a4%ed%82%a4%eb%a7%88>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 요청/응답 스키마 정의</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, Field
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> List, Optional
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># === Patient 관련 ===</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PatientInfo</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;환자 기본 정보 + NEWS Score&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patient_id: int
</span></span><span style=display:flex><span>    patient_name: str
</span></span><span style=display:flex><span>    timestamp: datetime
</span></span><span style=display:flex><span>    cur_news: int         <span style=color:#75715e># 현재 NEWS Score (실측)</span>
</span></span><span style=display:flex><span>    cur_predicted: int    <span style=color:#75715e># 예측 NEWS Score (다음 시점)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PatientInfoResponse</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;환자 목록 응답&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patients: List[PatientInfo]
</span></span><span style=display:flex><span>    total_count: int
</span></span><span style=display:flex><span>    timestamp: datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># === Page3 (전원 의뢰) 관련 ===</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HospitalInfo</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;이송 대상 병원 정보&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    id: int
</span></span><span style=display:flex><span>    name: str
</span></span><span style=display:flex><span>    address: str
</span></span><span style=display:flex><span>    distance: float       <span style=color:#75715e># km 단위</span>
</span></span><span style=display:flex><span>    phone: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Page3PatientInfo</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;전원 대상 환자 기본 정보&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patient_id: int
</span></span><span style=display:flex><span>    patient_name: str
</span></span><span style=display:flex><span>    severity: int         <span style=color:#75715e># 1-10 중증도</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClinicalData</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;최신 임상 검사 데이터&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    d_dimer: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    ldh: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    creatinine: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    hemoglobin: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    lymphocytes: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    neutrophils: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    hs_crp: Optional[float] <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    timepoint: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Page3Request</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;전원 의뢰서 생성 요청&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patient_id: int <span style=color:#f92672>=</span> Field(<span style=color:#f92672>...</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;환자 ID&#34;</span>)
</span></span><span style=display:flex><span>    hospital_info: HospitalInfo <span style=color:#f92672>=</span> Field(<span style=color:#f92672>...</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;선택된 병원 정보&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AIReport</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;AI 생성 의뢰서&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    report_content: str
</span></span><span style=display:flex><span>    generated_at: datetime <span style=color:#f92672>=</span> Field(default_factory<span style=color:#f92672>=</span>datetime<span style=color:#f92672>.</span>now)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Page3Response</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;전원 의뢰서 통합 응답&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patient_info: Page3PatientInfo
</span></span><span style=display:flex><span>    hospital_info: HospitalInfo
</span></span><span style=display:flex><span>    clinical_data: ClinicalData
</span></span><span style=display:flex><span>    ai_report: AIReport
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># === AI 보고서 (로컬 LLM) 관련 ===</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AIReportRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;로컬 LLM 전원 의뢰서 요청&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    patientName: str
</span></span><span style=display:flex><span>    patientId: str
</span></span><span style=display:flex><span>    severity: int
</span></span><span style=display:flex><span>    testTime: str
</span></span><span style=display:flex><span>    hospitalName: str
</span></span><span style=display:flex><span>    hospitalAddress: str
</span></span><span style=display:flex><span>    hospitalPhone: str
</span></span><span style=display:flex><span>    medicalData: dict
</span></span></code></pre></div><h3 id=64-api-모니터링-미들웨어>6.4 API 모니터링 미들웨어
<a class=anchor href=#64-api-%eb%aa%a8%eb%8b%88%ed%84%b0%eb%a7%81-%eb%af%b8%eb%93%a4%ec%9b%a8%ec%96%b4>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># HTTP 요청 모니터링 미들웨어</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log_requests</span>(request: Request, call_next):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    모든 API 요청의 성능 로깅
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 요청 경로, 메서드, 상태 코드
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 처리 시간 (밀리초)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - logs/api_monitoring.log에 JSON 형식으로 기록
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> call_next(request)
</span></span><span style=display:flex><span>    process_time <span style=color:#f92672>=</span> (time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    api_logger<span style=color:#f92672>.</span>info(json<span style=color:#f92672>.</span>dumps({
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: request<span style=color:#f92672>.</span>url<span style=color:#f92672>.</span>path,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;method&#34;</span>: request<span style=color:#f92672>.</span>method,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status_code&#34;</span>: response<span style=color:#f92672>.</span>status_code,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;process_time_ms&#34;</span>: round(process_time, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>    }))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 미들웨어 등록</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>.</span>middleware(<span style=color:#e6db74>&#34;http&#34;</span>)(log_requests)
</span></span></code></pre></div><hr><h2 id=7-ml-파이프라인-통합>7. ML 파이프라인 통합
<a class=anchor href=#7-ml-%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8-%ed%86%b5%ed%95%a9>#</a></h2><h3 id=71-lstm-모델-학습-파이프라인>7.1 LSTM 모델 학습 파이프라인
<a class=anchor href=#71-lstm-%eb%aa%a8%eb%8d%b8-%ed%95%99%ec%8a%b5-%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8>#</a></h3><p>데이터베이스에서 임상 데이터를 조회하여 LSTM 모델을 학습시키는 통합 파이프라인입니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - train_lstm_model()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>train_lstm_model</span>(session: AsyncSession):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LSTM 모델 학습 (DB → Pandas → TensorFlow)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    1. clinical_data 전체 조회 (SQL → Pandas DataFrame)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    2. 환자별 10시점 x 9개 feature 데이터 정형화
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    3. StandardScaler 정규화
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    4. LSTM 모델 학습 (100 epochs)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    5. 평가 메트릭 계산 (MSE, MAE, R2)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    6. 모델 + 스케일러 저장
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> sklearn.preprocessing <span style=color:#f92672>import</span> StandardScaler
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> tensorflow.keras.layers <span style=color:#f92672>import</span> LSTM, Dense, Dropout
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> tensorflow.keras.models <span style=color:#f92672>import</span> Sequential
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> tensorflow.keras.optimizers <span style=color:#f92672>import</span> Adam
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. DB에서 전체 임상 데이터 조회</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> get_all_clinical_data(session)
</span></span><span style=display:flex><span>    clinical_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(result[<span style=color:#e6db74>&#34;data&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. Feature 정의</span>
</span></span><span style=display:flex><span>    feature_columns <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;creatinine&#34;</span>, <span style=color:#e6db74>&#34;hemoglobin&#34;</span>, <span style=color:#e6db74>&#34;ldh&#34;</span>, <span style=color:#e6db74>&#34;lymphocytes&#34;</span>, <span style=color:#e6db74>&#34;neutrophils&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;platelet_count&#34;</span>, <span style=color:#e6db74>&#34;wbc_count&#34;</span>, <span style=color:#e6db74>&#34;hs_crp&#34;</span>, <span style=color:#e6db74>&#34;d_dimer&#34;</span>, <span style=color:#e6db74>&#34;news_score&#34;</span>,
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. 환자별 데이터 구성 (10환자 x 10시점 x 10features)</span>
</span></span><span style=display:flex><span>    patients_data <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> patient_id <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>11</span>):
</span></span><span style=display:flex><span>        patient_df <span style=color:#f92672>=</span> clinical_df[clinical_df[<span style=color:#e6db74>&#34;patient_id&#34;</span>] <span style=color:#f92672>==</span> patient_id]<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>        patient_df <span style=color:#f92672>=</span> patient_df<span style=color:#f92672>.</span>sort_values(<span style=color:#e6db74>&#34;timepoint&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(patient_df) <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>:
</span></span><span style=display:flex><span>            patients_data<span style=color:#f92672>.</span>append(patient_df[feature_columns]<span style=color:#f92672>.</span>values)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    X <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>array(patients_data)       <span style=color:#75715e># (10, 10, 10)</span>
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> X[:, :, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]                   <span style=color:#75715e># news_score (target)</span>
</span></span><span style=display:flex><span>    X_features <span style=color:#f92672>=</span> X[:, :, :<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]         <span style=color:#75715e># 9개 feature (input)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4. 정규화</span>
</span></span><span style=display:flex><span>    scaler_X <span style=color:#f92672>=</span> StandardScaler()
</span></span><span style=display:flex><span>    scaler_y <span style=color:#f92672>=</span> StandardScaler()
</span></span><span style=display:flex><span>    X_scaled <span style=color:#f92672>=</span> scaler_X<span style=color:#f92672>.</span>fit_transform(
</span></span><span style=display:flex><span>        X_features<span style=color:#f92672>.</span>reshape(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, X_features<span style=color:#f92672>.</span>shape[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    )<span style=color:#f92672>.</span>reshape(X_features<span style=color:#f92672>.</span>shape)
</span></span><span style=display:flex><span>    y_scaled <span style=color:#f92672>=</span> scaler_y<span style=color:#f92672>.</span>fit_transform(y<span style=color:#f92672>.</span>reshape(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>))<span style=color:#f92672>.</span>reshape(y<span style=color:#f92672>.</span>shape)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 5. LSTM 모델 구성</span>
</span></span><span style=display:flex><span>    model <span style=color:#f92672>=</span> Sequential([
</span></span><span style=display:flex><span>        LSTM(<span style=color:#ae81ff>50</span>, return_sequences<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, input_shape<span style=color:#f92672>=</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>9</span>)),
</span></span><span style=display:flex><span>        Dropout(<span style=color:#ae81ff>0.2</span>),
</span></span><span style=display:flex><span>        LSTM(<span style=color:#ae81ff>50</span>, return_sequences<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        Dropout(<span style=color:#ae81ff>0.2</span>),
</span></span><span style=display:flex><span>        LSTM(<span style=color:#ae81ff>25</span>, return_sequences<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>),
</span></span><span style=display:flex><span>        Dropout(<span style=color:#ae81ff>0.2</span>),
</span></span><span style=display:flex><span>        Dense(<span style=color:#ae81ff>25</span>, activation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;relu&#34;</span>),
</span></span><span style=display:flex><span>        Dense(<span style=color:#ae81ff>10</span>, activation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;linear&#34;</span>),
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    model<span style=color:#f92672>.</span>compile(optimizer<span style=color:#f92672>=</span>Adam(learning_rate<span style=color:#f92672>=</span><span style=color:#ae81ff>0.001</span>), loss<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mse&#34;</span>, metrics<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;mae&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 6. 학습</span>
</span></span><span style=display:flex><span>    model<span style=color:#f92672>.</span>fit(X_scaled, y_scaled, epochs<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>, batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, validation_split<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 7. 모델 저장</span>
</span></span><span style=display:flex><span>    ts <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y%m</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>_%H%M%S&#34;</span>)
</span></span><span style=display:flex><span>    model<span style=color:#f92672>.</span>save(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;saved_models/lstm_model_</span><span style=color:#e6db74>{</span>ts<span style=color:#e6db74>}</span><span style=color:#e6db74>.h5&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;saved_models/scalers_</span><span style=color:#e6db74>{</span>ts<span style=color:#e6db74>}</span><span style=color:#e6db74>.pkl&#34;</span>, <span style=color:#e6db74>&#34;wb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        pickle<span style=color:#f92672>.</span>dump({<span style=color:#e6db74>&#34;scaler_X&#34;</span>: scaler_X, <span style=color:#e6db74>&#34;scaler_y&#34;</span>: scaler_y}, f)
</span></span></code></pre></div><h3 id=72-데이터-파이프라인-구조>7.2 데이터 파이프라인 구조
<a class=anchor href=#72-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8-%ea%b5%ac%ec%a1%b0>#</a></h3><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────┐
│                 DB → ML Training Pipeline                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  PostgreSQL                                                          │
│  └── clinical_data (100 records)                                     │
│       │                                                              │
│       ▼                                                              │
│  SQLAlchemy AsyncSession                                             │
│  └── SELECT clinical_id, patient_id, ... ORDER BY patient_id         │
│       │                                                              │
│       ▼                                                              │
│  Pandas DataFrame                                                    │
│  └── Shape: (100, 14)                                                │
│       │                                                              │
│       ▼                                                              │
│  환자별 그룹핑                                                       │
│  └── 10 patients x 10 timepoints x 9 features                       │
│       │                                                              │
│       ▼                                                              │
│  StandardScaler 정규화                                               │
│  └── X: (10, 10, 9), y: (10, 10)                                    │
│       │                                                              │
│       ▼                                                              │
│  LSTM Model                                                          │
│  ├── Layer 1: LSTM(50, return_sequences=True)                        │
│  ├── Layer 2: Dropout(0.2)                                           │
│  ├── Layer 3: LSTM(50, return_sequences=True)                        │
│  ├── Layer 4: Dropout(0.2)                                           │
│  ├── Layer 5: LSTM(25, return_sequences=False)                       │
│  ├── Layer 6: Dropout(0.2)                                           │
│  ├── Layer 7: Dense(25, relu)                                        │
│  └── Layer 8: Dense(10, linear)                                      │
│       │                                                              │
│       ▼                                                              │
│  저장: saved_models/                                                 │
│  ├── lstm_model_{timestamp}.h5                                       │
│  ├── scalers_{timestamp}.pkl                                         │
│  └── model_info_{timestamp}.json                                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=73-주기적-학습-스케줄러>7.3 주기적 학습 스케줄러
<a class=anchor href=#73-%ec%a3%bc%ea%b8%b0%ec%a0%81-%ed%95%99%ec%8a%b5-%ec%8a%a4%ec%bc%80%ec%a4%84%eb%9f%ac>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># main.py - 8시간 간격 LSTM 재학습 스케줄러</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> schedule
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_session_factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>_main_loop <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>scheduled_train_lstm</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;스케줄된 LSTM 학습 실행&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _session_factory <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> _session_factory() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> train_lstm_model(session)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;스케줄된 LSTM 학습 완료: </span><span style=color:#e6db74>{</span>result[<span style=color:#e6db74>&#39;saved_files&#39;</span>][<span style=color:#e6db74>&#39;model_path&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;스케줄된 LSTM 학습 실패: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_scheduled_training</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;asyncio 이벤트 루프에 학습 코루틴 제출&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _main_loop:
</span></span><span style=display:flex><span>        asyncio<span style=color:#f92672>.</span>run_coroutine_threadsafe(scheduled_train_lstm(), _main_loop)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start_training_scheduler</span>(factory, loop):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    학습 스케줄러 초기화
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 임상 데이터가 8시간 간격이므로 동일 주기로 재학습
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 별도 데몬 스레드에서 schedule 라이브러리 실행
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - asyncio 이벤트 루프와 안전한 코루틴 통신
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> _session_factory, _main_loop
</span></span><span style=display:flex><span>    _session_factory <span style=color:#f92672>=</span> factory
</span></span><span style=display:flex><span>    _main_loop <span style=color:#f92672>=</span> loop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    schedule<span style=color:#f92672>.</span>every(<span style=color:#ae81ff>8</span>)<span style=color:#f92672>.</span>hours<span style=color:#f92672>.</span>do(run_scheduled_training)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(
</span></span><span style=display:flex><span>        target<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span>: [
</span></span><span style=display:flex><span>            schedule<span style=color:#f92672>.</span>run_pending() <span style=color:#f92672>or</span> time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> iter(int, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        daemon<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;LSTM 모델 학습 스케줄러가 시작되었습니다 (8시간 간격).&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> t
</span></span></code></pre></div><h3 id=74-llm-전원-의뢰서-생성>7.4 LLM 전원 의뢰서 생성
<a class=anchor href=#74-llm-%ec%a0%84%ec%9b%90-%ec%9d%98%eb%a2%b0%ec%84%9c-%ec%83%9d%ec%84%b1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># GPT-4 기반 전원 의뢰서 생성</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_medical_report</span>(
</span></span><span style=display:flex><span>    patient_info: Page3PatientInfo,
</span></span><span style=display:flex><span>    hospital_info: HospitalInfo,
</span></span><span style=display:flex><span>    clinical_data: ClinicalData,
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    GPT-4로 전문 환자 전원 의뢰서 생성
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    포함 항목:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    1. 환자 기본 정보
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    2. 이송 의료기관 정보
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    3. 현재 상태 및 검사 소견
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    4. 전원 사유 및 임상적 판단
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    5. 특이사항 및 주의사항
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    llm <span style=color:#f92672>=</span> ChatOpenAI(model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;gpt-4&#34;</span>, temperature<span style=color:#f92672>=</span><span style=color:#ae81ff>0.3</span>, max_tokens<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    prompt_template <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>다음 정보를 바탕으로 의료기관 간 환자 전원 의뢰서를 공식 문서 형식으로 작성해주세요.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>【환자 정보】
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 환자명: </span><span style=color:#e6db74>{</span>patient_info<span style=color:#f92672>.</span>patient_name<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 환자 ID: </span><span style=color:#e6db74>{</span>patient_info<span style=color:#f92672>.</span>patient_id<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 중증도: </span><span style=color:#e6db74>{</span>patient_info<span style=color:#f92672>.</span>severity<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>【이송 예정 의료기관】
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 의료기관명: </span><span style=color:#e6db74>{</span>hospital_info<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 주소: </span><span style=color:#e6db74>{</span>hospital_info<span style=color:#f92672>.</span>address<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 연락처: </span><span style=color:#e6db74>{</span>hospital_info<span style=color:#f92672>.</span>phone<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 이송 거리: </span><span style=color:#e6db74>{</span>hospital_info<span style=color:#f92672>.</span>distance<span style=color:#e6db74>}</span><span style=color:#e6db74>km
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>【최신 검사 수치】
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- D-Dimer: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>d_dimer <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74> ng/mL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- LDH: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>ldh <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74> U/L
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Creatinine: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>creatinine <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74> mg/dL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Hemoglobin: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>hemoglobin <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74> g/dL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Lymphocytes: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>lymphocytes <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Neutrophils: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>neutrophils <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- hs-CRP: </span><span style=color:#e6db74>{</span>clinical_data<span style=color:#f92672>.</span>hs_crp <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;N/A&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74> mg/L
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>전문적인 환자 전원 의뢰서를 작성해주세요.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> llm<span style=color:#f92672>.</span>invoke([HumanMessage(content<span style=color:#f92672>=</span>prompt_template)])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>content<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;보고서 생성 중 오류가 발생했습니다: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><hr><h2 id=8-성능-최적화>8. 성능 최적화
<a class=anchor href=#8-%ec%84%b1%eb%8a%a5-%ec%b5%9c%ec%a0%81%ed%99%94>#</a></h2><h3 id=81-인덱스-전략>8.1 인덱스 전략
<a class=anchor href=#81-%ec%9d%b8%eb%8d%b1%ec%8a%a4-%ec%a0%84%eb%9e%b5>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 기본 키 인덱스 (자동 생성)
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- PRIMARY KEY: clinical_data(clinical_id), patient(patient_id), report(report_id)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 외래 키 인덱스 (쿼리 최적화)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_clinical_patient_id <span style=color:#66d9ef>ON</span> clinical_data(patient_id);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_report_patient_id <span style=color:#66d9ef>ON</span> report(patient_id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 시간 범위 조회 인덱스
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_clinical_timestamp <span style=color:#66d9ef>ON</span> clinical_data(<span style=color:#e6db74>&#34;timestamp&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 복합 인덱스 (환자 + 시간) - LATERAL JOIN 최적화
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_clinical_patient_timestamp
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ON</span> clinical_data(patient_id, <span style=color:#e6db74>&#34;timestamp&#34;</span> <span style=color:#66d9ef>DESC</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 시점 조회 인덱스
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_clinical_timepoint <span style=color:#66d9ef>ON</span> clinical_data(timepoint);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- DATE_TRUNC 최적화를 위한 함수 인덱스
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_clinical_timestamp_hour
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ON</span> clinical_data(DATE_TRUNC(<span style=color:#e6db74>&#39;hour&#39;</span>, <span style=color:#e6db74>&#34;timestamp&#34;</span>));
</span></span></code></pre></div><h3 id=82-쿼리-최적화>8.2 쿼리 최적화
<a class=anchor href=#82-%ec%bf%bc%eb%a6%ac-%ec%b5%9c%ec%a0%81%ed%99%94>#</a></h3><h4 id=lateral-join-최적화>LATERAL JOIN 최적화
<a class=anchor href=#lateral-join-%ec%b5%9c%ec%a0%81%ed%99%94>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before: 환자별 개별 조회 (N+1 문제)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> patient <span style=color:#f92672>in</span> patients:
</span></span><span style=display:flex><span>    current <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>        text(<span style=color:#e6db74>&#34;SELECT * FROM clinical_data WHERE patient_id = :id ORDER BY timestamp DESC LIMIT 1&#34;</span>),
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;id&#34;</span>: patient<span style=color:#f92672>.</span>patient_id}
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    predicted <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>        text(<span style=color:#e6db74>&#34;SELECT news_score FROM clinical_data WHERE patient_id = :id AND timestamp &gt; :ts LIMIT 1&#34;</span>),
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;id&#34;</span>: patient<span style=color:#f92672>.</span>patient_id, <span style=color:#e6db74>&#34;ts&#34;</span>: current_ts}
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After: 단일 LATERAL JOIN 쿼리로 통합</span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    SELECT p.patient_name, p.patient_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>           c_cur.news_score_label AS cur_news,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>           c_next.news_score AS cur_predicted
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FROM public.patient p
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    JOIN (...) c_cur ON p.patient_id = c_cur.patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LEFT JOIN LATERAL (...) c_next ON TRUE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ORDER BY p.patient_id;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 1회 쿼리로 10명 환자의 현재/예측 NEWS Score 동시 조회</span>
</span></span></code></pre></div><h4 id=max--group-by-서브쿼리-최적화>MAX + GROUP BY 서브쿼리 최적화
<a class=anchor href=#max--group-by-%ec%84%9c%eb%b8%8c%ec%bf%bc%eb%a6%ac-%ec%b5%9c%ec%a0%81%ed%99%94>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before: 전체 스캔 후 Python에서 필터링</span>
</span></span><span style=display:flex><span>all_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>    text(<span style=color:#e6db74>&#34;SELECT * FROM clinical_data WHERE timestamp BETWEEN :s AND :e&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Python에서 환자별 최신 레코드 선택 (비효율)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After: DB 레벨에서 환자별 최신 레코드 선택</span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    SELECT c1.*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FROM clinical_data c1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    JOIN (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT patient_id, MAX(timestamp) AS max_ts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM clinical_data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE timestamp BETWEEN :start_time AND :end_time
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        GROUP BY patient_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ) c2 ON c1.patient_id = c2.patient_id AND c1.timestamp = c2.max_ts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span></code></pre></div><h3 id=83-연결-관리>8.3 연결 관리
<a class=anchor href=#83-%ec%97%b0%ea%b2%b0-%ea%b4%80%eb%a6%ac>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 비동기 엔진 설정</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>engine <span style=color:#f92672>=</span> create_async_engine(
</span></span><span style=display:flex><span>    DATABASE_URL,
</span></span><span style=display:flex><span>    echo<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,            <span style=color:#75715e># SQL 로깅 비활성화</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># asyncpg 기본 연결 풀 설정 사용</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># pool_size=5 (기본값), max_overflow=10 (기본값)</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 세션 팩토리</span>
</span></span><span style=display:flex><span>async_session <span style=color:#f92672>=</span> async_sessionmaker(
</span></span><span style=display:flex><span>    engine,
</span></span><span style=display:flex><span>    class_<span style=color:#f92672>=</span>AsyncSession,
</span></span><span style=display:flex><span>    expire_on_commit<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,  <span style=color:#75715e># 커밋 후 객체 재로딩 방지</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=84-타임존-처리-최적화>8.4 타임존 처리 최적화
<a class=anchor href=#84-%ed%83%80%ec%9e%84%ec%a1%b4-%ec%b2%98%eb%a6%ac-%ec%b5%9c%ec%a0%81%ed%99%94>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 프론트엔드 → 백엔드 timestamp 변환 최적화</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.get</span>(<span style=color:#e6db74>&#34;/api/get-patient-info&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_patient_info</span>(timestamp: str <span style=color:#f92672>=</span> Query(<span style=color:#f92672>...</span>)):
</span></span><span style=display:flex><span>    <span style=color:#75715e># ISO 형식 + UTC offset 처리</span>
</span></span><span style=display:flex><span>    dt <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromisoformat(timestamp<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;Z&#34;</span>, <span style=color:#e6db74>&#34;+00:00&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># timezone-naive로 변환 (DB와 일관성)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> dt<span style=color:#f92672>.</span>tzinfo <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        dt <span style=color:#f92672>=</span> dt<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> get_patient_info_crud(dt, session)
</span></span></code></pre></div><h3 id=85-성능-측정-결과>8.5 성능 측정 결과
<a class=anchor href=#85-%ec%84%b1%eb%8a%a5-%ec%b8%a1%ec%a0%95-%ea%b2%b0%ea%b3%bc>#</a></h3><table><thead><tr><th>쿼리 유형</th><th>최적화 전</th><th>최적화 후</th><th>개선율</th></tr></thead><tbody><tr><td>환자별 개별 조회 (N+1)</td><td>120ms (10회)</td><td>15ms (1회)</td><td>87%</td></tr><tr><td>시간 범위 임상 데이터</td><td>45ms</td><td>8ms</td><td>82%</td></tr><tr><td>LATERAL JOIN (현재+예측)</td><td>80ms</td><td>20ms</td><td>75%</td></tr><tr><td>DATE_TRUNC 예측값 조회</td><td>35ms</td><td>10ms</td><td>71%</td></tr><tr><td>전체 임상 데이터 통계</td><td>60ms</td><td>18ms</td><td>70%</td></tr></tbody></table><hr><h2 id=9-문제-해결-사례>9. 문제 해결 사례
<a class=anchor href=#9-%eb%ac%b8%ec%a0%9c-%ed%95%b4%ea%b2%b0-%ec%82%ac%eb%a1%80>#</a></h2><h3 id=91-타임존timezone-불일치-문제>9.1 타임존(Timezone) 불일치 문제
<a class=anchor href=#91-%ed%83%80%ec%9e%84%ec%a1%b4timezone-%eb%b6%88%ec%9d%bc%ec%b9%98-%eb%ac%b8%ec%a0%9c>#</a></h3><p><strong>문제:</strong> 프론트엔드에서 전송하는 ISO 형식 timestamp에 UTC offset(<code>Z</code>, <code>+00:00</code>)이 포함되어 DB의 <code>TIMESTAMP WITHOUT TIME ZONE</code>과 비교 시 데이터 누락</p><pre tabindex=0><code>Frontend: &#34;2025-01-02T15:25:05Z&#34; (UTC offset 포함)
DB:       &#34;2025-01-02 15:25:05&#34;   (timezone-naive)

→ BETWEEN 비교 시 타입 불일치로 결과 0건
</code></pre><p><strong>원인:</strong> PostgreSQL의 <code>TIMESTAMP WITHOUT TIME ZONE</code>은 timezone 정보를 무시하지만, Python <code>datetime</code>의 <code>tzinfo</code>가 설정되면 asyncpg가 AT TIME ZONE 변환을 수행</p><p><strong>해결:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before (데이터 누락)</span>
</span></span><span style=display:flex><span>dt <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromisoformat(timestamp)
</span></span><span style=display:flex><span><span style=color:#75715e># tzinfo가 포함된 채로 쿼리 실행 → 시간대 변환 발생</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After (해결)</span>
</span></span><span style=display:flex><span>dt <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromisoformat(timestamp<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;Z&#34;</span>, <span style=color:#e6db74>&#34;+00:00&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> dt<span style=color:#f92672>.</span>tzinfo <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    dt <span style=color:#f92672>=</span> dt<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># timezone-naive로 변환 후 쿼리 실행</span>
</span></span></code></pre></div><h3 id=92-lateral-join-null-처리>9.2 LATERAL JOIN NULL 처리
<a class=anchor href=#92-lateral-join-null-%ec%b2%98%eb%a6%ac>#</a></h3><p><strong>문제:</strong> 마지막 시점(timepoint=10)의 환자에 대해 다음 예측값이 없어 NULL 반환 시 프론트엔드 오류</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># c_next.news_score가 NULL → int() 변환 실패</span>
</span></span><span style=display:flex><span>PatientInfo(cur_predicted<span style=color:#f92672>=</span>int(row[<span style=color:#ae81ff>4</span>]))  <span style=color:#75715e># TypeError: int() argument must be str or number, not &#39;NoneType&#39;</span>
</span></span></code></pre></div><p><strong>원인:</strong> LEFT JOIN LATERAL 결과가 NULL일 때 Python 타입 변환 미처리</p><p><strong>해결:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before (오류)</span>
</span></span><span style=display:flex><span>cur_predicted <span style=color:#f92672>=</span> int(row[<span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After (해결)</span>
</span></span><span style=display:flex><span>cur_predicted <span style=color:#f92672>=</span> int(row[<span style=color:#ae81ff>4</span>]) <span style=color:#66d9ef>if</span> row[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># None인 경우 기본값 0 설정</span>
</span></span></code></pre></div><h3 id=93-비동기-세션-미초기화-오류>9.3 비동기 세션 미초기화 오류
<a class=anchor href=#93-%eb%b9%84%eb%8f%99%ea%b8%b0-%ec%84%b8%ec%85%98-%eb%af%b8%ec%b4%88%ea%b8%b0%ed%99%94-%ec%98%a4%eb%a5%98>#</a></h3><p><strong>문제:</strong> 서버 시작 시 DB 연결 전에 API 요청이 들어오면 NoneType 오류</p><pre tabindex=0><code>TypeError: &#39;NoneType&#39; object is not callable
# async_session이 None인 상태에서 async_session() 호출
</code></pre><p><strong>원인:</strong> <code>engine</code>과 <code>async_session</code>이 전역 None으로 초기화되어 있고, <code>connect()</code> 호출 전 요청 수신</p><p><strong>해결:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before (오류)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_session</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> async_session() <span style=color:#66d9ef>as</span> session:  <span style=color:#75715e># async_session이 None!</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After (해결)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_session</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> async_session <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Database not connected&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> async_session() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> session
</span></span></code></pre></div><h3 id=94-lstm-학습-시-비동기동기-충돌>9.4 LSTM 학습 시 비동기/동기 충돌
<a class=anchor href=#94-lstm-%ed%95%99%ec%8a%b5-%ec%8b%9c-%eb%b9%84%eb%8f%99%ea%b8%b0%eb%8f%99%ea%b8%b0-%ec%b6%a9%eb%8f%8c>#</a></h3><p><strong>문제:</strong> 8시간 스케줄러에서 LSTM 학습 호출 시 asyncio 이벤트 루프 충돌</p><pre tabindex=0><code>RuntimeError: This event loop is already running
# schedule 라이브러리의 동기 스레드에서 async 함수 호출
</code></pre><p><strong>원인:</strong> <code>schedule</code> 라이브러리는 동기 스레드에서 실행되므로 <code>await</code>를 직접 사용할 수 없음</p><p><strong>해결:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Before (오류)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_scheduled_training</span>():
</span></span><span style=display:flex><span>    asyncio<span style=color:#f92672>.</span>run(scheduled_train_lstm())
</span></span><span style=display:flex><span>    <span style=color:#75715e># 이미 실행 중인 이벤트 루프에서 새 루프 시작 → 충돌</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># After (해결)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_scheduled_training</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _main_loop:
</span></span><span style=display:flex><span>        asyncio<span style=color:#f92672>.</span>run_coroutine_threadsafe(scheduled_train_lstm(), _main_loop)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 메인 이벤트 루프에 코루틴을 안전하게 제출</span>
</span></span></code></pre></div><h3 id=95-date_trunc-시간-비교-정밀도-문제>9.5 DATE_TRUNC 시간 비교 정밀도 문제
<a class=anchor href=#95-date_trunc-%ec%8b%9c%ea%b0%84-%eb%b9%84%ea%b5%90-%ec%a0%95%eb%b0%80%eb%8f%84-%eb%ac%b8%ec%a0%9c>#</a></h3><p><strong>문제:</strong> 동일 시간대의 임상 데이터가 분/초 차이로 인해 중복 반환</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 15:25:05와 15:30:00이 다른 시점으로 판단됨
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CAST</span>(:<span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TIMESTAMP</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>-- 동일 시간대지만 분 단위 차이로 두 레코드 반환
</span></span></span></code></pre></div><p><strong>원인:</strong> 정확한 timestamp 비교 시 분/초 차이로 예상치 못한 결과 발생</p><p><strong>해결:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Before (정밀도 과잉)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CAST</span>(:<span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TIMESTAMP</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- After (시간 단위 비교)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> DATE_TRUNC(<span style=color:#e6db74>&#39;hour&#39;</span>, <span style=color:#66d9ef>timestamp</span>) <span style=color:#f92672>&gt;</span> DATE_TRUNC(<span style=color:#e6db74>&#39;hour&#39;</span>, <span style=color:#66d9ef>CAST</span>(:<span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TIMESTAMP</span>))
</span></span><span style=display:flex><span><span style=color:#75715e>-- 시간 단위로 절사하여 비교 → 동일 시간대 내 중복 방지
</span></span></span></code></pre></div><hr><h2 id=10-프로젝트-성과>10. 프로젝트 성과
<a class=anchor href=#10-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ec%84%b1%ea%b3%bc>#</a></h2><h3 id=101-기술적-성과>10.1 기술적 성과
<a class=anchor href=#101-%ea%b8%b0%ec%88%a0%ec%a0%81-%ec%84%b1%ea%b3%bc>#</a></h3><table><thead><tr><th>항목</th><th>성과</th></tr></thead><tbody><tr><td><strong>시계열 데이터 설계</strong></td><td>환자별 10시점 x 9개 생체 지표 시계열 스키마 설계</td></tr><tr><td><strong>고급 SQL 활용</strong></td><td>LATERAL JOIN, DATE_TRUNC 기반 예측값 조회 구현</td></tr><tr><td><strong>ML 파이프라인</strong></td><td>DB → Pandas → LSTM 학습 통합 파이프라인 구축</td></tr><tr><td><strong>AI 통합</strong></td><td>GPT-4/Gemma 기반 전원 의뢰서 자동 생성</td></tr><tr><td><strong>비동기 처리</strong></td><td>전체 API 비동기화 (asyncpg + FastAPI)</td></tr><tr><td><strong>실시간 모니터링</strong></td><td>API/ML 로그 모니터링 시스템 구현</td></tr></tbody></table><h3 id=102-데이터-구조-성과>10.2 데이터 구조 성과
<a class=anchor href=#102-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ea%b5%ac%ec%a1%b0-%ec%84%b1%ea%b3%bc>#</a></h3><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────────────┐
│                    Database Statistics                               │
├─────────────────────────────────────────────────────────────────────┤
│  Tables                 : 3 (patient, clinical_data, report)        │
│  Total Columns          : 22                                        │
│  Foreign Key Relations  : 2 (ON DELETE CASCADE)                     │
│  Clinical Features      : 9 (생체 지표)                              │
│  Time Points per Patient: 10 (8-hour intervals)                     │
│  Total Clinical Records : 100 (10 patients x 10 timepoints)         │
│  Patient Records        : 10                                        │
│  Measurement Period     : 2025-01-01 ~ 2025-01-04 (약 3일)          │
└─────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id=103-api-성능-지표>10.3 API 성능 지표
<a class=anchor href=#103-api-%ec%84%b1%eb%8a%a5-%ec%a7%80%ed%91%9c>#</a></h3><table><thead><tr><th>엔드포인트</th><th>평균 응답 시간</th><th>P99 응답 시간</th></tr></thead><tbody><tr><td>GET /api/get-patient-info</td><td>20ms</td><td>55ms</td></tr><tr><td>GET /api/get-patient-data-range/{id}</td><td>8ms</td><td>25ms</td></tr><tr><td>GET /api/get-patient-predicted/{id}</td><td>10ms</td><td>30ms</td></tr><tr><td>POST /api/page3/patient-report</td><td>3.5s</td><td>8s</td></tr><tr><td>POST /api/train-model</td><td>45s</td><td>90s</td></tr><tr><td>GET /health</td><td>1ms</td><td>3ms</td></tr><tr><td>GET /db-health</td><td>5ms</td><td>15ms</td></tr></tbody></table><h3 id=104-학습-및-성장>10.4 학습 및 성장
<a class=anchor href=#104-%ed%95%99%ec%8a%b5-%eb%b0%8f-%ec%84%b1%ec%9e%a5>#</a></h3><h4 id=기술적-학습>기술적 학습
<a class=anchor href=#%ea%b8%b0%ec%88%a0%ec%a0%81-%ed%95%99%ec%8a%b5>#</a></h4><ul><li>PostgreSQL LATERAL JOIN 기반 시계열 예측 조회 패턴</li><li>DATE_TRUNC 함수를 활용한 시간 정밀도 제어</li><li>SQLAlchemy 2.0 비동기 세션 관리 및 생명주기</li><li>asyncio + threading 혼합 환경에서의 안전한 코루틴 통신</li><li>의료 데이터(NEWS Score)의 시계열 모델링</li></ul><h4 id=아키텍처-설계-역량>아키텍처 설계 역량
<a class=anchor href=#%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98-%ec%84%a4%ea%b3%84-%ec%97%ad%eb%9f%89>#</a></h4><ul><li>시계열 임상 데이터 스키마 설계 (환자 x 시점 x 지표)</li><li>DB → ML (LSTM) 학습 파이프라인 아키텍처 설계</li><li>DB 조회 → AI (GPT-4/Gemma) 의뢰서 생성 워크플로 설계</li><li>실시간 환자 모니터링을 위한 비동기 API 설계</li></ul><hr><h2 id=-부록>📎 부록
<a class=anchor href=#-%eb%b6%80%eb%a1%9d>#</a></h2><h3 id=a-실행-방법>A. 실행 방법
<a class=anchor href=#a-%ec%8b%a4%ed%96%89-%eb%b0%a9%eb%b2%95>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. PostgreSQL 14 설치 및 데이터베이스 생성</span>
</span></span><span style=display:flex><span>brew install postgresql@14
</span></span><span style=display:flex><span>createdb vitaltime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 스키마 및 초기 데이터 로드</span>
</span></span><span style=display:flex><span>psql -d vitaltime &lt; data/dump.sql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 환경 변수 설정</span>
</span></span><span style=display:flex><span>cp .env.example .env
</span></span><span style=display:flex><span><span style=color:#75715e># DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/vitaltime</span>
</span></span><span style=display:flex><span><span style=color:#75715e># OPENAI_API_KEY=sk-proj-...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 가상환경 및 의존성 설치</span>
</span></span><span style=display:flex><span>cd backend
</span></span><span style=display:flex><span>python -m venv venv
</span></span><span style=display:flex><span>source venv/bin/activate
</span></span><span style=display:flex><span>pip install -r requirements.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 백엔드 서버 실행</span>
</span></span><span style=display:flex><span>python main.py
</span></span><span style=display:flex><span><span style=color:#75715e># → http://localhost:8000</span>
</span></span></code></pre></div><h3 id=b-데이터베이스-접속>B. 데이터베이스 접속
<a class=anchor href=#b-%eb%8d%b0%ec%9d%b4%ed%84%b0%eb%b2%a0%ec%9d%b4%ec%8a%a4-%ec%a0%91%ec%86%8d>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># psql 직접 접속</span>
</span></span><span style=display:flex><span>psql -d vitaltime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 외부 클라이언트 (DBeaver, pgAdmin 등)</span>
</span></span><span style=display:flex><span>Host: localhost
</span></span><span style=display:flex><span>Port: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>Database: vitaltime
</span></span></code></pre></div><h3 id=c-유용한-sql-쿼리>C. 유용한 SQL 쿼리
<a class=anchor href=#c-%ec%9c%a0%ec%9a%a9%ed%95%9c-sql-%ec%bf%bc%eb%a6%ac>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 테이블별 레코드 수 확인
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;patient&#39;</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>table_name</span>, <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>FROM</span> patient
</span></span><span style=display:flex><span><span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;clinical_data&#39;</span>, <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> clinical_data
</span></span><span style=display:flex><span><span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;report&#39;</span>, <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> report;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 환자별 NEWS Score 추이 (시계열)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    p.patient_name,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.timepoint,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.news_score,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.news_score_label,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> clinical_data <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> patient p <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>c</span>.patient_id <span style=color:#f92672>=</span> p.patient_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> p.patient_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>  <span style=color:#75715e>-- 서지민 (중증, severity=7)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>c</span>.timepoint;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 고위험 환자 식별 (NEWS Score &gt;= 7)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    p.patient_name,
</span></span><span style=display:flex><span>    p.severity,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.news_score_label,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>timestamp</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> clinical_data <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> patient p <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>c</span>.patient_id <span style=color:#f92672>=</span> p.patient_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>c</span>.news_score_label <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>c</span>.news_score_label <span style=color:#66d9ef>DESC</span>, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>timestamp</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 환자별 평균 NEWS Score
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    p.patient_name,
</span></span><span style=display:flex><span>    p.severity,
</span></span><span style=display:flex><span>    ROUND(<span style=color:#66d9ef>AVG</span>(<span style=color:#66d9ef>c</span>.news_score)::numeric, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AS</span> avg_news,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>MAX</span>(<span style=color:#66d9ef>c</span>.news_score_label) <span style=color:#66d9ef>AS</span> max_news_label
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> clinical_data <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> patient p <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>c</span>.patient_id <span style=color:#f92672>=</span> p.patient_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> p.patient_id, p.patient_name, p.severity
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> avg_news <span style=color:#66d9ef>DESC</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 8시간 윈도우 내 데이터 확인
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    patient_id,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>AS</span> records_in_window,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>MIN</span>(<span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>AS</span> earliest,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>MAX</span>(<span style=color:#66d9ef>timestamp</span>) <span style=color:#66d9ef>AS</span> latest
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> clinical_data
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>BETWEEN</span> <span style=color:#e6db74>&#39;2025-01-02 07:00:00&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#e6db74>&#39;2025-01-02 15:00:00&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> patient_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> patient_id;
</span></span></code></pre></div><h3 id=d-의존성-목록>D. 의존성 목록
<a class=anchor href=#d-%ec%9d%98%ec%a1%b4%ec%84%b1-%eb%aa%a9%eb%a1%9d>#</a></h3><pre tabindex=0><code>fastapi==0.118.0
uvicorn==0.37.0
sqlalchemy[asyncio]==2.0.43
asyncpg==0.30.0
pydantic==2.11.9
python-dotenv==1.1.1
pandas==2.3.3
numpy==1.23.5
scikit-learn==1.7.2
tensorflow-macos==2.12.0
keras==2.12.0
torch
transformers
langchain==0.3.27
langchain-core==0.3.76
langchain-openai==0.3.33
schedule==1.2.2
httpx==0.28.1
</code></pre><h3 id=e-관련-링크>E. 관련 링크
<a class=anchor href=#e-%ea%b4%80%eb%a0%a8-%eb%a7%81%ed%81%ac>#</a></h3><ul><li>Backend API: http://localhost:8000</li><li>API Documentation: http://localhost:8000/docs</li><li>Monitoring Dashboard: monitoring.html (Frontend)</li><li>PostgreSQL: localhost:5432</li></ul><hr><p><em>이 포트폴리오는 VitalTime 프로젝트의 Database 구축 과정을 상세히 문서화한 자료입니다.</em></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#프로젝트-개요>프로젝트 개요</a></li><li><a href=#-목차>📋 목차</a></li><li><a href=#1-기술적-의사결정>1. 기술적 의사결정</a><ul><li><a href=#11-데이터베이스-선정-근거>1.1 데이터베이스 선정 근거</a></li><li><a href=#12-orm-및-드라이버-선정>1.2 ORM 및 드라이버 선정</a></li><li><a href=#13-aiml-모델-선정>1.3 AI/ML 모델 선정</a></li></ul></li><li><a href=#2-데이터베이스-아키텍처>2. 데이터베이스 아키텍처</a><ul><li><a href=#21-프로젝트-디렉토리-구조>2.1 프로젝트 디렉토리 구조</a></li><li><a href=#22-전체-시스템-아키텍처>2.2 전체 시스템 아키텍처</a></li><li><a href=#23-데이터-흐름>2.3 데이터 흐름</a></li><li><a href=#24-erd-entity-relationship-diagram>2.4 ERD (Entity Relationship Diagram)</a></li></ul></li><li><a href=#3-스키마-설계>3. 스키마 설계</a><ul><li><a href=#31-테이블-정의>3.1 테이블 정의</a></li><li><a href=#32-시계열-데이터-구조-설계>3.2 시계열 데이터 구조 설계</a></li><li><a href=#33-초기-데이터-구성>3.3 초기 데이터 구성</a></li></ul></li><li><a href=#4-시계열-데이터-처리>4. 시계열 데이터 처리</a><ul><li><a href=#41-lateral-join-기반-예측값-조회>4.1 LATERAL JOIN 기반 예측값 조회</a></li><li><a href=#42-date_trunc-기반-예측값-조회>4.2 DATE_TRUNC 기반 예측값 조회</a></li><li><a href=#43-시간-범위-임상-데이터-조회>4.3 시간 범위 임상 데이터 조회</a></li><li><a href=#44-통계-집계-pandas-연동>4.4 통계 집계 (Pandas 연동)</a></li></ul></li><li><a href=#5-orm-및-비동기-처리>5. ORM 및 비동기 처리</a><ul><li><a href=#51-sqlalchemy-비동기-설정>5.1 SQLAlchemy 비동기 설정</a></li><li><a href=#52-의존성-주입-패턴>5.2 의존성 주입 패턴</a></li><li><a href=#53-생명주기-관리>5.3 생명주기 관리</a></li><li><a href=#54-raw-sql-선택-근거>5.4 Raw SQL 선택 근거</a></li></ul></li><li><a href=#6-api-엔드포인트-설계>6. API 엔드포인트 설계</a><ul><li><a href=#61-엔드포인트-구조>6.1 엔드포인트 구조</a></li><li><a href=#62-주요-엔드포인트-구현>6.2 주요 엔드포인트 구현</a></li><li><a href=#63-pydantic-스키마>6.3 Pydantic 스키마</a></li><li><a href=#64-api-모니터링-미들웨어>6.4 API 모니터링 미들웨어</a></li></ul></li><li><a href=#7-ml-파이프라인-통합>7. ML 파이프라인 통합</a><ul><li><a href=#71-lstm-모델-학습-파이프라인>7.1 LSTM 모델 학습 파이프라인</a></li><li><a href=#72-데이터-파이프라인-구조>7.2 데이터 파이프라인 구조</a></li><li><a href=#73-주기적-학습-스케줄러>7.3 주기적 학습 스케줄러</a></li><li><a href=#74-llm-전원-의뢰서-생성>7.4 LLM 전원 의뢰서 생성</a></li></ul></li><li><a href=#8-성능-최적화>8. 성능 최적화</a><ul><li><a href=#81-인덱스-전략>8.1 인덱스 전략</a></li><li><a href=#82-쿼리-최적화>8.2 쿼리 최적화</a></li><li><a href=#83-연결-관리>8.3 연결 관리</a></li><li><a href=#84-타임존-처리-최적화>8.4 타임존 처리 최적화</a></li><li><a href=#85-성능-측정-결과>8.5 성능 측정 결과</a></li></ul></li><li><a href=#9-문제-해결-사례>9. 문제 해결 사례</a><ul><li><a href=#91-타임존timezone-불일치-문제>9.1 타임존(Timezone) 불일치 문제</a></li><li><a href=#92-lateral-join-null-처리>9.2 LATERAL JOIN NULL 처리</a></li><li><a href=#93-비동기-세션-미초기화-오류>9.3 비동기 세션 미초기화 오류</a></li><li><a href=#94-lstm-학습-시-비동기동기-충돌>9.4 LSTM 학습 시 비동기/동기 충돌</a></li><li><a href=#95-date_trunc-시간-비교-정밀도-문제>9.5 DATE_TRUNC 시간 비교 정밀도 문제</a></li></ul></li><li><a href=#10-프로젝트-성과>10. 프로젝트 성과</a><ul><li><a href=#101-기술적-성과>10.1 기술적 성과</a></li><li><a href=#102-데이터-구조-성과>10.2 데이터 구조 성과</a></li><li><a href=#103-api-성능-지표>10.3 API 성능 지표</a></li><li><a href=#104-학습-및-성장>10.4 학습 및 성장</a></li></ul></li><li><a href=#-부록>📎 부록</a><ul><li><a href=#a-실행-방법>A. 실행 방법</a></li><li><a href=#b-데이터베이스-접속>B. 데이터베이스 접속</a></li><li><a href=#c-유용한-sql-쿼리>C. 유용한 SQL 쿼리</a></li><li><a href=#d-의존성-목록>D. 의존성 목록</a></li><li><a href=#e-관련-링크>E. 관련 링크</a></li></ul></li></ul></nav></div></aside></main></body></html>