<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector)
  #

#2025-08-27


  1. 실습1
  #

실습 시나리오

사용자가 설계안 텍스트(예: description)를 입력
해당 텍스트에 대해 Python에서 AI 임베딩을 수행
임베딩 결과가 유효할 경우 design 테이블에 등록 (COMMIT)
실패하면 아무 데이터도 등록하지 않음 (ROLLBACK)
PostgreSQL + pgvector 확장 사용
Python에서 psycopg2 + 임베딩 처리


  
  #

코드
#1 SQL
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE IF NOT EXISTS design (
    id SERIAL PRIMARY KEY,
    description TEXT,
    embedding VECTOR(1536)  -- OpenAI 임베딩 차원
);

  
  #

#2 python"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/be/be35/"><meta property="og:site_name" content=" "><meta property="og:title" content="DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector)"><meta property="og:description" content="DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector) # #2025-08-27
1. 실습1 # 실습 시나리오
사용자가 설계안 텍스트(예: description)를 입력 해당 텍스트에 대해 Python에서 AI 임베딩을 수행 임베딩 결과가 유효할 경우 design 테이블에 등록 (COMMIT) 실패하면 아무 데이터도 등록하지 않음 (ROLLBACK) PostgreSQL + pgvector 확장 사용 Python에서 psycopg2 + 임베딩 처리 # 코드
#1 SQL
CREATE EXTENSION IF NOT EXISTS vector; CREATE TABLE IF NOT EXISTS design ( id SERIAL PRIMARY KEY, description TEXT, embedding VECTOR(1536) -- OpenAI 임베딩 차원 ); # #2 python"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-08-27T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-27T00:00:00+00:00"><meta property="article:tag" content="2025-08"><title>DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector) |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/be/be35/><link rel=stylesheet href=/book.min.30a7836b6a89342da3b88e7afd1036166aeced16c8de12df060ded2031837886.css integrity="sha256-MKeDa2qJNC2juI56/RA2Fmrs7RbI3hLfBg3tIDGDeIY=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.4a625a43dd2c604d63d835943169cfe323338768a6e298e5dbb8cde7a0c3501c.js integrity="sha256-SmJaQ90sYE1j2DWUMWnP4yMzh2im4pjl27jN56DDUBw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/ai/>AI/Data</a><ul></ul></li><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/be/>BE</a><ul></ul></li><li><a href=/docs/study/fe/>FE</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-실습1>1. 실습1</a></li><li></li><li></li><li></li><li></li><li></li><li><a href=#2-실습2>2. 실습2</a></li><li></li><li></li><li></li></ul></li></ul><ul><li><ul><li><a href=#3-실습2---레퍼런스-코드>3. 실습2 - 레퍼런스 코드</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=dbms-및-sql-활용-1-설계안-데이터-적재-postgresql-pgvector>DBMS 및 SQL 활용 #1 설계안 데이터 적재 (postgresql, pgvector)
<a class=anchor href=#dbms-%eb%b0%8f-sql-%ed%99%9c%ec%9a%a9-1-%ec%84%a4%ea%b3%84%ec%95%88-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%a0%81%ec%9e%ac-postgresql-pgvector>#</a></h1><p>#2025-08-27</p><hr><h3 id=1-실습1>1. 실습1
<a class=anchor href=#1-%ec%8b%a4%ec%8a%b51>#</a></h3><p><mark>실습 시나리오</mark></p><ul><li>사용자가 설계안 텍스트(예: description)를 입력</li><li>해당 텍스트에 대해 Python에서 AI 임베딩을 수행</li><li>임베딩 결과가 유효할 경우 design 테이블에 등록 (COMMIT)</li><li>실패하면 아무 데이터도 등록하지 않음 (ROLLBACK)</li><li>PostgreSQL + pgvector 확장 사용</li><li>Python에서 psycopg2 + 임베딩 처리</li></ul><h3><a class=anchor href=#>#</a></h3><p><mark>코드</mark></p><p>#1 SQL</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> EXTENSION <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> vector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> design (
</span></span><span style=display:flex><span>    id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    description TEXT,
</span></span><span style=display:flex><span>    embedding VECTOR(<span style=color:#ae81ff>1536</span>)  <span style=color:#75715e>-- OpenAI 임베딩 차원
</span></span></span><span style=display:flex><span>);
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p>#2 python</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> openai <span style=color:#f92672>import</span> OpenAI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#34;/Users/yshmbid/Documents/home/github/SQL&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. .env 파일 로드</span>
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. OpenAI Client 생성</span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> OpenAI(api_key<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;OPENAI_API_KEY&#34;</span>)) <span style=color:#75715e># .env에서 OPENAI_API_KEY 가져옴</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. PostgreSQL DB에 연결</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>    port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span>,
</span></span><span style=display:flex><span>    database<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>), <span style=color:#75715e># .env에서 PG_PASSWORD 가져옴</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>cursor <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor() <span style=color:#75715e># SQL문 실행</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 임베딩 함수</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_embedding</span>(text: str):
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>embeddings<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>        input<span style=color:#f92672>=</span>text,
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text-embedding-3-small&#34;</span>  <span style=color:#75715e># “text-embedding-3-small” 모델로 임베딩 생성</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>data[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>embedding 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. DB 삽입 함수</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>insert_design</span>(description: str):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;BEGIN;&#34;</span>)  <span style=color:#75715e># 트랜잭션 시작</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 임베딩 생성</span>
</span></span><span style=display:flex><span>        embedding <span style=color:#f92672>=</span> get_embedding(description)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># design 테이블에 삽입</span>
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;INSERT INTO design (description, embedding) VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>,
</span></span><span style=display:flex><span>            (description, embedding)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[COMMIT] 등록 성공 → </span><span style=color:#e6db74>{</span>description[:<span style=color:#ae81ff>40</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>rollback()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[ROLLBACK] 실패 → </span><span style=color:#e6db74>{</span>description[:<span style=color:#ae81ff>40</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>... 에러: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6. CSV 파일 로드 &amp; 처리</span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample_designs_500.csv&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> idx, row <span style=color:#f92672>in</span> df<span style=color:#f92672>.</span>iterrows():
</span></span><span style=display:flex><span>    desc <span style=color:#f92672>=</span> row<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;description&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pd<span style=color:#f92672>.</span>notna(desc):  <span style=color:#75715e># description이 비어있지 않을 때만 실행</span>
</span></span><span style=display:flex><span>        insert_design(desc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 7. 연결 종료</span>
</span></span><span style=display:flex><span>cursor<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p>#3 시나리오 구현</p><ul><li>사용자가 설계안 텍스트(예: description)를 입력<ul><li>insert_design(desc) -> description(desc): str</li></ul></li><li>해당 텍스트에 대해 Python에서 AI 임베딩을 수행<ul><li>get_embedding(description) -> client.embeddings.create</li></ul></li><li>임베딩 결과가 유효할 경우 design 테이블에 등록 (COMMIT)<ul><li>insert_design -> conn.commit()</li></ul></li><li>실패하면 아무 데이터도 등록하지 않음 (ROLLBACK)<ul><li>insert_design -> except Exception as e -> conn.rollback()</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><p>#4 개념</p><p>트랜젝션?</p><ul><li>DB에서 여러 SQL 실행을 하나의 작업 단위로 묶는것</li><li>여러 SQL 실행?<ul><li>BEGIN; (시작) / INSERT &mldr; (데이터 넣기) / UPDATE &mldr; (데이터 수정하기) / COMMIT; (끝내기 → 확정 반영) 등
commit?</li></ul></li><li>commit 전에는 cursor.execute를 실행해도 DB 내부 버퍼/임시 상태에만 반영됨.</li><li>commit을 하면 변경사항을 실제 DB 파일(디스크)에 확정 저장되고 다른 클라이언트(psql, pgAdmin 등)에서도 데이터를 조회 가능.</li></ul><h3><a class=anchor href=#>#</a></h3><h3 id=2-실습2>2. 실습2
<a class=anchor href=#2-%ec%8b%a4%ec%8a%b52>#</a></h3><p><mark>실습 시나리오</mark></p><ul><li>FastAPI 기반 /register_design API를 구현해보세요(Python)</li><li>Streamlit 를 통해 입력 UI를 만들고 위에 만든 FastAPI를 호출하는 방식으로 해보세요.</li></ul><p>아래의 순서대로 진행해보세요.</p><ol><li>PostgreSQL의 <code>design</code> 테이블 (생성됨)</li><li>FastAPI 서버 실행: <code>uvicorn app:app --reload</code></li><li>Streamlit 클라이언트 실행: <code>streamlit run streamlit_client.py</code></li><li>입력 → POST → 등록 확인</li></ol><h3><a class=anchor href=#>#</a></h3><p><mark>코드</mark></p><p>#1 FastAPI 서버</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> openai <span style=color:#f92672>import</span> OpenAI
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 경로 설정</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#34;/Users/yshmbid/Documents/home/github/SQL&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># .env 로드</span>
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># OpenAI 클라이언트</span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> OpenAI(api_key<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;OPENAI_API_KEY&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># DB 연결</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>    port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span>,
</span></span><span style=display:flex><span>    database<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>cursor <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># FastAPI 앱 객체 생성</span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 요청 데이터 모델 정의</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DesignRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    description: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 임베딩 함수</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_embedding</span>(text: str):
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>embeddings<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text-embedding-3-small&#34;</span>,
</span></span><span style=display:flex><span>        input<span style=color:#f92672>=</span>text
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>data[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>embedding
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/register_design&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_design</span>(req: DesignRequest):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;BEGIN;&#34;</span>)
</span></span><span style=display:flex><span>        embedding <span style=color:#f92672>=</span> get_embedding(req<span style=color:#f92672>.</span>description)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;INSERT INTO design (description, embedding) VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>,
</span></span><span style=display:flex><span>            (req<span style=color:#f92672>.</span>description, embedding)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;success&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;등록 성공&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>rollback()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;등록 실패: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>#2 Streamlit 클라이언트</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> streamlit <span style=color:#66d9ef>as</span> st
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 경로 설정</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#34;/Users/yshmbid/Documents/home/github/SQL&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>st<span style=color:#f92672>.</span>title(<span style=color:#e6db74>&#34;Design 등록 클라이언트&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 입력 박스</span>
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span> st<span style=color:#f92672>.</span>text_area(<span style=color:#e6db74>&#34;설계안 입력&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> st<span style=color:#f92672>.</span>button(<span style=color:#e6db74>&#34;등록하기&#34;</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> description<span style=color:#f92672>.</span>strip() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>:
</span></span><span style=display:flex><span>        st<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#34;설계안을 입력해주세요.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;http://127.0.0.1:8000/register_design&#34;</span>,
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;description&#34;</span>: description}
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                st<span style=color:#f92672>.</span>success(response<span style=color:#f92672>.</span>json())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                st<span style=color:#f92672>.</span>error(response<span style=color:#f92672>.</span>json())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            st<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;서버 연결 실패: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><p>#3 시나리오 구현</p><ul><li>FastAPI 서버- class DesignRequest<ul><li>Input: 사용자가 Streamlit 화면에서 입력한 설계안 텍스트를 json {&ldquo;description&rdquo;: &ldquo;텍스트&rdquo;} 로 변환</li><li>Pydantic이 json을 검증후 python 객체(req.description)로 변환</li><li>Output: req.description (문자열)</li></ul></li><li>FastAPI 서버- register_design()<ul><li>Input: req.description (문자열)</li><li>OpenAI API 호출해서 임베딩 벡터 생성 → PostgreSQL design 테이블에 (description, embedding) 저장</li><li>Output: 성공/실패 메시지 JSON 응답 ({&ldquo;status&rdquo;: &ldquo;success&rdquo;, &ldquo;message&rdquo;: &ldquo;등록 성공&rdquo;})</li></ul></li><li>Streamlit<ul><li>Input: 사용자가 입력 설계안 description 텍스트</li><li>FastAPI에 전송하면 json {&ldquo;description&rdquo;: &ldquo;텍스트&rdquo;} 로 감싸서 fastapi에 POST 요청 → description 데이터 등록</li><li>Output: 성공 실패 메시지 표시</li></ul></li></ul><h3><a class=anchor href=#>#</a></h3><p>#4 개념</p><p>class DesignRequest와 register_design()와의 호환?</p><ul><li>JSON을 파싱해서 Python 객체로 바꾸고 description이 문자열인지 검증한 뒤 통과하면 register_design()에서 DesignRequest 객체를 만들어 req에 넣는다.</li></ul><p>롤백?</p><ul><li>rollback을 안 하면 “INSERT는 됐는데 commit 전에 에러 발생” 같은 상태가 DB에 남을 수 있음.</li></ul><h1><a class=anchor href=#>#</a></h1><h3 id=3-실습2---레퍼런스-코드>3. 실습2 - 레퍼런스 코드
<a class=anchor href=#3-%ec%8b%a4%ec%8a%b52---%eb%a0%88%ed%8d%bc%eb%9f%b0%ec%8a%a4-%ec%bd%94%eb%93%9c>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># AI 설계안 등록 통합 실습 (FastAPI + Streamlit + PostgreSQL)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## FastAPI 서버 (app.py)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sentence_transformers <span style=color:#f92672>import</span> SentenceTransformer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>model <span style=color:#f92672>=</span> SentenceTransformer(<span style=color:#e6db74>&#39;all-MiniLM-L6-v2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_conn</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>        dbname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yourdb&#34;</span>, user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;youruser&#34;</span>, password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yourpass&#34;</span>, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DesignInput</span>(BaseModel):
</span></span><span style=display:flex><span>    title: str
</span></span><span style=display:flex><span>    description: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/register_design&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_design</span>(data: DesignInput):
</span></span><span style=display:flex><span>    conn <span style=color:#f92672>=</span> get_db_conn()
</span></span><span style=display:flex><span>    cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        embedding <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>encode(data<span style=color:#f92672>.</span>description)<span style=color:#f92672>.</span>tolist()
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;BEGIN;&#34;</span>)
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            INSERT INTO design (title, description, embedding)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>, (data<span style=color:#f92672>.</span>title, data<span style=color:#f92672>.</span>description, embedding))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;success&#34;</span>, <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;등록 완료&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>rollback()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;등록 실패: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>## Streamlit 클라이언트 (streamlit_client.py)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> streamlit <span style=color:#66d9ef>as</span> st
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>st<span style=color:#f92672>.</span>title(<span style=color:#e6db74>&#34;AI 설계안 등록&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>title <span style=color:#f92672>=</span> st<span style=color:#f92672>.</span>text_input(<span style=color:#e6db74>&#34;설계안 제목&#34;</span>)
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span> st<span style=color:#f92672>.</span>text_area(<span style=color:#e6db74>&#34;설계안 설명&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> st<span style=color:#f92672>.</span>button(<span style=color:#e6db74>&#34;등록 요청&#34;</span>):
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#34;http://localhost:8000/register_design&#34;</span>, json<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;title&#34;</span>: title,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;description&#34;</span>: description
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>        st<span style=color:#f92672>.</span>success(response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;message&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        st<span style=color:#f92672>.</span>error(response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;detail&#34;</span>])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-plain data-lang=plain><span style=display:flex><span>## 실행 순서 요약
</span></span><span style=display:flex><span>1. PostgreSQL에 `design` 테이블 생성
</span></span><span style=display:flex><span>2. FastAPI 서버 실행: `uvicorn app:app --reload`
</span></span><span style=display:flex><span>3. Streamlit 클라이언트 실행: `streamlit run streamlit_client.py`
</span></span><span style=display:flex><span>4. 입력 → POST → 등록 확인
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>## 테스트용 CSV &amp; SQL 삽입 예제
</span></span><span style=display:flex><span>- `sample_designs_500.csv`: 샘플 설계안 + 임베딩 포함
</span></span><span style=display:flex><span>- `insert_designs.sql`: INSERT 문 자동 생성
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**Tip**: Python에서 `psycopg2`로 임베딩 포함 대량 INSERT 가능
</span></span></code></pre></div><h1><a class=anchor href=#>#</a></h1></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-실습1>1. 실습1</a></li><li></li><li></li><li></li><li></li><li></li><li><a href=#2-실습2>2. 실습2</a></li><li></li><li></li><li></li></ul></li></ul><ul><li><ul><li><a href=#3-실습2---레퍼런스-코드>3. 실습2 - 레퍼런스 코드</a></li></ul></li></ul></nav></div></aside></main></body></html>