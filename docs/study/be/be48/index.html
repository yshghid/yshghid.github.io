<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  python #3 pgvector 유사 리뷰 검색
  #

#2025-08-20


  1. 목적
  #

고객 리뷰 문장을 벡터로 임베딩하고 PostgreSQL의 pgvector 기능을 활용하여 비슷한 리뷰를 검색하는 기능을 구현

  
  #


  2. 코드
  #

import torch
import transformers
import sentence_transformers
import sklearn
import numpy
import scipy

print(f"torch: {torch.__version__}")
print(f"transformers: {transformers.__version__}")
print(f"sentence-transformers: {sentence_transformers.__version__}")
print(f"scikit-learn: {sklearn.__version__}")
print(f"numpy: {numpy.__version__}")
print(f"scipy: {scipy.__version__}")

from dotenv import load_dotenv
import os

load_dotenv()  # 같은 폴더에 있는 .env 로드
torch: 2.2.2
transformers: 4.25.1
sentence-transformers: 2.2.2
scikit-learn: 1.3.2
numpy: 1.24.4
scipy: 1.10.1
skala conda 환경을 만들었었는데 pgvector 돌리기용으로 지피티가 추천해준 패키지 조합이 있어서 그냥 force로 저렇게 깔아줬다.'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://yshghid.github.io/docs/study/be/be48/"><meta property="og:site_name" content=" "><meta property="og:title" content="python #3 pgvector 유사 리뷰 검색"><meta property="og:description" content='python #3 pgvector 유사 리뷰 검색 # #2025-08-20
1. 목적 # 고객 리뷰 문장을 벡터로 임베딩하고 PostgreSQL의 pgvector 기능을 활용하여 비슷한 리뷰를 검색하는 기능을 구현
# 2. 코드 # import torch import transformers import sentence_transformers import sklearn import numpy import scipy print(f"torch: {torch.__version__}") print(f"transformers: {transformers.__version__}") print(f"sentence-transformers: {sentence_transformers.__version__}") print(f"scikit-learn: {sklearn.__version__}") print(f"numpy: {numpy.__version__}") print(f"scipy: {scipy.__version__}") from dotenv import load_dotenv import os load_dotenv() # 같은 폴더에 있는 .env 로드 torch: 2.2.2 transformers: 4.25.1 sentence-transformers: 2.2.2 scikit-learn: 1.3.2 numpy: 1.24.4 scipy: 1.10.1 skala conda 환경을 만들었었는데 pgvector 돌리기용으로 지피티가 추천해준 패키지 조합이 있어서 그냥 force로 저렇게 깔아줬다.'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-08-20T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-20T00:00:00+00:00"><meta property="article:tag" content="2025-08"><title>python #3 pgvector 유사 리뷰 검색 |</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://yshghid.github.io/docs/study/be/be48/><link rel=stylesheet href=/book.min.30a7836b6a89342da3b88e7afd1036166aeced16c8de12df060ded2031837886.css integrity="sha256-MKeDa2qJNC2juI56/RA2Fmrs7RbI3hLfBg3tIDGDeIY=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.b0ca9b5380cd529b88298eec173cf4411bba01c859fb6a65983d3b40fa753cb4.js integrity="sha256-sMqbU4DNUpuIKY7sFzz0QRu6AchZ+2plmD07QPp1PLQ=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo class=book-icon><span></span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><span>기록</span><ul><li><a href=/docs/hobby/book/>글</a><ul></ul></li><li><a href=/docs/hobby/daily/>일상</a><ul></ul></li></ul></li><li class=book-section-flat><span>공부</span><ul><li><a href=/docs/study/ai/>AI/Data</a><ul></ul></li><li><a href=/docs/study/bioinformatics/>Bioinformatics</a><ul></ul></li><li><a href=/docs/study/be/>BE</a><ul></ul></li><li><a href=/docs/study/fe/>FE</a><ul></ul></li><li><a href=/docs/study/career/>취업</a><ul></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>python #3 pgvector 유사 리뷰 검색</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#1-목적>1. 목적</a></li><li></li><li><a href=#2-코드>2. 코드</a></li><li></li><li><a href=#3-생각>3. 생각</a></li><li></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=python-3-pgvector-유사-리뷰-검색>python #3 pgvector 유사 리뷰 검색
<a class=anchor href=#python-3-pgvector-%ec%9c%a0%ec%82%ac-%eb%a6%ac%eb%b7%b0-%ea%b2%80%ec%83%89>#</a></h1><p>#2025-08-20</p><hr><h3 id=1-목적>1. 목적
<a class=anchor href=#1-%eb%aa%a9%ec%a0%81>#</a></h3><p>고객 리뷰 문장을 벡터로 임베딩하고 PostgreSQL의 pgvector 기능을 활용하여 비슷한 리뷰를 검색하는 기능을 구현</p><h3><a class=anchor href=#>#</a></h3><h3 id=2-코드>2. 코드
<a class=anchor href=#2-%ec%bd%94%eb%93%9c>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> torch
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> transformers
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sentence_transformers
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sklearn
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> scipy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;torch: </span><span style=color:#e6db74>{</span>torch<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;transformers: </span><span style=color:#e6db74>{</span>transformers<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;sentence-transformers: </span><span style=color:#e6db74>{</span>sentence_transformers<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;scikit-learn: </span><span style=color:#e6db74>{</span>sklearn<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;numpy: </span><span style=color:#e6db74>{</span>numpy<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;scipy: </span><span style=color:#e6db74>{</span>scipy<span style=color:#f92672>.</span>__version__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>load_dotenv()  <span style=color:#75715e># 같은 폴더에 있는 .env 로드</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-plain data-lang=plain><span style=display:flex><span>torch: 2.2.2
</span></span><span style=display:flex><span>transformers: 4.25.1
</span></span><span style=display:flex><span>sentence-transformers: 2.2.2
</span></span><span style=display:flex><span>scikit-learn: 1.3.2
</span></span><span style=display:flex><span>numpy: 1.24.4
</span></span><span style=display:flex><span>scipy: 1.10.1
</span></span></code></pre></div><p>skala conda 환경을 만들었었는데 pgvector 돌리기용으로 지피티가 추천해준 패키지 조합이 있어서 그냥 force로 저렇게 깔아줬다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> sentence_transformers <span style=color:#f92672>import</span> SentenceTransformer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1단계: 문장 임베딩</span>
</span></span><span style=display:flex><span>model <span style=color:#f92672>=</span> SentenceTransformer(<span style=color:#e6db74>&#39;paraphrase-MiniLM-L6-v2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>reviews <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;배송이 빠르고 제품도 좋아요.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;품질이 기대 이상입니다!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;생각보다 배송이 오래 걸렸어요.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;배송은 느렸지만 포장은 안전했어요.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;아주 만족스러운 제품입니다.&#34;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>embeddings <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>encode(reviews)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pgvector.psycopg2 <span style=color:#f92672>import</span> register_vector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2단계: PostgreSQL 테이블 생성</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,          
</span></span><span style=display:flex><span>    port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span>,                
</span></span><span style=display:flex><span>    database<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,    
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,       
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>),  <span style=color:#75715e># 환경변수에서 불러옴 </span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>register_vector(conn)  <span style=color:#75715e># 벡터 변환 활성화</span>
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># DB 초기화 (기존 테이블 삭제 후 재생성)</span>
</span></span><span style=display:flex><span>dim <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>get_sentence_embedding_dimension()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;CREATE EXTENSION IF NOT EXISTS vector;&#34;</span>)
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;DROP TABLE IF EXISTS review_vectors;&#34;</span>)  <span style=color:#75715e># 테이블 완전 삭제</span>
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CREATE TABLE review_vectors (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        id SERIAL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        review TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        embedding vector(</span><span style=color:#e6db74>{</span>dim<span style=color:#e6db74>}</span><span style=color:#e6db74>)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    );
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 3단계: 벡터 저장</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> review, emb <span style=color:#f92672>in</span> zip(reviews, embeddings):
</span></span><span style=display:flex><span>    cur<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;INSERT INTO review_vectors (review, embedding) VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>,
</span></span><span style=display:flex><span>        (review, np<span style=color:#f92672>.</span>array(emb, dtype<span style=color:#f92672>=</span>np<span style=color:#f92672>.</span>float32)) 
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 4단계: 유사도 검색</span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;배송이 느렸어요&#34;</span>
</span></span><span style=display:flex><span>query_vec <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>encode([query])[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>astype(np<span style=color:#f92672>.</span>float32)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>유사도 검색 결과:&#34;</span>)
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    SELECT review, embedding &lt;=&gt; </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> AS cosine_distance
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FROM review_vectors
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ORDER BY embedding &lt;=&gt; </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LIMIT 3;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>    (query_vec, query_vec)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> review, dist <span style=color:#f92672>in</span> cur<span style=color:#f92672>.</span>fetchall():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;코사인거리: </span><span style=color:#e6db74>{</span>dist<span style=color:#e6db74>:</span><span style=color:#e6db74>.4f</span><span style=color:#e6db74>}</span><span style=color:#e6db74> | 리뷰: </span><span style=color:#e6db74>{</span>review<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-plain data-lang=plain><span style=display:flex><span>유사도 검색 결과:
</span></span><span style=display:flex><span>코사인거리: 0.0783 | 리뷰: 배송이 빠르고 제품도 좋아요.
</span></span><span style=display:flex><span>코사인거리: 0.0990 | 리뷰: 배송은 느렸지만 포장은 안전했어요.
</span></span><span style=display:flex><span>코사인거리: 0.1253 | 리뷰: 생각보다 배송이 오래 걸렸어요.
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 5. 마무리</span>
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><h3><a class=anchor href=#>#</a></h3><h3 id=3-생각>3. 생각
<a class=anchor href=#3-%ec%83%9d%ea%b0%81>#</a></h3><p>PostgreSQL 테이블 생성 단계에서 나는 python으로 그냥 쏴줬는데 pgadmin 왔다갔다하면서 연동 느낌을 주는게 목적인가? 싶어서 남들 코드로 확인만 해보기.</p><ol><li>pgadmin을 들어가서 postgresql에 테이블 생성</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 리뷰 테이블 생성
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> review_vectors (
</span></span><span style=display:flex><span>    id SERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    review TEXT,
</span></span><span style=display:flex><span>    embedding VECTOR(<span style=color:#ae81ff>384</span>) <span style=color:#75715e>-- 384차원 임베딩 벡터
</span></span></span><span style=display:flex><span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 벡터 DB에 저장</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>    dbname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>    port<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5432&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 각 리뷰와 임베딩을 DB에 저장</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> review, embedding <span style=color:#f92672>in</span> zip(reviews, embeddings):
</span></span><span style=display:flex><span>    emb_list <span style=color:#f92672>=</span> embedding<span style=color:#f92672>.</span>tolist() 
</span></span><span style=display:flex><span>    cur<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;INSERT INTO review_vectors (review, embedding) VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>,
</span></span><span style=display:flex><span>        (review, emb_list)
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>요게 정석인듯. python으로 review를 embedding이라는 벡터로 만들고 -> SQL 쿼리문 작성하고 -> python으로 연결해서 python으로 리뷰 임베딩을 작성하고 -> reviews, embeddings를 db에 저장.</p><h3><a class=anchor href=#>#</a></h3><p>내코드는?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect( <span style=color:#75715e># DB 연결 객체 conn 생성</span>
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,          
</span></span><span style=display:flex><span>    port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span>,                
</span></span><span style=display:flex><span>    database<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,    
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;postgres&#34;</span>,       
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;PG_PASSWORD&#34;</span>),  <span style=color:#75715e># 환경변수에서 불러옴 </span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>DB연결을 먼저하고</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span>register_vector(conn) 
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor() <span style=color:#75715e># cursor 객체 cur 생성 (SQL을 실행하고 결과를 가져오는 역할)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dim <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>get_sentence_embedding_dimension()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;CREATE EXTENSION IF NOT EXISTS vector;&#34;</span>)
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;DROP TABLE IF EXISTS review_vectors;&#34;</span>)  <span style=color:#75715e># 테이블 완전 삭제</span>
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CREATE TABLE review_vectors (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        id SERIAL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        review TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        embedding vector(</span><span style=color:#e6db74>{</span>dim<span style=color:#e6db74>}</span><span style=color:#e6db74>)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    );
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><p>테이블 생성을 해줌.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 3단계: 벡터 저장</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> review, emb <span style=color:#f92672>in</span> zip(reviews, embeddings):
</span></span><span style=display:flex><span>    cur<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;INSERT INTO review_vectors (review, embedding) VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>,
</span></span><span style=display:flex><span>        (review, np<span style=color:#f92672>.</span>array(emb, dtype<span style=color:#f92672>=</span>np<span style=color:#f92672>.</span>float32)) 
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><p>여기는 똑같다.</p><h1><a class=anchor href=#>#</a></h1></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=yshghid/yshghid.github.io data-repo-id=R_kgDONkMkNg data-category-id=DIC_kwDONkMkNs4CloJh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-목적>1. 목적</a></li><li></li><li><a href=#2-코드>2. 코드</a></li><li></li><li><a href=#3-생각>3. 생각</a></li><li></li></ul></li></ul></nav></div></aside></main></body></html>